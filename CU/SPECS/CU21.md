# CU21 - TRAZADO DE LOTE

**Caso de Uso:** Trazado de Lote (Asignar Trazas a Unidad de Venta)
**URL Base:** `/ventas/trazado/inicio-trazado`
**Tipo:** MODIFICACION (Asignacion de trazas)
**Categoria:** Preventa (color naranja/ambar)
**Identificador Interno:** `CU21_TRAZADO_LOTE`

---

## 1. DESCRIPCION

Permite asignar numeros de traza unicos a las unidades de un lote de Unidad de Venta. El trazado es el proceso mediante el cual cada unidad individual del lote recibe un identificador unico (numero de traza) que permite su seguimiento completo a lo largo de toda la cadena de distribucion.

**Caracteristicas principales:**
- Solo para lotes de productos tipo UNIDAD_VENTA
- Requiere dictamen APROBADO (sin trazas previas)
- Genera una traza por cada unidad del lote
- Distribuye trazas secuencialmente entre bultos
- Marca el lote como `trazado = true`
- Registra movimiento MODIFICACION/TRAZADO

**Concepto de Trazabilidad ANMAT:**
La trazabilidad farmaceutica requiere que cada unidad de venta pueda ser identificada individualmente desde su produccion hasta el paciente. El numero de traza es unico por unidad, permite rastrear el origen del producto, facilita recall de productos especificos y cumple con regulaciones ANMAT.

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| DT | 5 | Permitido |
| GERENTE_GARANTIA_CALIDAD | 4 | Permitido |
| Otros | - | No permitido |

**Anotacion:** `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_GERENTE_GARANTIA_CALIDAD', 'ROLE_DT')")`

**Referencia:** `PermisosCasoUsoEnum.CU21_TRAZADO`

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. FORMULARIO                                                       |
|     GET /ventas/trazado/inicio-trazado                               |
|     Template: ventas/trazado/inicio-trazado.html                     |
|  +---------------------------------------------------------------+  |
|  |  Select2: Lote a trazar (producto, codigo, fecha ingreso)     |  |
|  |  Fecha de Trazado                                              |  |
|  |  Numero de Traza Inicial (visible si UNIDAD_VENTA)            |  |
|  |  Motivo del Cambio (min 20 chars)                              |  |
|  +---------------------------------------------------------------+  |
|  [Cancelar]                                      [Continuar] ->      |
+---------------------------------------------------------------------+
                              |
                              | POST /ventas/trazado/inicio-trazado/confirm
                              v
+---------------------------------------------------------------------+
|  2. CONFIRMACION                                                     |
|     Template: ventas/trazado/inicio-trazado-confirm.html             |
|  +---------------------------------------------------------------+  |
|  |  Vista previa de datos del lote                                |  |
|  |  Vista previa de datos del trazado                             |  |
|  |  Advertencia de confirmacion                                   |  |
|  +---------------------------------------------------------------+  |
|  [Volver a Editar]                       [Confirmar y Guardar] ->    |
+---------------------------------------------------------------------+
                              |
                              | POST /ventas/trazado/inicio-trazado
                              v
+---------------------------------------------------------------------+
|  3. EXITO                                                            |
|     GET /ventas/trazado/inicio-trazado-ok                            |
|     Template: ventas/trazado/inicio-trazado-ok.html                  |
|  +---------------------------------------------------------------+  |
|  |  Mensaje de exito                                              |  |
|  |  Detalles del lote trazado                                     |  |
|  |  Rango de trazas: inicial / final                              |  |
|  |  Tabla de movimientos                                          |  |
|  +---------------------------------------------------------------+  |
|  [Trazar Otro Lote]                            [Volver al Inicio]    |
+---------------------------------------------------------------------+
```

El flujo de 3 pasos incluye confirmacion intermedia: formulario -> confirmacion -> persistencia -> exito.

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion |
|---------|-------------|
| `templates/ventas/trazado/inicio-trazado.html` | Formulario principal |
| `templates/ventas/trazado/inicio-trazado-confirm.html` | Confirmacion |
| `templates/ventas/trazado/inicio-trazado-ok.html` | Pantalla de exito |

### Backend
| Archivo | Descripcion |
|---------|-------------|
| `controller/cu/ModifTrazadoLoteController.java` | Controlador |
| `service/cu/ModifTrazadoLoteService.java` | Servicio de negocio |
| `service/cu/AbstractCuService.java` | Clase base con validaciones comunes |

### Tests
| Archivo | Descripcion |
|---------|-------------|
| `service/cu/ModifTrazadoLoteServiceTest.java` | Tests del servicio |
| `controller/cu/ModifTrazadoLoteControllerTest.java` | Tests del controlador |

### Validadores Especializados
| Archivo | Responsabilidad |
|---------|-----------------|
| `service/cu/validator/TrazaValidator.java` | Validacion de traza inicial |
| `service/cu/validator/FechaValidator.java` | Validaciones de fechas |

### Utilidades de Creacion de Entidades
| Archivo | Uso en CU21 |
|---------|-------------|
| `utils/LoteEntityUtils.java` | `addTrazasToLote()` - Crea y distribuye trazas entre bultos |
| `utils/MovimientoModificacionUtils.java` | Factory para crear Movimiento MODIFICACION |
| `utils/MovimientoCommonUtils.java` | Formateo de motivoDelCambio con prefijo CU |

### DTOs y Entidades
| Archivo | Uso en CU21 |
|---------|-------------|
| `dto/MovimientoDTO.java` | DTO principal del formulario |
| `dto/LoteDTO.java` | DTO de respuesta |
| `entity/Lote.java` | Entidad Lote |
| `entity/Traza.java` | Entidad Traza (creadas) |
| `entity/Bulto.java` | Entidad Bulto (recibe trazas) |
| `entity/Movimiento.java` | Entidad Movimiento |

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Obligatorios

| Campo | HTML ID | Tipo | Validacion Browser | Validacion Server |
|-------|---------|------|-------------------|-------------------|
| Lote | `codigoLote` | select (Select2) | `required` | Existencia verificada, tipo UNIDAD_VENTA |
| Fecha Trazado | `fechaMovimiento` | date | `required` | `@NotNull`, >= fechaIngreso lote |
| Traza Inicial | `trazaInicial` | number | `required` (condicional) | > 0 |
| Motivo del Cambio | `motivoDelCambio` | textarea | `required`, `minlength="20"` | >= 20 caracteres (ANMAT) |

### 5.2 Campos Condicionales

| Campo | Condicion | Comportamiento |
|-------|-----------|----------------|
| `trazaInicial` | Siempre visible (lotes son UNIDAD_VENTA) | Campo obligatorio |

### 5.3 Campos Hidden

| Campo | Valor |
|-------|-------|
| `_csrf` | Token CSRF |

### 5.4 Informacion Mostrada en Select

Cada opcion del selector muestra:
- Nombre del producto
- Codigo interno del lote
- Fecha de ingreso

---

## 6. VALIDACIONES POR CAPA

El sistema implementa validacion en 3 capas: Frontend (HTML5), Bean Validation (Spring), y Validacion de Negocio (Service).

### 6.1 CAPA 1: FRONTEND (Browser - HTML5 + JavaScript)

**Ubicacion:** `templates/ventas/trazado/inicio-trazado.html`

| Campo | Atributo HTML5 | Comportamiento |
|-------|---------------|----------------|
| `codigoLote` | `required` | Bloquea submit si no seleccionado |
| `fechaMovimiento` | `required`, `type="date"` | Bloquea submit si vacio |
| `trazaInicial` | `type="number"` | Solo numeros, `required` dinamico |
| `motivoDelCambio` | `required`, `minlength="20"` | Minimo 20 caracteres |

**JavaScript Dinamico:**
- Inicializa fecha con fecha actual (timezone Argentina)
- Select2 para busqueda de lotes
- Toggle de campo trazaInicial segun tipo producto
- Enfoca primer campo con error automaticamente
- Prevencion de doble submit con spinner

---

### 6.2 CAPA 2: BEAN VALIDATION (Spring - Anotaciones Jakarta)

**Ubicacion:** `dto/MovimientoDTO.java`

| Campo | Anotaciones | Mensaje de Error |
|-------|-------------|------------------|
| fechaMovimiento | `@NotNull`, `@PastOrPresent` | "La fecha del movimiento es obligatoria" / "La fecha del movimiento no puede ser futura" |
| motivoDelCambio | `@NotNull` | "El motivo del cambio es obligatorio" |

---

### 6.3 CAPA 3: VALIDACION DE NEGOCIO (Service Layer)

**Ubicacion:** `ModifTrazadoLoteService.java` (metodo `validarTrazadoLoteInput`)

El metodo ejecuta las siguientes validaciones en orden:

| # | Validacion | Descripcion |
|---|-----------|-------------|
| 1 | BindingResult previo | Errores de Bean Validation |
| 2 | validarMotivoDelCambio | Motivo obligatorio >= 20 chars (ANMAT) |
| 3 | Lote existe | Verifica que codigoLote existe y esta activo |
| 4 | validarFechaMovimientoPosteriorIngresoLote | Fecha >= fecha ingreso lote |
| 5 | validarTrazaInicialLote | Traza inicial > 0 |

#### Detalle de Validaciones

**2. validarMotivoDelCambio** (ANMAT Disp. 4159, Anexo 6, Req. 9)

| Regla | Mensaje de Error |
|-------|------------------|
| `motivoDelCambio` no nulo y >= 20 caracteres | "El motivo del cambio es obligatorio (mínimo 20 caracteres)" |

**3. Lote existe**

| Regla | Mensaje de Error |
|-------|------------------|
| `loteRepository.findByCodigoLoteAndActivoTrue()` != null | "Lote no encontrado." |

**5. validarTrazaInicialLote** (TrazaValidator)

| Regla | Mensaje de Error |
|-------|------------------|
| `trazaInicial` != null y > 0 | "Ingrese un valor válido para la traza inicial del lote" |

**Validacion en Persistencia (metodo persistirTrazadoLote):**

| Regla | Mensaje de Error |
|-------|------------------|
| Lote existe | "El lote no existe." |
| Producto es UNIDAD_VENTA | "El lote debe ser UNIDAD_VENTA para poder trazarse" |

---

### 6.4 RESUMEN DE VALIDACIONES POR CAMPO

| Campo | Frontend | Bean Validation | Negocio |
|-------|----------|-----------------|---------|
| codigoLote | required | - | Existencia, tipo UNIDAD_VENTA |
| fechaMovimiento | required | @NotNull, @PastOrPresent | >= fechaIngreso lote |
| trazaInicial | required (dinamico), number | - | > 0 (TrazaValidator) |
| motivoDelCambio | required, minlength | @NotNull | >= 20 caracteres (ANMAT) |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

El formulario utiliza la paleta de colores **preventa** (naranja/ambar):

- **Fondo de pagina:** `bg-preventa` (gradiente naranja)
- **Tarjeta del formulario:** `form-preventa` con borde naranja
- **Botones primarios:** `btn-preventa` (gradiente naranja)
- **Section titles:** `section-title-preventa`
- **Info box:** Fondo naranja claro con borde naranja (var(--color-preventa-bg))
- **Badge:** "CU Trazado" con fondo naranja

### 7.2 Librerias Utilizadas

| Libreria | Proposito |
|----------|-----------|
| Bootstrap 5.3 | Framework CSS base, grid responsivo |
| Bootstrap Icons 1.11 | Iconografia en todo el formulario |
| jQuery 3.7 | Manipulacion DOM y eventos |
| Select2 4.1 | Dropdown con busqueda de lotes |
| common.css | Estilos compartidos del sistema |

### 7.3 Comportamiento JavaScript

1. **Inicializacion de fecha:** Establece la fecha de trazado con la fecha actual usando timezone de Argentina (`America/Argentina/Buenos_Aires`).

2. **Toggle de campo traza:** El campo `trazaContainer` se muestra/oculta segun el tipo de producto. Si es UNIDAD_VENTA, se muestra y se hace required.

3. **Configuracion de selector:** Convierte el select de Lote en componente Select2 con tema Bootstrap 5.

4. **Enfoque en error:** Automaticamente enfoca y scrollea al primer campo con clase `is-invalid`.

5. **Prevencion de doble submit:** Al enviar el formulario, el boton `btnSubmit` se deshabilita y muestra spinner "Procesando...".

### 7.4 Interacciones Dinamicas

Este CU no consume endpoints AJAX adicionales. Los datos de lotes se inyectan via Thymeleaf:

| Dato | Uso |
|------|-----|
| `loteTrazadoDtos` | Lista de lotes APROBADOS sin trazas disponibles para trazar |

---

## 8. CONTROLLER

### 8.1 Clase: ModifTrazadoLoteController

El controlador maneja el flujo de 3 pasos (formulario -> confirmacion -> persistencia) y extiende `AbstractCuController` para heredar servicios comunes.

### 8.2 Flujo de Endpoints

| Metodo | URL | Descripcion |
|--------|-----|-------------|
| GET | /ventas/trazado/cancelar | Cancela operacion, redirige a home |
| GET | /ventas/trazado/inicio-trazado | Muestra formulario |
| POST | /ventas/trazado/inicio-trazado/confirm | Valida y muestra confirmacion |
| POST | /ventas/trazado/inicio-trazado | Persiste trazado |
| GET | /ventas/trazado/inicio-trazado-ok | Pantalla exito |

**POST /inicio-trazado/confirm** - Valida y muestra confirmacion

Ejecuta validaciones. Si ok, resuelve nombres del lote para mostrar en la vista de confirmacion mediante `resolverNombresParaConfirmacion()` y retorna el template de confirmacion. Si hay errores, retorna al formulario.

**POST /inicio-trazado** - Persiste trazado

Recibe datos ya validados desde la pantalla de confirmacion. Ejecuta re-validacion, invoca `persistirTrazadoLote()` y redirige a exito.

### 8.3 Modelo en GET

- `loteTrazadoDtos`: Lotes APROBADOS sin trazas disponibles para trazar
- `movimientoDTO`: DTO del formulario (inicializado vacio)

### 8.4 Caracteristicas Destacadas

- **Flujo de 3 pasos:** Incluye confirmacion intermedia para operaciones criticas.
- **Parametro confirm:** El endpoint `/confirm` diferencia entre vista previa y persistencia.
- **Flash Attributes:** El resultado (LoteDTO) se pasa a la pantalla de exito via RedirectAttributes.
- **Filtrado de lotes:** Solo muestra lotes elegibles para trazado (ver 8.5).
- **Autorizacion:** `@PreAuthorize` en GET y POST del formulario.
- **Transaccion read-only:** El endpoint `/confirm` usa `@Transactional(readOnly = true)` para optimizar.
- **Resolucion de nombres:** `resolverNombresParaConfirmacion()` carga nombreProducto y codigoProducto para mostrar en confirmacion.

### 8.5 Pre-requisitos del Lote (Query findAllForTrazadoLote)

| Condicion | Descripcion |
|-----------|-------------|
| Activo | `activo = true` |
| Dictamen APROBADO | `dictamen = APROBADO` |
| Producto UV | `producto.tipoProducto = UNIDAD_VENTA` |
| Con stock | Al menos un bulto con `cantidadActual > 0` |
| Sin trazas | NO existe traza activa para el lote |

**Query JPQL (LoteRepository:243-260):**
```java
select l from Lote l
where l.activo = true
  and l.dictamen = APROBADO
  and l.producto.tipoProducto = UNIDAD_VENTA
  and exists (select 1 from Bulto b where b.lote = l and b.cantidadActual > 0)
  and not exists (select 1 from Traza t where t.lote = l and t.activo = true)
order by l.fechaIngreso asc, l.codigoLote asc
```

---

## 9. SERVICE

### 9.1 Clase: ModifTrazadoLoteService

El servicio contiene la logica de negocio del caso de uso. Extiende `AbstractCuService` para heredar validadores comunes y repositorios.

### 9.2 Metodo Principal: persistirTrazadoLote

Este metodo ejecuta toda la operacion en una unica transaccion. El flujo es:

1. **Establecer contexto de auditoria:** Registra "CU21_TRAZADO_LOTE" para Hibernate Envers.

2. **Obtener usuario actual:** Recupera el usuario autenticado via SecurityContextService.

3. **Log de inicio:** `[CU21] Iniciando trazado de lote - Usuario: {}, Lote: {}, TrazaInicial: {}`

4. **Cargar Lote:** Busca el lote por codigoLote. Si no existe, lanza `IllegalArgumentException` con mensaje "El lote no existe."

5. **Validar tipo producto:** Verifica que sea UNIDAD_VENTA. Si no, lanza `IllegalArgumentException` con mensaje "El lote debe ser UNIDAD_VENTA para poder trazarse"

6. **Agregar trazas:** Llama a `LoteEntityUtils.addTrazasToLote(lote, dto)`:
   - Crea trazas individuales desde `trazaInicial`
   - Distribuye secuencialmente entre bultos segun su cantidad
   - Marca `lote.trazado = true`

7. **Persistir trazas:** `trazaRepository.saveAll(lote.getTrazas())`

8. **Crear Movimiento:** Llama a `persistirMovimientoTrazadoLote()`:
   - Tipo: MODIFICACION
   - Motivo: TRAZADO
   - Dictamen inicial/final: Sin cambio (mantiene dictamen actual)
   - MotivoDelCambio: Formateado con prefijo `[CU21]`

9. **Log de completado:** `[CU21] Trazado de lote completado - Lote: {}, Trazas creadas: {}, MotivoDelCambio: {}`

10. **Persistir y retornar:** Guarda el lote y retorna el DTO.

### 9.3 Metodo: persistirMovimientoTrazadoLote

Crea el movimiento de modificacion:

- **tipo:** MODIFICACION
- **motivo:** TRAZADO
- **fecha:** fechaMovimiento del formulario
- **dictamenInicial:** Dictamen actual del lote (sin cambio)
- **dictamenFinal:** Dictamen actual del lote (sin cambio)
- **motivoDelCambio:** Formateado con prefijo `[CU21]`
- **creadoPor:** Usuario actual
- **lote:** Referencia al lote modificado
- **activo:** true

### 9.4 Distribucion de Trazas (LoteEntityUtils.addTrazasToLote)

Las trazas se crean y distribuyen asi:

1. **Validaciones:**
   - Lote debe tener unidad de medida UNIDAD
   - Cantidad actual debe ser entera (sin decimales)

2. **Creacion de trazas:**
   - Crea N trazas donde N = cantidadActual del lote
   - Cada traza tiene nroTraza = trazaInicial + indice
   - Estado: DISPONIBLE
   - Activo: true

3. **Distribucion por bulto:**
   - Recorre bultos secuencialmente
   - Asigna a cada bulto tantas trazas como unidades tiene
   - Ejemplo: Bulto1 (50 unidades) -> Trazas 1-50, Bulto2 (50 unidades) -> Trazas 51-100

---

## 10. PERSISTENCIA

### 10.1 Entidades Afectadas

| Entidad | Accion | Estado Final |
|---------|--------|--------------|
| Lote | UPDATE | trazado=true |
| Traza | INSERT (N) | estado=DISPONIBLE, activo=true |
| Movimiento | INSERT | tipo=MODIFICACION, motivo=TRAZADO |

### 10.2 Trazas Creadas

Para cada unidad del lote se crea una traza:

| Atributo | Valor |
|----------|-------|
| nroTraza | Secuencial desde traza inicial |
| lote | Referencia al lote |
| bulto | Referencia al bulto correspondiente |
| producto | Producto del lote |
| estado | DISPONIBLE |
| activo | true |
| fechaYHoraCreacion | Timestamp del DTO |

### 10.3 Movimiento Generado

| Atributo | Valor |
|----------|-------|
| tipo | MODIFICACION |
| motivo | TRAZADO |
| fecha | fechaMovimiento del formulario |
| dictamenInicial | Dictamen actual del lote |
| dictamenFinal | Dictamen actual del lote (sin cambio) |
| motivoDelCambio | `[CU21] ` + motivo del usuario |
| creadoPor | Usuario actual |
| activo | true |

### 10.4 Cascade y Soft Delete

Las trazas se guardan explicitamente con `trazaRepository.saveAll()`. El Movimiento se guarda y se agrega a la lista del Lote. Todas las entidades usan borrado logico (`@SQLDelete` con `activo = false`).

---

## 11. AUDITORIA (ANMAT)

El sistema cumple con los requerimientos de la Disposicion ANMAT 4159:

- **Hibernate Envers:** Todas las entidades (Lote, Traza, Movimiento) estan auditadas. Cada cambio genera registro en tablas `_aud`.

- **Campo motivoDelCambio:** Obligatorio minimo 20 caracteres (Requerimiento 9 del Anexo 6).

- **Contexto de caso de uso:** "CU21_TRAZADO_LOTE" se guarda en cada revision via `CustomRevisionListener`.

- **Prefijo de CU:** El motivoDelCambio incluye `[CU21]` formateado con `MovimientoCommonUtils.formatMotivoDelCambioWithCU()`.

- **Trazabilidad:** Cada unidad tiene un identificador unico (nroTraza) para seguimiento completo.

---

## 12. SEGURIDAD

- **CSRF:** Token incluido como campo oculto y en meta tags para potenciales llamadas AJAX.
- **Autorizacion:** Solo ADMIN, DT o GERENTE_GARANTIA_CALIDAD pueden acceder (`@PreAuthorize` en GET y POST).
- **XSS:** Datos renderizados con escape automatico (th:text).
- **Validacion de lote:** Solo permite trazar lotes UV aprobados con stock y sin trazas previas.
- **Validacion de tipo:** Valida en service que el lote sea UNIDAD_VENTA.

---

## 13. MANEJO DE ERRORES

Los errores se manejan en diferentes niveles:

### Service
| Error | Mensaje |
|-------|---------|
| Lote no existe | "El lote no existe." |
| No es UNIDAD_VENTA | "El lote debe ser UNIDAD_VENTA para poder trazarse" |
| Traza inicial invalida | "Ingrese un valor válido para la traza inicial del lote" |
| Motivo muy corto | "El motivo del cambio es obligatorio (mínimo 20 caracteres)" |

### Controller
- Errores de validacion se muestran junto a cada campo en el formulario.
- Re-renderiza el formulario con los datos ingresados y mensajes de error.

### Template
- Muestra errores con clase `text-danger fw-bold` debajo de cada campo.
- Campos con error reciben clase `is-invalid` o `error-field`.

### Excepciones no controladas
- Redirigen a la pagina de error global del sistema.

---

## 14. LOGGING

El service registra eventos en los siguientes puntos:

- **Inicio:** `[CU21] Iniciando trazado de lote - Usuario: {}, Lote: {}, TrazaInicial: {}`
- **Completado:** `[CU21] Trazado de lote completado - Lote: {}, Trazas creadas: {}, MotivoDelCambio: {}`

Todos los logs usan el prefijo `[CU21]` para facilitar la busqueda y correlacion.

Nivel de log: INFO (via `@Slf4j` de Lombok)

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| MEDIA | Validar unicidad de rango de trazas (evitar superposicion con lotes existentes) |
| ~~BAJA~~ | ~~Agregar pantalla de confirmacion intermedia~~ - **IMPLEMENTADO** |
| BAJA | Agregar preview de distribucion de trazas por bulto en la pantalla de confirmacion |
| BAJA | Agregar atributo `data-tipo-producto` al selector para habilitar JS dinamico |

---

## 16. ERRORES ENCONTRADOS EN REVISION

### Template inicio-trazado.html

1. **JavaScript de toggle:** El JavaScript busca `data-tipo-producto` en las opciones del selector, pero el template no incluye ese atributo en las opciones. Sin embargo, dado que la query solo retorna lotes UNIDAD_VENTA, el campo de traza siempre se mostrara correctamente. El toggle es codigo muerto pero no causa error funcional.

### Verificacion de IDs y elementos

Todos los elementos necesarios estan presentes:
- `id="trazadoForm"` - presente en el form
- `id="btnSubmit"` - presente y funcional
- `id="codigoLote"` - presente en selector
- `id="trazaInicial"` - presente en input
- `id="fechaMovimiento"` - presente en input date
- `id="motivoDelCambio"` - presente en textarea
- Prevencion de doble submit implementada correctamente

---

*Documento generado: 2025-12-14*
*Ultima actualizacion: 2025-12-27*
*Version: 1.1*
