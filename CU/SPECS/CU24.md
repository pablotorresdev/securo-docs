# CU24 - RETIRO DE MERCADO (RECALL)

**Caso de Uso:** Retiro de Mercado
**URL Base:** `/ventas/recall/retiro-mercado`
**Tipo:** ALTA + MODIFICACION (Operacion compuesta)
**Categoria:** Devoluciones (color rojo)
**Identificador Interno:** `CU24_RETIRO_MERCADO`

---

## 1. DESCRIPCION

Permite registrar el retiro de productos del mercado (recall). El sistema ejecuta una operacion compuesta de dos partes:
1. **ALTA:** Crea un nuevo lote derivado con sufijo `_R_N` para los productos retirados
2. **MODIFICACION:** Cambia el estado del lote original a RECALL y cancela analisis en curso

**Caracteristicas principales:**
- Operacion compuesta que genera dos movimientos (ALTA + MODIFICACION)
- Crea lote derivado con codigo `{codigoLoteOriginal}_R_N`
- Dos modalidades: por trazas (lotes trazados) o por cantidades (lotes no trazados)
- Requiere seleccionar el movimiento de venta original
- Transfiere trazas del lote original al lote recall (productos trazados)
- Cancela automaticamente el analisis en curso si existe sin dictamen
- Estado final del lote recall: RECALL
- Dictamen del lote recall: RETIRO_MERCADO
- Mantiene genealogia con `loteOrigen`

**Requisito:** El lote debe tener movimientos de venta previos con trazas/cantidades disponibles para recall.

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| GERENTE_GARANTIA_CALIDAD | 4 | Permitido |
| Otros | - | No permitido |

**Anotacion:** `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_GERENTE_GARANTIA_CALIDAD')")`

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. FORMULARIO                                                       |
|     GET /ventas/recall/retiro-mercado                               |
|     Template: ventas/recall/retiro-mercado.html                     |
|  +---------------------------------------------------------------+  |
|  |  Select2: Lote con ventas                                     |  |
|  |  Select2: Movimiento de venta origen (carga dinamica)         |  |
|  |  Checkboxes: Trazas vendidas (lote trazado)                   |  |
|  |  O Inputs: Cantidades por bulto (lote no trazado)             |  |
|  |  Fecha del Recall                                             |  |
|  |  Motivo del cambio (min 20 chars)                             |  |
|  +---------------------------------------------------------------+  |
|  [Cancelar]                        [Vista Previa y Confirmar] ->    |
+---------------------------------------------------------------------+
                              |
                              | POST /ventas/recall/retiro-mercado/confirm
                              v
+---------------------------------------------------------------------+
|  2. CONFIRMACION                                                     |
|     POST /ventas/recall/retiro-mercado/confirm                      |
|     Template: ventas/recall/retiro-mercado-confirm.html             |
|  +---------------------------------------------------------------+  |
|  |  Resumen de datos ingresados                                  |  |
|  |  Lista de trazas o cantidades a retirar                       |  |
|  |  Motivo del cambio                                            |  |
|  +---------------------------------------------------------------+  |
|  [Volver a Editar]                     [Confirmar y Guardar] ->     |
+---------------------------------------------------------------------+
                              |
                              | POST /ventas/recall/retiro-mercado
                              v
+---------------------------------------------------------------------+
|  3. EXITO                                                            |
|     GET /ventas/recall/retiro-mercado-ok                            |
|     Template: ventas/recall/retiro-mercado-ok.html                  |
|  +---------------------------------------------------------------+  |
|  |  Mensaje de exito                                              |  |
|  |  Seccion: Lote Recall (RETIRADO) - codigo, datos              |  |
|  |  Seccion: Lote de Venta Afectado (ACTUALIZADO)                |  |
|  |  Trazas retiradas (si aplica)                                 |  |
|  |  Tablas de movimientos del lote recall                        |  |
|  +---------------------------------------------------------------+  |
|  [Registrar Otro Retiro]                  [Volver al Inicio]        |
+---------------------------------------------------------------------+
```

El flujo de 3 pasos permite revision antes de persistir: formulario -> confirmacion -> exito.

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `templates/ventas/recall/retiro-mercado.html` | Formulario | 574 |
| `templates/ventas/recall/retiro-mercado-confirm.html` | Confirmacion | 369 |
| `templates/ventas/recall/retiro-mercado-ok.html` | Exito | 378 |

### Backend
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `controller/cu/AltaRetiroMercadoController.java` | Controlador | 128 |
| `service/cu/ModifRetiroMercadoService.java` | Servicio coordinador | 119 |
| `service/cu/AltaRecallService.java` | Servicio ALTA recall | 259 |
| `service/cu/ModificacionRecallService.java` | Servicio MODIF recall | 133 |
| `service/cu/AbstractCuService.java` | Clase base | - |

### Tests
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `test/service/cu/ModifRetiroMercadoServiceTest.java` | Test coordinador | 445 |
| `test/service/cu/AltaRecallServiceTest.java` | Test ALTA | 453 |
| `test/service/cu/ModificacionRecallServiceTest.java` | Test MODIF | 523 |

### Utilidades
| Archivo | Uso en CU24 |
|---------|-------------|
| `utils/MovimientoAltaUtils.java` | Factory para Movimiento ALTA/RETIRO_MERCADO |
| `utils/MovimientoModificacionUtils.java` | Factory para Movimiento MODIF/RETIRO_MERCADO |
| `utils/DTOUtils.java` | Conversion entidad -> DTO |

### DTOs y Entidades
| Archivo | Uso en CU24 |
|---------|-------------|
| `dto/MovimientoDTO.java` | DTO del formulario |
| `dto/LoteDTO.java` | DTO de respuesta |
| `dto/TrazaDTO.java` | DTO de trazas seleccionadas |
| `dto/DetalleMovimientoDTO.java` | DTO de cantidades por bulto |
| `entity/Lote.java` | Entidad Lote (original y derivado) |
| `entity/Bulto.java` | Entidad Bulto |
| `entity/Movimiento.java` | Entidad Movimiento |
| `entity/DetalleMovimiento.java` | Detalle por bulto |
| `entity/Traza.java` | Entidad Traza |
| `entity/Analisis.java` | Entidad Analisis (cancelacion) |

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Obligatorios

| Campo | HTML ID | Tipo | Validacion Browser | Validacion Server |
|-------|---------|------|-------------------|-------------------|
| Lote | `codigoLote` | select (Select2) | `required` | Existencia verificada |
| Mov. Venta Origen | `movVentaId` | select (Select2) | `required` | Existencia verificada |
| Fecha Recall | `fechaMovimiento` | date | `required` | `@NotNull`, `@PastOrPresent` |
| Motivo del Cambio | `motivoDelCambio` | textarea | `required`, `minlength="20"` | `@NotNull`, `@Size(min=20)` |

### 5.2 Condicionales (segun modalidad)

**Lotes Trazados:**
| Campo | HTML ID | Tipo | Validacion |
|-------|---------|------|------------|
| Trazas a retirar | `nrosTrazasRecall` | checkbox multiple | Al menos 1 seleccionada |

**Lotes No Trazados:**
| Campo | HTML ID | Tipo | Validacion |
|-------|---------|------|------------|
| Cantidades por bulto | `detalleMovimientoDTOs[n].cantidad` | number | min=0, max=maximo disponible |

### 5.3 Campos Ocultos (generados por JavaScript)

| Campo | Proposito |
|-------|-----------|
| `trazaDTOs[n].codigoLote` | Codigo del lote para cada traza |
| `trazaDTOs[n].nroBulto` | Numero de bulto de la traza |
| `trazaDTOs[n].nroTraza` | Numero de traza seleccionada |
| `detalleMovimientoDTOs[n].nroBulto` | Numero de bulto |
| `detalleMovimientoDTOs[n].unidadMedida` | UNIDAD |

---

## 6. VALIDACIONES POR CAPA

### 6.1 CAPA 1: FRONTEND (Browser - HTML5 + JavaScript)

**Ubicacion:** `retiro-mercado.html`

| Campo | Atributo HTML5 | Comportamiento |
|-------|---------------|----------------|
| `codigoLote` | `required` | Bloquea submit si no seleccionado |
| `movVentaId` | `required` | Bloquea submit si no seleccionado |
| `fechaMovimiento` | `required`, `type="date"` | Bloquea submit si vacio |
| `motivoDelCambio` | `required`, `minlength="20"` | Minimo 20 caracteres |
| `nrosTrazasRecall` | - | JS valida al menos 1 checkbox (modo trazas) |
| `detalleMovimientoDTOs[n].cantidad` | `min="0"`, `max={maximo}` | Rango valido (modo cantidades) |

**JavaScript:**
- Detecta si lote es trazado via `data-trazado` attribute
- Carga dinamica de movimientos de venta via AJAX: `/movimientos/movimientos-venta/{codigoLote}`
- Carga dinamica de trazas vendidas: `/trazas/trazas-vendidas/movimiento/{codigoMov}` (modo trazado)
- Carga dinamica de maximos por bulto: `/movimientos/recall/maximos/{codigoMov}` (modo no trazado)
- Valida al menos una traza o cantidad > 0 antes de submit
- Genera inputs hidden con estructura de DTOs

---

### 6.2 CAPA 2: BEAN VALIDATION (Spring)

**Ubicacion:** `dto/MovimientoDTO.java`

| Campo | Anotaciones | Mensaje de Error |
|-------|-------------|------------------|
| fechaMovimiento | `@NotNull`, `@PastOrPresent` | "La fecha del movimiento es obligatoria" / "La fecha del movimiento no puede ser futura" |
| motivoDelCambio | `@NotNull`, `@Size(min=20)` | "El motivo del cambio es obligatorio" / "El motivo del cambio debe tener al menos 20 caracteres" |

---

### 6.3 CAPA 3: VALIDACION DE NEGOCIO (Service Layer)

**Ubicacion:** `ModifRetiroMercadoService.java`

El metodo `validarRetiroMercadoInput()` ejecuta:

| # | Validacion | Descripcion | Mensaje de Error |
|---|-----------|-------------|------------------|
| 1 | validarMotivoDelCambio | Motivo >= 20 chars (ANMAT) | "El motivo del cambio es obligatorio (mÃ­nimo 20 caracteres)" |
| 2 | Lote existe | codigoLote existe y esta activo | "Lote no encontrado." |
| 3 | validarFechaMovimientoPosteriorIngresoLote | Fecha >= fechaIngreso | "La fecha del movimiento no puede ser anterior a la fecha de ingreso del lote" |
| 4 | validarTrazasRequeridas | Si trazado, debe tener trazas seleccionadas | "Debe seleccionar al menos una traza." |
| 5 | Movimiento origen existe | codigoMovimientoOrigen existe | "No se encontro el movimiento de venta origen" |
| 6 | validarMovimientoOrigen | Fecha movimiento valida vs origen | Validacion de fecha/cantidad |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

El formulario utiliza la paleta de colores **devoluciones** (rojo):

- **Fondo de pagina:** `bg-devoluciones`
- **Tarjeta del formulario:** `form-devoluciones`
- **Botones primarios:** `btn-devoluciones`
- **Info box:** `alert-recall` - Fondo rojo claro (#fee2e2) con borde rojo
- **Checkboxes:** Color rojo cuando seleccionados (`var(--color-devoluciones)`)

### 7.2 Librerias Utilizadas

| Libreria | Proposito |
|----------|-----------|
| Bootstrap 5.3 | Framework CSS |
| Bootstrap Icons | Iconografia |
| jQuery 3.7 | DOM y eventos |
| Select2 | Dropdown con busqueda |
| common.css | Estilos compartidos |

### 7.3 Comportamiento JavaScript

1. **Deteccion de modalidad:** Lee `data-trazado` del option seleccionado.
2. **Carga de movimientos:** GET `/movimientos/movimientos-venta/{codigoLote}`
3. **Carga de trazas (trazado):** GET `/trazas/trazas-vendidas/movimiento/{codigoMov}`
4. **Carga de maximos (no trazado):** GET `/movimientos/recall/maximos/{codigoMov}`
5. **Checkbox "Seleccionar todas":** Marca/desmarca todas las trazas.
6. **Validacion pre-submit:** Verifica al menos 1 traza o cantidad > 0.
7. **Generacion de hidden inputs:** Estructura trazaDTOs o detalleMovimientoDTOs.

### 7.3.1 Prevencion de doble submit

```javascript
document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('btnSubmit');
    if (btn) {
        btn.closest('form').addEventListener('submit', function(e) {
            if (btn.disabled) { e.preventDefault(); return; }
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
        });
    }
});
```

### 7.4 Pantalla de Confirmacion

La confirmacion muestra:
- Datos principales (lote, movimiento de venta origen, fecha)
- Tabla de trazas a retirar (modo trazado)
- Tabla de cantidades por bulto (modo no trazado)
- Motivo del cambio

Permite volver a editar conservando todos los datos via hidden inputs.

---

## 8. CONTROLLER

### 8.1 Clase: AltaRetiroMercadoController

El controlador maneja el flujo de 3 pasos y extiende `AbstractCuController`.

### 8.2 Flujo de Endpoints

**GET /retiro-mercado** - Muestra formulario

Carga en el modelo:
- Lotes disponibles para recall (`loteService.findAllForRecallDTOs()`)
- MovimientoDTO vacio

**POST /retiro-mercado/confirm** - Valida y muestra confirmacion

Ejecuta validaciones via `validarRetiroMercadoInput()`. Si ok, muestra pantalla de confirmacion.

**POST /retiro-mercado** - Persiste recall

Ejecuta validaciones. Si ok, invoca `persistirRetiroMercado()` y redirige a exito.

**GET /retiro-mercado-ok** - Muestra resultado exitoso

Recibe via FlashAttributes:
- `loteRecallDTO`: Lote nuevo creado (recall)
- `loteVentaDTO`: Lote original afectado
- `movimientoDTO`: Datos del movimiento

**GET /cancelar** - Cancela

Redirige al home.

### 8.3 Nota: @PreAuthorize solo en GET

El endpoint GET tiene `@PreAuthorize` pero los POST no. La seguridad se aplica a nivel URL via SecurityConfig usando `PermisosCasoUsoEnum.CU24_RETIRO_MERCADO`.

---

## 9. SERVICE

### 9.1 Arquitectura de Servicios

El CU24 utiliza una arquitectura de tres servicios:

```
ModifRetiroMercadoService (Coordinador)
    |
    +---> AltaRecallService (ALTA)
    |
    +---> ModificacionRecallService (MODIFICACION)
```

### 9.2 Clase: ModifRetiroMercadoService (Coordinador)

Coordina las dos operaciones del recall.

### 9.3 Metodo Principal: persistirRetiroMercado

Flujo de la operacion:

1. **Establecer contexto de auditoria:** "CU24_RETIRO_MERCADO"

2. **Obtener usuario actual**

3. **Cargar Lote original:** Por codigoLote.

4. **Cargar Movimiento de venta origen:** Por codigoMovimientoOrigen.

5. **Ejecutar ALTA Recall:**
   - Invoca `altaRecallService.procesarAltaRecall()`
   - Crea lote recall con codigo `{original}_R_N`
   - Genera movimiento ALTA/RETIRO_MERCADO

6. **Ejecutar MODIFICACION Recall:**
   - Invoca `modificacionRecallService.procesarModificacionRecall()`
   - Cambia estado del lote original a RECALL
   - Cancela analisis en curso si existe
   - Genera movimiento MODIFICACION/RETIRO_MERCADO

7. **Retornar** lista de ambos lotes (recall y original)

### 9.4 Clase: AltaRecallService

Maneja la operacion ALTA del recall.

#### Metodo: procesarAltaRecall

1. Crea lote recall via `crearLoteRecall()`
2. Crea movimiento ALTA/RETIRO_MERCADO via `createMovimientoAltaRecall()`
3. Segun modalidad:
   - **Trazado:** `altaRecallUnidadesTrazadas()` - transfiere trazas
   - **No trazado:** `altaRecallUnidadesPorBulto()` - crea detalles por cantidad
4. Persiste lote y movimiento

#### Metodo: crearLoteRecall

Crea el lote derivado con:
- Codigo: `{codigoLoteOriginal}_R_{N}` donde N es secuencial
- `loteOrigen`: Referencia al lote original
- Estado: RECALL
- Dictamen: RETIRO_MERCADO
- UnidadMedida: UNIDAD
- Copia datos del original: producto, proveedor, fabricante, pais, etc.

#### Metodo: altaRecallUnidadesTrazadas

Para lotes trazados:
1. Agrupa trazas seleccionadas por numero de bulto
2. Por cada bulto:
   - Crea bulto en lote recall
   - Crea DetalleMovimiento
   - Obtiene trazas del bulto original
   - Transfiere trazas al lote/bulto recall
   - Marca trazas como RECALL
   - Vincula trazas al detalle

#### Metodo: altaRecallUnidadesPorBulto

Para lotes no trazados:
1. Por cada bulto del lote recall:
   - Crea DetalleMovimiento con cantidad
   - Acumula cantidad total

### 9.5 Clase: ModificacionRecallService

Maneja la operacion MODIFICACION del recall.

#### Metodo: procesarModificacionRecall

1. Si lote ya esta en RECALL, retorna sin cambios
2. Crea movimiento MODIFICACION/RETIRO_MERCADO via `createMovimientoModifRecall()`
3. Segun modalidad:
   - **Trazado:** `procesarRecallTrazado()` - marca trazas DISPONIBLE como RECALL
   - **No trazado:** `procesarRecallSinTrazas()` - marca bultos con stock como RECALL
4. Cambia estado del lote a RECALL
5. Cancela analisis en curso si existe sin dictamen
6. Persiste lote y movimiento

#### Metodo: cancelarAnalisisEnCurso

Si el lote tiene un analisis sin dictamen (en curso), lo cancela:
```java
if (loteOrigenRecall.getUltimoAnalisis() != null &&
    loteOrigenRecall.getUltimoAnalisis().getDictamen() == null) {
    loteOrigenRecall.getUltimoAnalisis().setDictamen(DictamenEnum.CANCELADO);
}
```

---

## 10. PERSISTENCIA

### 10.1 Entidades Afectadas

| Entidad | Accion | Estado Final |
|---------|--------|--------------|
| Lote (nuevo recall) | INSERT | estado=RECALL, dictamen=RETIRO_MERCADO |
| Bulto (nuevos recall) | INSERT | estado=RECALL |
| Lote (original) | UPDATE | estado=RECALL |
| Bulto (originales) | UPDATE | estado=RECALL (si tienen stock o trazas disponibles) |
| Movimiento ALTA | INSERT | tipo=ALTA, motivo=RETIRO_MERCADO |
| Movimiento MODIF | INSERT | tipo=MODIFICACION, motivo=RETIRO_MERCADO |
| DetalleMovimiento | INSERT | Por cada bulto del lote recall |
| Traza | UPDATE | estado=RECALL, lote/bulto cambiados (si trazado) |
| Analisis | UPDATE | dictamen=CANCELADO (si habia analisis en curso) |

### 10.2 Movimientos Generados

**Movimiento 1 (ALTA):**
- **tipo:** ALTA
- **motivo:** RETIRO_MERCADO
- **fecha:** fechaMovimiento del formulario
- **cantidad:** Total de unidades retiradas
- **unidadMedida:** UNIDAD
- **movimientoOrigen:** Referencia al movimiento de venta original
- **motivoDelCambio:** Formateado con prefijo `[CU24]`
- **detalles:** Lista de DetalleMovimiento por bulto

**Movimiento 2 (MODIFICACION):**
- **tipo:** MODIFICACION
- **motivo:** RETIRO_MERCADO
- **fecha:** fechaMovimiento del formulario
- **dictamenInicial:** Dictamen original del lote
- **dictamenFinal:** RETIRO_MERCADO
- **movimientoOrigen:** Referencia al movimiento de venta original
- **motivoDelCambio:** Formateado con prefijo `[CU24]`

### 10.3 Codigo del Lote Derivado

El codigo del lote recall sigue el patron:
```
{codigoLoteOriginal}_R_{N}
```
Donde:
- `R` indica que es un recall (retiro de mercado)
- `N` es el numero secuencial de recalls del mismo lote (1, 2, 3...)

Ejemplo: Si lote original es `PROD001_2501001`, primer recall sera `PROD001_2501001_R_1`.

---

## 11. AUDITORIA (ANMAT)

El sistema cumple con los requerimientos de la Disposicion ANMAT 4159:

- **Hibernate Envers:** Todas las entidades auditadas.
- **Campo motivoDelCambio:** Obligatorio minimo 20 caracteres.
- **Contexto de caso de uso:** "CU24_RETIRO_MERCADO"
- **Prefijo de CU:** `[CU24]`
- **Trazabilidad:** Cada traza retirada queda registrada con estado RECALL y referencia al nuevo lote.
- **Genealogia:** `loteOrigen` mantiene la relacion con el lote original.
- **Cancelacion de analisis:** Si hay analisis en curso, se cancela automaticamente con dictamen CANCELADO.

---

## 12. SEGURIDAD

- **CSRF:** Token incluido en formularios y meta tags.
- **Autorizacion:** Solo ADMIN o GERENTE_GARANTIA_CALIDAD.
- **XSS:** Escape automatico con th:text.
- **Validacion de movimiento:** Solo movimientos de venta del lote seleccionado.
- **Validacion de cantidades:** No permite retirar mas que lo disponible.

---

## 13. MANEJO DE ERRORES

### Por Capa

| Capa | Tipo de Error | Comportamiento |
|------|--------------|----------------|
| Frontend | HTML5 validation | Bloquea submit, muestra mensaje |
| Frontend | JS validation | Muestra error si no hay trazas/cantidades |
| Bean Validation | @NotNull, @Size | Muestra junto al campo |
| Service | Lote no existe | Excepcion IllegalArgumentException |
| Service | Movimiento origen no existe | Excepcion IllegalArgumentException |
| Service | Trazas requeridas | Error en bindingResult |

---

## 14. LOGGING

Los servicios registran:

**ModifRetiroMercadoService:**
- **Inicio:** `[CU24] Iniciando retiro de mercado (recall) - Usuario: {}, Lote: {}, MovimientoOrigen: {}`
- **Completado:** `[CU24] Retiro de mercado completado - LotesAfectados: {}`

**AltaRecallService:**
- **Inicio:** `[CU24-ALTA] Iniciando creacion lote recall - Usuario: {}, LoteOrigen: {}`
- **Completado:** `[CU24-ALTA] Lote recall creado - LoteRecall: {}, Cantidad: {}`

**ModificacionRecallService:**
- **Inicio:** `[CU24-MODIF] Iniciando modificacion estado a RECALL - Usuario: {}, Lote: {}`
- **Completado:** `[CU24-MODIF] Lote modificado a RECALL - Lote: {}, Estado: {}`

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| BAJA | Agregar notificacion por email cuando se ejecuta un recall |
| BAJA | Agregar campo de "motivo del recall" con opciones predefinidas (defecto calidad, contaminacion, etc.) |
| MEDIA | Agregar @PreAuthorize a los endpoints POST del controller |

---

## 16. ERRORES ENCONTRADOS EN REVISION

### 16.1 @PreAuthorize faltante en POST
- **Archivo:** `AltaRetiroMercadoController.java` lineas 45, 56, 76
- **Problema:** Los endpoints POST `/retiro-mercado/confirm` y `/retiro-mercado` no tenian `@PreAuthorize`
- **Impacto:** Bajo - la seguridad se aplica via SecurityConfig
- **Estado:** Corregido - todos los endpoints ahora tienen `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_GERENTE_GARANTIA_CALIDAD')")`

### 16.2 Error de validacion retorna true cuando movimiento origen no existe
- **Archivo:** `ModifRetiroMercadoService.java` linea 113
- **Problema:** Cuando el movimiento origen no existe, el metodo retornaba `true` en lugar de `false`
- **Impacto:** Medio - permitia continuar con validacion aunque el movimiento no exista
- **Estado:** Corregido - ahora retorna `false` correctamente

---

*Documento generado: 2025-12-14*
*Version: 1.0*
