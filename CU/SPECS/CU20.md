# CU20 - ALTA INGRESO PRODUCCION

**Caso de Uso:** Ingreso de Stock por Produccion Interna
**URL Base:** `/produccion/alta/ingreso-produccion`
**Tipo:** ALTA (Ingreso de lote nuevo)
**Categoria:** Produccion (color violeta)
**Identificador Interno:** `CU20_INGRESO_PRODUCCION`

---

## 1. DESCRIPCION

Permite registrar el ingreso de lotes producidos internamente por Conifarma. Soporta productos de tipo SEMIELABORADO, GRANEL y UNIDAD_VENTA. El lote se crea con proveedor "Conifarma" automaticamente y estado inicial RECIBIDO. Soporta multi-bulto con unidades de medida configurables por bulto.

**Caracteristicas principales:**
- Proveedor automatico: Conifarma (fabricacion propia)
- Codigo de lote: {codigoProducto}_{sufijo} (formato AAMM####L)
- Multi-bulto: Hasta 15 bultos por lote
- Unidades flexibles: Cada bulto puede tener unidad de medida diferente (compatible)
- Orden de produccion obligatoria

**Nota:** El trazado de lotes NO se realiza en este CU. Se hace posteriormente con CU27.

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| SUPERVISOR_PLANTA | 3 | Permitido |
| Otros | - | No permitido |

**Anotacion:** `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_SUPERVISOR_PLANTA')")`

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. FORMULARIO                                                       |
|     GET /produccion/alta/ingreso-produccion                         |
|     Template: produccion/alta/ingreso-produccion.html               |
|  +---------------------------------------------------------------+  |
|  |  Fecha de ingreso, Orden de produccion                        |  |
|  |  Select2: Producto interno (SEMIELABORADO, GRANEL, UV)        |  |
|  |  Lote proveedor, Codigo lote (sufijo AAMM####L)               |  |
|  |  Cantidad total, Unidad de medida, Cantidad de bultos         |  |
|  |  [Distribucion por bulto - si > 1 bulto]                      |  |
|  |  Detalle conservacion, Motivo del cambio (min 20 chars)       |  |
|  +---------------------------------------------------------------+  |
|  [Cancelar]                     [Vista Previa y Confirmar] ->        |
+---------------------------------------------------------------------+
                              |
                              | POST /produccion/alta/ingreso-produccion/confirm
                              v
+---------------------------------------------------------------------+
|  2. CONFIRMACION                                                     |
|     POST /produccion/alta/ingreso-produccion/confirm                |
|     Template: produccion/alta/ingreso-produccion-confirm.html       |
|  +---------------------------------------------------------------+  |
|  |  Vista previa de todos los datos ingresados                   |  |
|  |  Datos principales: fecha, producto, orden, lote proveedor    |  |
|  |  Cantidades: total, bultos, distribucion por bulto            |  |
|  |  Datos adicionales: conservacion, motivo                      |  |
|  +---------------------------------------------------------------+  |
|  [Volver a Editar]                       [Confirmar y Guardar] ->    |
+---------------------------------------------------------------------+
                              |
                              | POST /produccion/alta/ingreso-produccion
                              v
+---------------------------------------------------------------------+
|  3. EXITO                                                            |
|     GET /produccion/alta/ingreso-produccion-ok (redirect)           |
|     Template: produccion/alta/ingreso-produccion-ok.html            |
|  +---------------------------------------------------------------+  |
|  |  Mensaje de exito con codigo de lote generado                 |  |
|  |  Informacion del producto, produccion, cantidades             |  |
|  |  Tabla de bultos creados                                      |  |
|  |  Tabla de movimiento generado                                 |  |
|  +---------------------------------------------------------------+  |
|  [Ingresar Otro Lote] [Ver Historial] [Volver al Inicio]            |
+---------------------------------------------------------------------+
```

El flujo de 3 pasos es consistente con los demas CUs ALTA del sistema.

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `templates/produccion/alta/ingreso-produccion.html` | Formulario principal | 489 |
| `templates/produccion/alta/ingreso-produccion-confirm.html` | Pantalla confirmacion | 336 |
| `templates/produccion/alta/ingreso-produccion-ok.html` | Pantalla exito | 459 |

### Backend
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `controller/cu/AltaIngresoProduccionController.java` | Controlador | 146 |
| `service/cu/AltaIngresoProduccionService.java` | Servicio de negocio | 153 |
| `service/cu/AbstractCuService.java` | Clase base con validaciones comunes | - |

### Utilidades de Creacion de Entidades
| Archivo | Uso en CU20 |
|---------|-------------|
| `utils/LoteEntityUtils.java` | Factory para crear Lote de produccion |
| `utils/MovimientoAltaUtils.java` | Factory para crear Movimiento ALTA |

### DTOs y Entidades
| Archivo | Uso en CU20 |
|---------|-------------|
| `dto/LoteDTO.java` | DTO principal del formulario |
| `dto/validation/AltaProduccion.java` | Grupo de validacion |
| `entity/Lote.java` | Entidad Lote |
| `entity/Bulto.java` | Entidad Bulto |
| `entity/Movimiento.java` | Entidad Movimiento |
| `entity/DetalleMovimiento.java` | Detalle por bulto |

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Obligatorios

| Campo | HTML ID | Tipo | Validacion Browser | Validacion Server |
|-------|---------|------|-------------------|-------------------|
| Fecha Ingreso | `fechaIngreso` | date | `required` | `@NotNull` |
| Orden Produccion | `ordenProduccion` | text | `required` | `@NotBlank` |
| Producto | `productoId` | select (Select2) | `required` | `@NotNull` |
| Lote Proveedor | `loteProveedor` | text | `required` | `@NotBlank` |
| Codigo Lote Sufijo | `codigoLoteSufijo` | text | `required`, `maxlength="9"`, `pattern` | Unico |
| Cantidad Inicial | `cantidadInicial` | number | `required`, `step="0.0001"` | `@Positive` |
| Unidad Medida | `unidadMedida` | select | `required` | `@NotNull` |
| Bultos Totales | `bultosTotales` | number | `required`, `min="1"`, `max="15"` | 1-15 |
| Motivo del Cambio | `motivoDelCambio` | textarea | `required`, `minlength="20"` | `@Size(min=20)` |

### 5.2 Condicionales (si bultosTotales > 1)

| Campo | HTML ID | Tipo | Validacion |
|-------|---------|------|------------|
| Cantidad Bulto N | `cantidadBulto{N}` | number | `required`, suma = cantidadInicial |
| Unidad Bulto N | `unidadSelect{N}` | select | Subunidad compatible |

### 5.3 Opcionales

| Campo | HTML ID | Tipo | Validacion |
|-------|---------|------|------------|
| Detalle Conservacion | `detalleConservacion` | textarea | Ninguna |

### 5.4 Formato del Codigo de Lote

El codigo de lote se compone de:
- **Prefijo:** Codigo del producto (automatico)
- **Sufijo:** AAMM####[L] (ingresado por usuario)
  - AA: Ano (2 digitos)
  - MM: Mes (01-12)
  - ####: Secuencial (4 digitos)
  - L: Letra opcional (A-Z)

Ejemplo: `1-05701_25010001A`

---

## 6. VALIDACIONES POR CAPA

### 6.1 CAPA 1: FRONTEND (Browser - HTML5 + JavaScript)

**Ubicacion:** `templates/produccion/alta/ingreso-produccion.html`

| Campo | Atributo HTML5 | Comportamiento |
|-------|---------------|----------------|
| `fechaIngreso` | `required`, `type="date"` | Bloquea submit si vacio |
| `ordenProduccion` | `required` | Bloquea submit si vacio |
| `productoId` | `required` | Bloquea submit si no seleccionado |
| `loteProveedor` | `required` | Bloquea submit si vacio |
| `codigoLoteSufijo` | `required`, `maxlength="9"`, `pattern` | Formato AAMM####L, mes 01-12 |
| `cantidadInicial` | `required`, `step="0.0001"` | Numeros con 4 decimales |
| `bultosTotales` | `required`, `min="1"`, `max="15"` | Entre 1 y 15 |
| `motivoDelCambio` | `required`, `minlength="20"` | Minimo 20 caracteres |

**JavaScript Dinamico:**
- Inicializa fecha con fecha actual (timezone Argentina)
- Carga unidades compatibles al seleccionar producto via AJAX
- Genera campos de bultos dinamicamente al cambiar cantidad
- Actualiza prefijo del codigo al cambiar producto
- Valida formato de mes en codigo de lote (blur)
- Auto-uppercase en codigo de lote

---

### 6.2 CAPA 2: BEAN VALIDATION (Spring - Anotaciones Jakarta)

**Ubicacion:** `dto/LoteDTO.java` con grupo `AltaProduccion.class`

| Campo | Anotaciones | Mensaje de Error |
|-------|-------------|------------------|
| fechaIngreso | `@NotNull` | "La fecha de ingreso es obligatoria" |
| productoId | `@NotNull` | "Debe seleccionar un producto" |
| ordenProduccion | `@NotBlank` | "La orden de produccion es obligatoria" |
| loteProveedor | `@NotBlank` | "El lote proveedor es obligatorio" |
| codigoLoteSufijo | `@NotBlank` | "El codigo de lote es obligatorio" |
| cantidadInicial | `@Positive` | "La cantidad debe ser mayor a cero" |
| unidadMedida | `@NotNull` | "La unidad de medida es obligatoria" |
| bultosTotales | `@Min(1)`, `@Max(15)` | "Debe tener entre 1 y 15 bultos" |
| motivoDelCambio | `@Size(min=20)` | "El motivo del cambio debe tener al menos 20 caracteres" |

---

### 6.3 CAPA 3: VALIDACION DE NEGOCIO (Service Layer)

**Ubicacion:** `AltaIngresoProduccionService.java`

El metodo `validarIngresoProduccionInput()` ejecuta:

| # | Validacion | Metodo |
|---|-----------|--------|
| 1 | validarMotivoDelCambio | Motivo >= 20 chars |
| 2 | validarCodigoLoteUnico | Codigo no duplicado |
| 3 | validarCantidadIngreso | Cantidad valida |
| 4 | validarBultos | Suma bultos = total |

#### Detalle de Validaciones

**2. validarCodigoLoteUnico**

| Regla | Mensaje de Error |
|-------|------------------|
| `{codigoProducto}_{sufijo}` no existe en BD | "El cÃ³digo de lote 'XXX' ya existe en el sistema" |

**4. validarBultos**

| Regla | Mensaje de Error |
|-------|------------------|
| Suma de cantidadesBultos = cantidadInicial | "La suma de las cantidades individuales (X SIMBOLO) no coincide con la cantidad total (Y SIMBOLO)." |
| Cada bulto tiene cantidad > 0 | "La cantidad del Bulto N debe ser mayor a 0." |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

El formulario utiliza la paleta de colores **produccion** (violeta):

- **Fondo de pagina:** `bg-produccion` (violeta claro)
- **Tarjeta del formulario:** `form-produccion` con borde violeta
- **Botones primarios:** `btn-produccion` (gradiente violeta)
- **Section titles:** `section-title-produccion`
- **Bulto cards:** Tarjetas con numero en circulo violeta

### 7.2 Librerias Utilizadas

| Libreria | Proposito |
|----------|-----------|
| Bootstrap 5.3 | Framework CSS base |
| Bootstrap Icons | Iconografia |
| jQuery 3.7 | DOM y eventos |
| Select2 | Dropdown con busqueda |
| common.css | Estilos compartidos |

### 7.3 Comportamiento JavaScript

1. **Inicializacion de fecha:** Fecha actual timezone Argentina.

2. **Select2 para producto:** Busqueda por nombre, tipo y codigo.

3. **Carga de unidades:** Al seleccionar producto, consulta `/enums/unidades-compatibles` para cargar unidades validas.

4. **Generacion de bultos:** Al cambiar cantidad de bultos, genera campos dinamicamente. Consulta `/enums/subunidades` para cada selector de unidad.

5. **Actualizacion de prefijo:** El prefijo del codigo de lote se actualiza al cambiar producto.

6. **Validacion de mes:** Al salir del campo sufijo, valida que el mes (posiciones 2-3) este entre 01-12.

7. **Auto-uppercase:** El sufijo se convierte a mayusculas automaticamente.

8. **Prevencion doble submit:** Boton `btnSubmit` se deshabilita al enviar.

### 7.4 Interacciones AJAX

| Endpoint | Uso |
|----------|-----|
| `GET /enums/unidades-compatibles?unidad={base}` | Unidades compatibles para el total |
| `GET /enums/subunidades?unidad={base}` | Subunidades para cada bulto |

---

## 8. CONTROLLER

### 8.1 Clase: AltaIngresoProduccionController

El controlador maneja el flujo de 3 pasos y extiende `AbstractCuController`.

### 8.2 Flujo de Endpoints

**GET /ingreso-produccion** - Muestra formulario

Carga en el modelo:
- Productos internos (`productoService.getProductosInternos()`)
- LoteDTO vacio con listas inicializadas

**POST /ingreso-produccion/confirm** - Valida y muestra confirmacion

Recibe LoteDTO con `@Validated(AltaProduccion.class)`. Ejecuta validaciones de negocio. Si ok, resuelve nombres de producto y muestra confirmacion.

**POST /ingreso-produccion** - Persiste el lote

Recibe LoteDTO validado. Si ok, invoca `altaStockPorProduccion()` y redirige a exito.

**GET /ingreso-produccion-ok** - Muestra resultado exitoso

Recibe LoteDTO via FlashAttributes y muestra detalles del lote creado.

**GET /cancelar** - Cancela la operacion

Redirige al home.

### 8.3 Caracteristicas Destacadas

- **Flujo de 3 pasos:** Formulario -> Confirmacion -> Exito.
- **Productos filtrados:** Solo muestra productos de tipo SEMIELABORADO, GRANEL o UNIDAD_VENTA.
- **Resolucion de nombres:** Antes de confirmacion, resuelve nombreProducto y codigoProducto desde IDs.

---

## 9. SERVICE

### 9.1 Clase: AltaIngresoProduccionService

El servicio contiene la logica de negocio del caso de uso. Extiende `AbstractCuService`.

### 9.2 Metodo Principal: altaStockPorProduccion

Este metodo ejecuta toda la operacion en una unica transaccion. El flujo es:

1. **Establecer contexto de auditoria:** Registra "CU20_INGRESO_PRODUCCION" para Hibernate Envers.

2. **Obtener usuario actual:** Recupera el usuario autenticado.

3. **Obtener proveedor Conifarma:** Busca el proveedor "Conifarma" (fabricacion propia). Si no existe, lanza excepcion.

4. **Obtener producto:** Busca el producto por ID. Si no existe, lanza excepcion.

5. **Crear Lote:** Invoca `LoteEntityUtils.createLoteIngreso()` y `populateLoteAltaProduccionPropia()` que:
   - Genera codigo: `{codigoProducto}_{sufijo}`
   - Asigna proveedor Conifarma
   - Crea bultos con cantidades y unidades especificadas

6. **Persistir Lote y Bultos:** Guarda el lote y sus bultos.

7. **Crear Movimiento:** Genera movimiento ALTA/PRODUCCION con `MovimientoAltaUtils.createMovimientoAltaIngresoProduccion()`.

8. **Crear DetalleMovimiento:** Por cada bulto, crea un DetalleMovimiento con cantidad y unidad.

9. **Persistir Movimiento:** Guarda el movimiento con sus detalles.

10. **Retornar DTO:** Convierte el lote guardado a DTO.

### 9.3 Pre-requisitos

| Condicion | Descripcion |
|-----------|-------------|
| Proveedor Conifarma | Debe existir en BD |
| Producto interno | Debe ser SEMIELABORADO, GRANEL o UNIDAD_VENTA |
| Codigo unico | El codigo de lote generado no debe existir |

---

## 10. PERSISTENCIA

### 10.1 Entidades Creadas

| Entidad | Accion | Estado Final |
|---------|--------|--------------|
| Lote | INSERT | estado=NUEVO, dictamen=RECIBIDO, proveedor=Conifarma |
| Bulto (1-15) | INSERT | cantidadActual=cantidadInicial, estado=NUEVO |
| Movimiento | INSERT | tipo=ALTA, motivo=PRODUCCION_PROPIA |
| DetalleMovimiento (1-15) | INSERT | Uno por cada bulto |

### 10.2 Movimiento Generado

El movimiento de alta incluye:

- **tipo:** ALTA
- **motivo:** PRODUCCION_PROPIA
- **fecha:** fechaIngreso del formulario
- **cantidad:** cantidadInicial total
- **unidadMedida:** unidadMedida del lote
- **motivoDelCambio:** Formateado con prefijo `[CU20]`
- **detalles:** Uno por cada bulto con su cantidad y unidad

### 10.3 Codigo de Lote Generado

El codigo se compone de:
- `{producto.codigoProducto}_{loteDTO.codigoLoteSufijo.toUpperCase()}`

Ejemplo: `PROD001_25010001A`

---

## 11. AUDITORIA (ANMAT)

El sistema cumple con los requerimientos de la Disposicion ANMAT 4159:

- **Hibernate Envers:** Todas las entidades (Lote, Bulto, Movimiento, DetalleMovimiento) estan auditadas.

- **Campo motivoDelCambio:** Obligatorio minimo 20 caracteres (Requerimiento 9 del Anexo 6).

- **Contexto de caso de uso:** "CU20_INGRESO_PRODUCCION" se guarda en cada revision.

- **Prefijo de CU:** El motivoDelCambio incluye `[CU20]`.

- **Orden de produccion:** Se registra para trazabilidad de fabricacion.

---

## 12. SEGURIDAD

- **CSRF:** Token incluido como campo oculto y en meta tags para AJAX.
- **Autorizacion:** Solo ADMIN o SUPERVISOR_PLANTA pueden acceder.
- **XSS:** Datos renderizados con escape automatico (th:text).
- **Validacion de codigo:** Impide crear lotes con codigo duplicado.
- **Validacion de proveedor:** Solo permite Conifarma como proveedor.

---

## 13. MANEJO DE ERRORES

Los errores se manejan en diferentes niveles:

- **Service:** Si Conifarma no existe, si producto no existe, o si codigo duplicado, se rechazan con mensajes descriptivos.
- **Controller:** Errores de validacion se muestran junto a cada campo.
- **AJAX:** Errores de carga de unidades se muestran en consola.
- **Excepciones no controladas:** Redirigen a pagina de error global.

---

## 14. LOGGING

El service registra eventos en los siguientes puntos:

- **Inicio:** `[CU20] Iniciando alta de stock por produccion - Usuario: {}, Producto: {}`
- **Validacion fallida:** Mensajes de warning con razon especifica
- **Completado:** `[CU20] Alta de stock por produccion completada - Lote: {}, Cantidad: {}, Bultos: {}, MotivoDelCambio: {}`

Todos los logs usan el prefijo `[CU20]`.

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| BAJA | Agregar validacion en frontend de suma de bultos = total antes de submit |
| BAJA | Mostrar preview del codigo de lote completo antes de confirmar |

---

## 16. ERRORES ENCONTRADOS EN REVISION

No se encontraron errores en los templates durante esta revision. Todos los elementos necesarios estan presentes:
- `id="mainForm"` en formulario principal
- `id="btnSubmit"` en boton de submit
- `id="btnConfirm"` en boton de confirmacion
- Prevencion de doble submit implementada correctamente
- Badge muestra CU20 correctamente

---

*Documento generado: 2025-12-13*
*Version: 1.1*
