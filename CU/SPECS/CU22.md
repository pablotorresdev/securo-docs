# CU22 - CONFIRMAR LOTE LIBERADO

**Caso de Uso:** Confirmar Lote Liberado para Venta
**URL Base:** `/ventas/confirmar-liberacion/confirmar-lote-liberado`
**Tipo:** MODIFICACION (Cambio de dictamen)
**Categoria:** Preventa (color naranja/ambar)
**Identificador Interno:** `CU22_CONFIRMAR_LIBERADO`

---

## 1. DESCRIPCION

Permite confirmar que un lote de producto UV (Unidad de Venta) fue liberado externamente y esta habilitado para la venta. El sistema NO libera lotes - solo registra la confirmacion del proceso externo de liberacion. El dictamen del lote cambia de APROBADO a LIBERADO.

**Caracteristicas principales:**
- Sistema no libera, solo confirma liberacion externa
- Solo para lotes de productos UV (Unidad de Venta)
- Dictamen: APROBADO -> LIBERADO
- Requiere exactamente un analisis con fecha de vencimiento
- Actualiza fechaVencimientoProveedor del lote desde el analisis
- Trazado del lote es **opcional** (puede o no estar trazado)

**Nota:** El requisito de exactamente un analisis con fechaVencimiento se valida en el momento de persistir, no en la query de seleccion.

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| DT | 5 | Permitido |
| GERENTE_GARANTIA_CALIDAD | 4 | Permitido |
| Otros | - | No permitido |

**Anotacion:** `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_GERENTE_GARANTIA_CALIDAD', 'ROLE_DT')")`

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. FORMULARIO                                                       |
|     GET /ventas/confirmar-liberacion/confirmar-lote-liberado        |
|     Template: ventas/confirmar-liberacion/confirmar-lote-liberado.html |
|  +---------------------------------------------------------------+  |
|  |  Select2: Lote a confirmar (producto, codigo, trazas)         |  |
|  |  Fecha de confirmacion                                         |  |
|  |  Motivo del cambio (min 20 chars)                              |  |
|  +---------------------------------------------------------------+  |
|  [Cancelar]                                        [Continuar] ->    |
+---------------------------------------------------------------------+
                              |
                              | POST /ventas/confirmar-liberacion/confirmar-lote-liberado/confirm
                              v
+---------------------------------------------------------------------+
|  2. CONFIRMACION                                                     |
|     Template: ventas/confirmar-liberacion/confirmar-lote-liberado-confirm.html |
|  +---------------------------------------------------------------+  |
|  |  Vista previa de datos del lote                                |  |
|  |  Vista previa de datos de la confirmacion                      |  |
|  |  Advertencia de confirmacion                                   |  |
|  +---------------------------------------------------------------+  |
|  [Volver a Editar]                       [Confirmar y Guardar] ->    |
+---------------------------------------------------------------------+
                              |
                              | POST /ventas/confirmar-liberacion/confirmar-lote-liberado
                              v
+---------------------------------------------------------------------+
|  3. EXITO                                                            |
|     GET /ventas/confirmar-liberacion/confirmar-lote-liberado-ok     |
|     Template: ventas/confirmar-liberacion/confirmar-lote-liberado-ok.html |
|  +---------------------------------------------------------------+  |
|  |  Mensaje de exito                                              |  |
|  |  Detalles del lote confirmado                                  |  |
|  |  Dictamen: LIBERADO                                            |  |
|  |  Tabla de movimientos                                          |  |
|  +---------------------------------------------------------------+  |
|  [Confirmar Otro Lote]                        [Volver al Inicio]     |
+---------------------------------------------------------------------+
```

El flujo de 3 pasos incluye confirmacion intermedia: formulario -> confirmacion -> persistencia -> exito.

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion |
|---------|-------------|
| `templates/ventas/confirmar-liberacion/confirmar-lote-liberado.html` | Formulario principal |
| `templates/ventas/confirmar-liberacion/confirmar-lote-liberado-confirm.html` | Confirmacion |
| `templates/ventas/confirmar-liberacion/confirmar-lote-liberado-ok.html` | Pantalla de exito |

### Backend
| Archivo | Descripcion |
|---------|-------------|
| `controller/cu/ModifConfirmarLoteLiberadoController.java` | Controlador |
| `service/cu/ModifConfirmarLoteLiberadoService.java` | Servicio de negocio |
| `service/cu/AbstractCuService.java` | Clase base con validaciones comunes |

### Validadores Especializados
| Archivo | Responsabilidad |
|---------|-----------------|
| `service/cu/validator/FechaValidator.java` | Validaciones de fechas |

### Utilidades de Creacion de Entidades
| Archivo | Uso en CU22 |
|---------|-------------|
| `utils/MovimientoModificacionUtils.java` | Factory para crear Movimiento MODIFICACION |
| `utils/MovimientoCommonUtils.java` | Formateo de motivoDelCambio con prefijo CU |

### DTOs y Entidades
| Archivo | Uso en CU22 |
|---------|-------------|
| `dto/MovimientoDTO.java` | DTO principal del formulario |
| `dto/LoteDTO.java` | DTO de respuesta |
| `entity/Lote.java` | Entidad Lote |
| `entity/Analisis.java` | Entidad Analisis (fecha vencimiento) |
| `entity/Movimiento.java` | Entidad Movimiento |

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Obligatorios

| Campo | HTML ID | Tipo | Validacion Browser | Validacion Server |
|-------|---------|------|-------------------|-------------------|
| Lote | `codigoLote` | select (Select2) | `required` | Existencia verificada |
| Fecha Confirmacion | `fechaMovimiento` | date | `required` | `@NotNull`, `@PastOrPresent` |
| Motivo del Cambio | `motivoDelCambio` | textarea | `required`, `minlength="20"` | `@NotNull`, `@Size(min=20)` |

### 5.2 Informacion Mostrada en Select

Cada opcion del selector muestra:
- Nombre del producto
- Codigo del lote
- Fecha de ingreso
- Rango de trazas (inicial/final)

---

## 6. VALIDACIONES POR CAPA

El sistema implementa validacion en 3 capas: Frontend (HTML5), Bean Validation (Spring), y Validacion de Negocio (Service).

### 6.1 CAPA 1: FRONTEND (Browser - HTML5 + JavaScript)

**Ubicacion:** `templates/ventas/confirmar-liberacion/confirmar-lote-liberado.html`

| Campo | Atributo HTML5 | Comportamiento |
|-------|---------------|----------------|
| `codigoLote` | `required` | Bloquea submit si no seleccionado |
| `fechaMovimiento` | `required`, `type="date"` | Bloquea submit si vacio |
| `motivoDelCambio` | `required`, `minlength="20"` | Minimo 20 caracteres |

**JavaScript Dinamico:**
- Inicializa fecha con fecha actual (timezone Argentina)
- Select2 para busqueda de lotes
- Enfoca primer campo con error automaticamente
- Prevencion de doble submit con spinner

---

### 6.2 CAPA 2: BEAN VALIDATION (Spring - Anotaciones Jakarta)

**Ubicacion:** `dto/MovimientoDTO.java`

| Campo | Anotaciones | Mensaje de Error |
|-------|-------------|------------------|
| fechaMovimiento | `@NotNull`, `@PastOrPresent` | "La fecha del movimiento es obligatoria" / "La fecha del movimiento no puede ser futura" |
| motivoDelCambio | `@NotNull`, `@Size(min=20)` | "El motivo del cambio es obligatorio" / "El motivo del cambio debe tener al menos 20 caracteres" |

---

### 6.3 CAPA 3: VALIDACION DE NEGOCIO (Service Layer)

**Ubicacion:** `ModifConfirmarLoteLiberadoService.java`

El metodo `validarConfirmarLoteLiberadoInput()` ejecuta las siguientes validaciones en orden:

| # | Validacion | Descripcion |
|---|-----------|-------------|
| 1 | BindingResult previo | Errores de Bean Validation |
| 2 | validarMotivoDelCambio | Motivo obligatorio >= 20 chars (ANMAT) |
| 3 | Lote existe | Verifica que codigoLote existe y esta activo |
| 4 | validarFechaMovimientoPosteriorIngresoLote | Fecha >= fecha ingreso lote |
| 5 | validarFechaAnalisisPosteriorIngresoLote | Fecha analisis >= fecha ingreso lote |

#### Detalle de Validaciones

**2. validarMotivoDelCambio** (ANMAT Disp. 4159, Anexo 6, Req. 9)

| Regla | Mensaje de Error |
|-------|------------------|
| `motivoDelCambio` no nulo y >= 20 caracteres | "El motivo del cambio es obligatorio (mínimo 20 caracteres)" |

**3. Lote existe**

| Regla | Mensaje de Error |
|-------|------------------|
| `loteRepository.findByCodigoLoteAndActivoTrue()` != null | "Lote no encontrado." |

**Validacion en Persistencia (metodo persistirConfirmarLoteLiberado):**

| Regla | Mensaje de Error |
|-------|------------------|
| Lote tiene exactamente 0 analisis con fechaVencimiento | "NO hay Analisis con fecha de vencimiento para el lote" |
| Lote tiene mas de 1 analisis con fechaVencimiento | "Hay más de un análisis activo con fecha de vencimiento" |
| Lote no existe en persistencia | "El lote no existe." |

---

### 6.4 RESUMEN DE VALIDACIONES POR CAMPO

| Campo | Frontend | Bean Validation | Negocio |
|-------|----------|-----------------|---------|
| codigoLote | required | - | Existencia, exactamente 1 analisis |
| fechaMovimiento | required | @NotNull, @PastOrPresent | >= fechaIngreso lote |
| motivoDelCambio | required, minlength | @NotNull, @Size(min=20) | >= 20 caracteres (ANMAT) |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

El formulario utiliza la paleta de colores **preventa** (naranja/ambar):

- **Fondo de pagina:** `bg-preventa` (gradiente naranja)
- **Tarjeta del formulario:** `form-preventa` con borde naranja
- **Botones primarios:** `btn-preventa` (gradiente naranja)
- **Section titles:** `section-title-preventa`
- **Info box:** Fondo naranja claro con borde naranja

### 7.2 Librerias Utilizadas

| Libreria | Proposito |
|----------|-----------|
| Bootstrap 5.3 | Framework CSS base, grid responsivo |
| Bootstrap Icons 1.11 | Iconografia en todo el formulario |
| jQuery 3.7 | Manipulacion DOM y eventos |
| Select2 4.1 | Dropdown con busqueda de lotes |
| common.css | Estilos compartidos del sistema |

### 7.3 Comportamiento JavaScript

1. **Inicializacion de fecha:** Establece la fecha de confirmacion con la fecha actual usando timezone de Argentina.

2. **Configuracion de selector:** Convierte el select de Lote en componente Select2 con busqueda por producto, codigo y trazas.

3. **Enfoque en error:** Automaticamente enfoca y scrollea al primer campo con error de validacion.

4. **Prevencion de doble submit:** Al enviar el formulario, el boton `btnSubmit` se deshabilita y muestra spinner "Procesando...".

### 7.4 Interacciones Dinamicas

Este CU no consume endpoints AJAX adicionales. Los datos de lotes se inyectan via Thymeleaf:

| Dato | Uso |
|------|-----|
| `confirmarLoteLiberadoDtos` | Lista de lotes APROBADOS disponibles para confirmar |

---

## 8. CONTROLLER

### 8.1 Clase: ModifConfirmarLoteLiberadoController

El controlador maneja el flujo de 3 pasos (formulario -> confirmacion -> persistencia) y extiende `AbstractCuController` para heredar servicios comunes.

### 8.2 Flujo de Endpoints

| Metodo | URL | Descripcion |
|--------|-----|-------------|
| GET | /ventas/confirmar-liberacion/cancelar | Cancela operacion, redirige a home |
| GET | /ventas/confirmar-liberacion/confirmar-lote-liberado | Muestra formulario |
| POST | /ventas/confirmar-liberacion/confirmar-lote-liberado/confirm | Valida y muestra confirmacion |
| POST | /ventas/confirmar-liberacion/confirmar-lote-liberado | Persiste confirmacion |
| GET | /ventas/confirmar-liberacion/confirmar-lote-liberado-ok | Pantalla exito |

**POST /confirmar-lote-liberado/confirm** - Valida y muestra confirmacion

Ejecuta validaciones. Si ok, resuelve nombres del lote para mostrar en la vista de confirmacion mediante `resolverNombresParaConfirmacion()` y retorna el template de confirmacion. Si hay errores, retorna al formulario.

**POST /confirmar-lote-liberado** - Persiste confirmacion

Recibe datos ya validados desde la pantalla de confirmacion. Ejecuta re-validacion, invoca `persistirConfirmarLoteLiberado()` y redirige a exito.

### 8.3 Modelo en GET

- `confirmarLoteLiberadoDtos`: Lotes APROBADOS disponibles para confirmar liberacion
- `movimientoDTO`: DTO del formulario (inicializado vacio)

### 8.4 Caracteristicas Destacadas

- **Flujo de 3 pasos:** Incluye confirmacion intermedia para operaciones criticas.
- **Parametro confirm:** El endpoint `/confirm` diferencia entre vista previa y persistencia.
- **Flash Attributes:** El resultado (LoteDTO) se pasa a la pantalla de exito via RedirectAttributes.
- **Filtrado de lotes:** Solo muestra lotes elegibles para confirmacion (ver 8.5).
- **Autorizacion:** `@PreAuthorize` en GET y POST del formulario.
- **Transaccion read-only:** El endpoint `/confirm` usa `@Transactional(readOnly = true)` para optimizar.
- **Resolucion de nombres:** `resolverNombresParaConfirmacion()` carga nombreProducto y codigoProducto para mostrar en confirmacion.

### 8.5 Pre-requisitos del Lote (Query findAllForConfirmarLoteLiberado)

| Condicion | Descripcion |
|-----------|-------------|
| Activo | `activo = true` |
| Dictamen APROBADO | `dictamen = APROBADO` |
| Producto UV | `producto.tipoProducto = UNIDAD_VENTA` |
| Con stock | Al menos un bulto con `cantidadActual > 0` |

**Nota sobre trazado:** El trazado del lote es **opcional** para la liberacion. Un lote puede o no estar trazado al momento de confirmarse como liberado. Si el lote tiene trazas, se muestran en el selector; si no las tiene, se omite esa informacion.

**Query JPQL:**
```java
select l from Lote l
where l.activo = true
  and l.dictamen = APROBADO
  and l.producto.tipoProducto = UNIDAD_VENTA
  and exists (select 1 from Bulto b where b.lote = l and b.cantidadActual > 0)
order by l.fechaIngreso asc, l.codigoLote asc
```

---

## 9. SERVICE

### 9.1 Clase: ModifConfirmarLoteLiberadoService

El servicio contiene la logica de negocio del caso de uso. Extiende `AbstractCuService` para heredar validadores comunes y repositorios.

### 9.2 Metodo Principal: persistirConfirmarLoteLiberado

Este metodo ejecuta toda la operacion en una unica transaccion. El flujo es:

1. **Establecer contexto de auditoria:** Registra "CU22_CONFIRMAR_LIBERADO" para Hibernate Envers.

2. **Obtener usuario actual:** Recupera el usuario autenticado.

3. **Cargar Lote:** Busca el lote por codigoLote. Si no existe, lanza excepcion con mensaje "El lote no existe."

4. **Crear Movimiento:** Genera movimiento MODIFICACION/LOTE_LIBERADO con dictamen APROBADO -> LIBERADO.

5. **Obtener Analisis:** Busca analisis con fechaVencimiento:
   - Si 0: Lanza `IllegalStateException` con mensaje "NO hay Analisis con fecha de vencimiento para el lote"
   - Si 1: OK - usa ese analisis
   - Si > 1: Lanza `IllegalStateException` con mensaje "Hay más de un análisis activo con fecha de vencimiento"

6. **Actualizar Lote:**
   - `fechaVencimientoProveedor` = analisis.fechaVencimiento
   - `dictamen` = LIBERADO

7. **Persistir y retornar:** Guarda el lote y retorna el DTO.

### 9.3 Movimiento Generado

El movimiento de modificacion incluye:

- **tipo:** MODIFICACION
- **motivo:** LOTE_LIBERADO
- **fecha:** fechaMovimiento del formulario
- **dictamenInicial:** APROBADO (dictamen actual del lote)
- **dictamenFinal:** LIBERADO
- **motivoDelCambio:** Formateado con prefijo `[CU22]`
- **creadoPor:** Usuario actual
- **fechaYHoraCreacion:** Timestamp de creacion
- **codigoMovimiento:** Generado con `generateMovimientoCode(codigoLote, fechaYHoraCreacion)`
- **lote:** Referencia al lote modificado
- **activo:** true

### 9.4 Pre-requisitos del Lote

| Condicion | Descripcion |
|-----------|-------------|
| Producto UV | Tipo UNIDAD_VENTA |
| Dictamen APROBADO | Listo para liberar |
| Exactamente 1 analisis con vencimiento | Validado en persistencia |

---

## 10. PERSISTENCIA

### 10.1 Entidades Afectadas

| Entidad | Accion | Estado Final |
|---------|--------|--------------|
| Lote | UPDATE | dictamen=LIBERADO, fechaVencimientoProveedor actualizada |
| Movimiento | INSERT | tipo=MODIFICACION, motivo=LOTE_LIBERADO |

### 10.2 Movimiento Generado

El movimiento de modificacion incluye:

- **tipo:** MODIFICACION
- **motivo:** LOTE_LIBERADO
- **fecha:** fechaMovimiento del formulario
- **dictamenInicial:** APROBADO
- **dictamenFinal:** LIBERADO
- **motivoDelCambio:** Formateado con prefijo `[CU22]`
- **creadoPor:** Usuario actual
- **fechaYHoraCreacion:** Timestamp de creacion
- **codigoMovimiento:** Generado automaticamente
- **lote:** Referencia al lote modificado
- **activo:** true

### 10.3 Cascade y Soft Delete

El Movimiento se guarda explicitamente y se agrega a la lista del Lote. El Lote se actualiza con el nuevo dictamen y fechaVencimientoProveedor.

Todas las entidades usan borrado logico.

---

## 11. AUDITORIA (ANMAT)

El sistema cumple con los requerimientos de la Disposicion ANMAT 4159:

- **Hibernate Envers:** Todas las entidades (Lote, Movimiento) estan auditadas. Cada cambio genera registro en tablas `_aud`.

- **Campo motivoDelCambio:** Obligatorio minimo 20 caracteres (Requerimiento 9 del Anexo 6).

- **Contexto de caso de uso:** "CU22_CONFIRMAR_LIBERADO" se guarda en cada revision.

- **Prefijo de CU:** El motivoDelCambio incluye `[CU22]`.

- **Transicion de dictamen:** APROBADO -> LIBERADO registrado en movimiento.

---

## 12. SEGURIDAD

- **CSRF:** Token incluido como campo oculto y en meta tags para AJAX.
- **Autorizacion:** Solo ADMIN, DT o GERENTE_GARANTIA_CALIDAD pueden acceder.
- **XSS:** Datos renderizados con escape automatico (th:text).
- **Validacion de lote:** Solo permite confirmar lotes UV aprobados con stock.

---

## 13. MANEJO DE ERRORES

Los errores se manejan en diferentes niveles:

- **Service:** Si lote no existe, si no tiene analisis con vencimiento, o si tiene multiples analisis, se lanza excepcion con mensaje descriptivo.
- **Controller:** Errores de validacion se muestran junto a cada campo en el formulario.
- **Excepciones no controladas:** Redirigen a la pagina de error global del sistema.

---

## 14. LOGGING

El service registra eventos en los siguientes puntos:

- **Inicio:** `[CU22] Iniciando confirmacion de lote liberado - Usuario: {}, Lote: {}`
- **Completado:** `[CU22] Confirmacion de lote liberado completada - Lote: {}, Dictamen: {}, MotivoDelCambio: {}`

Todos los logs usan el prefijo `[CU22]` para facilitar la busqueda.

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| ~~BAJA~~ | ~~Agregar pantalla de confirmacion intermedia para consistencia con otros CUs~~ - **IMPLEMENTADO** |

---

## 16. ERRORES ENCONTRADOS EN REVISION

No se encontraron errores en los templates durante esta revision. Todos los elementos necesarios estan presentes:
- `id="codigoLote"` en selector de lote
- `id="btnSubmit"` en boton de submit
- Prevencion de doble submit implementada correctamente
- Badge muestra CU22 correctamente

---

*Documento generado: 2025-12-13*
*Ultima actualizacion: 2025-12-27*
*Version: 1.2*
