# CU22 - BAJA VENTA PRODUCTO

**Caso de Uso:** Venta de Producto
**URL Base:** `/ventas/baja/venta-producto`
**Tipo:** BAJA (Egreso de stock por venta)
**Categoria:** Ventas (color verde)
**Identificador Interno:** `CU22_VENTA_PRODUCTO`

---

## 1. DESCRIPCION

Permite registrar la venta de productos descontando stock del lote. El sistema descuenta cantidades por bulto, marca las trazas correspondientes como VENDIDO siguiendo orden FIFO (First In, First Out), y genera un movimiento de tipo BAJA/VENTA.

**Caracteristicas principales:**
- Solo lotes con dictamen LIBERADO pueden venderse
- Descuento multi-bulto (cantidades independientes por bulto)
- Gestion FIFO de trazas: marca trazas como VENDIDO en orden
- Muestra trazas vendidas para retiro fisico del stock
- Cancela analisis en curso si el lote queda sin stock
- Estado final del bulto: EN_USO o CONSUMIDO (segun cantidad restante)

**Requisito:** El lote debe tener dictamen LIBERADO (previamente confirmado con CU21).

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| ANALISTA_PLANTA | 2 | Permitido |
| Otros | - | No permitido |

**Anotacion:** `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_ANALISTA_PLANTA')")`

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. FORMULARIO                                                       |
|     GET /ventas/baja/venta-producto                                 |
|     Template: ventas/baja/venta-producto.html                       |
|  +---------------------------------------------------------------+  |
|  |  Select2: Lote a vender (codigo, producto, proveedor)         |  |
|  |  Fecha de egreso                                               |  |
|  |  Cantidades dinamicas por bulto (JavaScript)                  |  |
|  |  Motivo del cambio (min 20 chars)                             |  |
|  +---------------------------------------------------------------+  |
|  [Cancelar]                               [Registrar Venta] ->      |
+---------------------------------------------------------------------+
                              |
                              | POST /ventas/baja/venta-producto
                              v
+---------------------------------------------------------------------+
|  2. EXITO                                                            |
|     GET /ventas/baja/venta-producto-ok                              |
|     Template: ventas/baja/venta-producto-ok.html                    |
|  +---------------------------------------------------------------+  |
|  |  Mensaje de exito                                              |  |
|  |  Detalles del lote                                             |  |
|  |  Cantidades vendidas por bulto                                 |  |
|  |  TRAZAS A RETIRAR (por bulto, orden FIFO)                     |  |
|  |  Tabla de movimientos                                          |  |
|  +---------------------------------------------------------------+  |
|  [Registrar Otra Venta]                      [Volver al Inicio]     |
+---------------------------------------------------------------------+
```

El flujo de 2 pasos es directo: formulario -> persistencia -> exito.

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `templates/ventas/baja/venta-producto.html` | Formulario | 364 |
| `templates/ventas/baja/venta-producto-ok.html` | Exito | 318 |

### Backend
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `controller/cu/BajaVentaProductoController.java` | Controlador | 129 |
| `service/cu/BajaVentaProductoService.java` | Servicio | 216 |
| `service/cu/AbstractCuService.java` | Clase base | - |

### Utilidades
| Archivo | Uso en CU22 |
|---------|-------------|
| `utils/MovimientoBajaUtils.java` | Factory para Movimiento BAJA/VENTA |
| `utils/DTOUtils.java` | Conversion entidad -> DTO |

### DTOs y Entidades
| Archivo | Uso en CU22 |
|---------|-------------|
| `dto/LoteDTO.java` | DTO del formulario y respuesta |
| `dto/TrazaDTO.java` | DTO de trazas vendidas |
| `entity/Lote.java` | Entidad Lote |
| `entity/Bulto.java` | Entidad Bulto |
| `entity/Movimiento.java` | Entidad Movimiento |
| `entity/DetalleMovimiento.java` | Detalle por bulto |
| `entity/Traza.java` | Entidad Traza |

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Obligatorios

| Campo | HTML ID | Tipo | Validacion Browser | Validacion Server |
|-------|---------|------|-------------------|-------------------|
| Lote | `codigoLote` | select (Select2) | `required` | Existencia, dictamen LIBERADO |
| Fecha Egreso | `fechaEgreso` | date | `required` | `@NotNull`, `@PastOrPresent` |
| Cantidades | `cantidadesBultos[n]` | number | `required`, `min=0` | Por bulto, no exceder stock |
| Motivo del Cambio | `motivoDelCambio` | textarea | `required`, `minlength="20"` | `@NotNull`, `@Size(min=20)` |

### 5.2 Campos Ocultos

| Campo | Proposito |
|-------|-----------|
| `nroBultoList[n]` | Numero de bulto para cada cantidad |
| `unidadMedidaBultos[n]` | Unidad de medida del bulto |

### 5.3 Informacion Mostrada en Select

Cada opcion del selector muestra:
- Codigo del lote
- Nombre del producto
- Nombre del proveedor
- Dictamen (LIBERADO)

---

## 6. VALIDACIONES POR CAPA

### 6.1 CAPA 1: FRONTEND (Browser - HTML5 + JavaScript)

**Ubicacion:** `venta-producto.html`

| Campo | Atributo HTML5 | Comportamiento |
|-------|---------------|----------------|
| `codigoLote` | `required` | Bloquea submit si no seleccionado |
| `fechaEgreso` | `required`, `type="date"` | Bloquea submit si vacio |
| `cantidadesBultos[n]` | `required`, `min="0"` | Minimo 0, maximo stock bulto |
| `motivoDelCambio` | `required`, `minlength="20"` | Minimo 20 caracteres |

**JavaScript:**
- Inicializa fecha con fecha actual (timezone Argentina)
- Select2 para busqueda de lotes
- Carga dinamica de bultos al seleccionar lote via AJAX
- Valida que al menos un bulto tenga cantidad > 0
- Enfoca primer campo con error

---

### 6.2 CAPA 2: BEAN VALIDATION (Spring)

**Ubicacion:** `dto/LoteDTO.java`

| Campo | Anotaciones | Mensaje de Error |
|-------|-------------|------------------|
| fechaEgreso | `@NotNull`, `@PastOrPresent` | "La fecha de consumo es obligatoria" / "La fecha de consumo no puede ser futura" |
| motivoDelCambio | `@NotNull`, `@Size(min=20)` | "El campo motivo del cambio es obligatorio (mÃ­nimo 20 caracteres)" |

---

### 6.3 CAPA 3: VALIDACION DE NEGOCIO (Service Layer)

**Ubicacion:** `BajaVentaProductoService.java`

El metodo `validarVentaProductoInput()` ejecuta:

| # | Validacion | Descripcion |
|---|-----------|-------------|
| 1 | validarMotivoDelCambio | Motivo >= 20 chars (ANMAT) |
| 2 | Lote existe | codigoLote existe y esta activo |
| 3 | Dictamen LIBERADO | Solo lotes LIBERADO pueden venderse |
| 4 | validarUnidadMedidaVenta | Unidad de medida compatible |
| 5 | validarFechaEgresoLoteDtoPosteriorLote | Fecha >= fechaIngreso |
| 6 | validarCantidadesPorMedidas | Cantidades no exceden stock por bulto |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

El formulario utiliza la paleta de colores **ventas** (verde):

- **Fondo de pagina:** `bg-ventas`
- **Tarjeta del formulario:** `form-ventas`
- **Botones primarios:** `btn-ventas`
- **Info box:** Fondo verde claro con borde verde

### 7.2 Librerias Utilizadas

| Libreria | Proposito |
|----------|-----------|
| Bootstrap 5.3 | Framework CSS |
| Bootstrap Icons | Iconografia |
| jQuery 3.7 | DOM y eventos |
| Select2 | Dropdown con busqueda |
| common.css | Estilos compartidos |

### 7.3 Comportamiento JavaScript

1. **Inicializacion de fecha:** Fecha actual timezone Argentina.
2. **Select2:** Busqueda de lotes LIBERADO.
3. **Carga dinamica de bultos:** Al seleccionar lote, consulta `/api/lotes/{codigo}/bultos` para obtener bultos disponibles.
4. **Generacion de inputs:** Crea dinamicamente inputs de cantidad por cada bulto con stock > 0.
5. **Validacion cantidad minima:** Al menos un bulto debe tener cantidad > 0.
6. **Enfoque en error:** Enfoca y scrollea al primer campo con error.
7. **Prevencion doble submit:** Boton `btnSubmit` se deshabilita al enviar.

### 7.3.1 Prevencion de doble submit

```javascript
document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('btnSubmit');
    if (btn) {
        btn.closest('form').addEventListener('submit', function(e) {
            if (btn.disabled) { e.preventDefault(); return; }
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
        });
    }
});
```

---

## 8. CONTROLLER

### 8.1 Clase: BajaVentaProductoController

El controlador maneja el flujo de 2 pasos y extiende `AbstractCuController`.

### 8.2 Flujo de Endpoints

**GET /venta-producto** - Muestra formulario

Carga en el modelo:
- Lotes disponibles (`loteService.findAllForVentaProductoDTOs()`)
- LoteDTO vacio

**POST /venta-producto** - Valida y persiste

Ejecuta validaciones. Si ok, invoca `bajaVentaProducto()` y redirige a exito.

**GET /venta-producto-ok** - Muestra resultado exitoso

Recibe LoteDTO y trazas vendidas via FlashAttributes.

**GET /cancelar** - Cancela

Redirige al home.

### 8.3 Metodo getTrazaPorBultoDTOs

Agrupa las trazas vendidas por numero de bulto usando `TreeMap` para orden natural (1, 2, 3...). Ordena las trazas dentro de cada bulto.

### 8.4 Filtrado de Lotes

Solo muestra lotes que cumplen:
- Dictamen LIBERADO
- Stock disponible (cantidadActual > 0 en algun bulto)
- Activo = true
- Estado NO es RECALL
- Tipo de producto = UNIDAD_VENTA

---

## 9. SERVICE

### 9.1 Clase: BajaVentaProductoService

El servicio contiene la logica de negocio. Extiende `AbstractCuService`.

### 9.2 Metodo Principal: bajaVentaProducto

Flujo de la operacion:

1. **Establecer contexto de auditoria:** "CU22_VENTA_PRODUCTO"

2. **Obtener usuario actual**

3. **Cargar Lote:** Por codigoLote. Si no existe, lanza excepcion.

4. **Crear Movimiento:** Invoca `persistirMovimientoBajaVenta()` con detalles por bulto.

5. **Iterar por bultos vendidos:**
   - Descontar cantidad del bulto
   - Descontar cantidad del lote
   - Actualizar estado bulto (EN_USO o CONSUMIDO)
   - Guardar bulto

6. **Actualizar estado lote:** CONSUMIDO si todos bultos estan CONSUMIDO, sino EN_USO.

7. **Cancelar analisis en curso:** Si el lote queda con cantidad 0 y tiene analisis sin dictamen, lo cancela.

8. **Persistir y retornar**

### 9.3 Metodo: persistirMovimientoBajaVenta

Crea el movimiento BAJA/VENTA con:

1. **Calcular cantidad total:** Suma de todas las cantidades por bulto.

2. **Crear DetalleMovimiento por bulto:** Para cada bulto con cantidad > 0:
   - Crear DetalleMovimiento con bulto, cantidad, unidad
   - Si lote trazado: obtener trazas FIFO (`getFirstAvailableTrazaList`)
   - Marcar trazas como VENDIDO
   - Guardar trazas

3. **Guardar movimiento**

### 9.4 Gestion FIFO de Trazas

El metodo `bulto.getFirstAvailableTrazaList(cantidad)` obtiene las primeras `cantidad` trazas disponibles (no vendidas) del bulto. Esto garantiza el orden FIFO para la venta.

---

## 10. PERSISTENCIA

### 10.1 Entidades Afectadas

| Entidad | Accion | Estado Final |
|---------|--------|--------------|
| Lote | UPDATE | estado=EN_USO o CONSUMIDO, cantidadActual reducida |
| Bulto | UPDATE | estado=EN_USO o CONSUMIDO, cantidadActual reducida |
| Movimiento | INSERT | tipo=BAJA, motivo=VENTA |
| DetalleMovimiento | INSERT | Por cada bulto vendido |
| Traza | UPDATE | estado=VENDIDO (si lote trazado) |
| Analisis | UPDATE | dictamen=CANCELADO (si lote queda sin stock) |

### 10.2 Movimiento Generado

- **tipo:** BAJA
- **motivo:** VENTA
- **fecha:** fechaEgreso del formulario
- **cantidad:** Suma total de todas las cantidades vendidas
- **unidadMedida:** UNIDAD
- **dictamenInicial:** null (BAJA no cambia dictamen)
- **dictamenFinal:** null (BAJA no cambia dictamen)
- **motivoDelCambio:** Formateado con prefijo `[CU22]`
- **creadoPor:** Usuario actual
- **codigoMovimiento:** `{codigoLote}-{timestamp}`
- **detalles:** Lista de DetalleMovimiento por bulto

### 10.3 Detalles del Movimiento

Cada DetalleMovimiento contiene:
- Referencia al Bulto
- Cantidad vendida del bulto
- Unidad de medida
- Lista de Trazas vendidas (si aplica)

---

## 11. AUDITORIA (ANMAT)

El sistema cumple con los requerimientos de la Disposicion ANMAT 4159:

- **Hibernate Envers:** Todas las entidades auditadas.
- **Campo motivoDelCambio:** Obligatorio minimo 20 caracteres.
- **Contexto de caso de uso:** "CU22_VENTA_PRODUCTO"
- **Prefijo de CU:** `[CU22]`
- **Trazabilidad:** Cada traza vendida queda registrada con estado VENDIDO.

---

## 12. SEGURIDAD

- **CSRF:** Token incluido en formulario y meta tags.
- **Autorizacion:** Solo ADMIN o ANALISTA_PLANTA.
- **XSS:** Escape automatico con th:text.
- **Validacion de lote:** Solo lotes LIBERADO con stock disponible.
- **Validacion de cantidades:** No permite vender mas que el stock disponible.

---

## 13. MANEJO DE ERRORES

### Por Capa

| Capa | Tipo de Error | Comportamiento |
|------|--------------|----------------|
| Frontend | HTML5 validation | Bloquea submit, muestra mensaje |
| Frontend | JS validation | Alert si ninguna cantidad > 0 |
| Bean Validation | @NotNull, @Size | Muestra junto al campo |
| Service | Lote no existe | Excepcion IllegalArgumentException |
| Service | Dictamen no LIBERADO | Error en bindingResult |
| Service | Stock insuficiente | Error en bindingResult |

---

## 14. LOGGING

El service registra:

- **Inicio:** `[CU22] Iniciando baja por venta - Usuario: {}, Lote: {}`
- **Completado:** `[CU22] Baja por venta completada - Lote: {}, Cantidad restante: {}, Estado: {}, MotivoDelCambio: {}`

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| BAJA | Agregar confirmacion antes de registrar venta |
| BAJA | Mostrar preview de trazas que se van a marcar como VENDIDO antes de confirmar |

---

## 16. ERRORES ENCONTRADOS EN REVISION

### 16.1 Badge incorrecto en formulario
- **Archivo:** `venta-producto.html` linea 20
- **Problema:** Badge dice "CU Venta" en lugar de "CU22"
- **Impacto:** Solo visual/consistencia
- **Estado:** Corregido

### 16.2 Badge incorrecto en exito
- **Archivo:** `venta-producto-ok.html` linea 173
- **Problema:** Badge dice "CU Venta de Producto" en lugar de "CU22"
- **Impacto:** Solo visual/consistencia
- **Estado:** Corregido

---

*Documento generado: 2025-12-13*
*Version: 1.0*
