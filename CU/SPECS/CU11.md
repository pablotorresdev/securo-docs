# CU11 - ANULACION DE ANALISIS

**Caso de Uso:** Anulacion de Analisis en Curso
**URL Base:** `/calidad/anulacion/anulacion-analisis`
**Tipo:** MODIFICACION (Anula analisis)
**Categoria:** Calidad - Indeseado (color rojo/naranja)
**Identificador Interno:** `CU11_ANULACION_ANALISIS`

---

## 1. DESCRIPCION

Permite anular un analisis que esta "en curso" (sin dictamen). La anulacion marca el analisis como ANULADO y restaura el dictamen anterior del lote. Se genera un movimiento de MODIFICACION con motivo ANULACION_ANALISIS. Este caso de uso se utiliza cuando un analisis se inicio pero no debe continuar por error, cambio de procedimiento u otro motivo justificado.

**Caracteristicas principales:**
- Solo puede anular analisis sin dictamen (en curso)
- Restaura el dictamen anterior del lote (obtenido del movimiento de analisis)
- El analisis queda marcado como ANULADO (no se elimina fisicamente)
- Requiere justificacion obligatoria (mínimo 20 caracteres)

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| GERENTE_CONTROL_CALIDAD | 3 | Permitido |
| Otros | - | No permitido |

**Anotacion:** `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_GERENTE_CONTROL_CALIDAD')")`

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. FORMULARIO                                                       |
|     GET /calidad/anulacion/anulacion-analisis                       |
|     Template: calidad/anulacion/anulacion-analisis.html             |
|  +---------------------------------------------------------------+  |
|  |  Select2: Analisis en curso (nro analisis, codigo lote)       |  |
|  |  Detalles del analisis (dinamico via AJAX)                    |  |
|  |  - Informacion del lote                                       |  |
|  |  - Historial de analisis del lote                             |  |
|  |  Motivo del cambio (min 20 chars)                              |  |
|  +---------------------------------------------------------------+  |
|  [Cancelar]                                   [Vista Previa] ->      |
+---------------------------------------------------------------------+
                              |
                              | POST /calidad/anulacion/anulacion-analisis
                              | (sin parametro confirmed)
                              v
+---------------------------------------------------------------------+
|  2. CONFIRMACION                                                     |
|     Template: calidad/anulacion/anulacion-analisis-confirm.html     |
|  +---------------------------------------------------------------+  |
|  |  Datos del analisis a anular                                   |  |
|  |  Informacion del lote                                          |  |
|  |  Motivo de la anulacion                                        |  |
|  |  Advertencia de operacion critica                              |  |
|  +---------------------------------------------------------------+  |
|  [Volver a Editar]                      [Confirmar Anulacion] ->    |
+---------------------------------------------------------------------+
                              |
                              | POST /calidad/anulacion/anulacion-analisis
                              | (con confirmed=true)
                              v
+---------------------------------------------------------------------+
|  3. EXITO                                                            |
|     GET /calidad/anulacion/anulacion-analisis-ok (redirect)         |
|     Template: calidad/anulacion/anulacion-analisis-ok.html          |
|  +---------------------------------------------------------------+  |
|  |  Mensaje de exito: "Anulacion de analisis exitoso"            |  |
|  |  Detalles del lote actualizado                                 |  |
|  |  Tabla de movimientos                                          |  |
|  |  Tabla de analisis (mostrando el anulado)                      |  |
|  +---------------------------------------------------------------+  |
|  [Continuar]                                                         |
+---------------------------------------------------------------------+
```

El flujo de 3 pasos incluye confirmacion intermedia: formulario -> confirmacion -> persistencia -> exito.

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion |
|---------|-------------|
| `templates/calidad/anulacion/anulacion-analisis.html` | Formulario principal |
| `templates/calidad/anulacion/anulacion-analisis-confirm.html` | Confirmacion |
| `templates/calidad/anulacion/anulacion-analisis-ok.html` | Pantalla de exito |

### Backend
| Archivo | Descripcion |
|---------|-------------|
| `controller/cu/ModifAnulacionAnalisisController.java` | Controlador |
| `service/cu/ModifAnulacionAnalisisService.java` | Servicio de negocio |
| `service/cu/AbstractCuService.java` | Clase base con validaciones comunes |

### Validadores Especializados
| Archivo | Responsabilidad |
|---------|-----------------|
| `service/cu/validator/FechaValidator.java` | Validaciones de fechas |

### Utilidades de Creacion de Entidades
| Archivo | Uso en CU11 |
|---------|-------------|
| `utils/MovimientoModificacionUtils.java` | Factory para crear Movimiento MODIFICACION |

### DTOs y Entidades
| Archivo | Uso en CU11 |
|---------|-------------|
| `dto/MovimientoDTO.java` | DTO principal del formulario |
| `entity/Lote.java` | Entidad Lote (restaura dictamen) |
| `entity/Analisis.java` | Entidad Analisis (marca ANULADO) |
| `entity/Movimiento.java` | Entidad Movimiento |

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Obligatorios

| Campo | HTML ID | Tipo | Validacion Browser | Validacion Server |
|-------|---------|------|-------------------|-------------------|
| Analisis | `analisisSelector` | select (Select2) | - | Existencia verificada, no anulado |
| Motivo del Cambio | `motivoDelCambio` | textarea | `required`, `minlength="20"` | `@NotNull`, `@Size(min=20)` |

### 5.2 Campos Hidden

| Campo | HTML ID | Descripcion |
|-------|---------|-------------|
| fechaMovimiento | - | Fecha actual (auto, hidden) |
| codigoLote | `codigoLote` | Codigo del lote (cargado via JS) |

### 5.3 Informacion Mostrada (no editables)

Al seleccionar un analisis se muestra via AJAX:
- Codigo interno del lote
- Nombre del producto
- Fecha de ingreso
- Fecha de reanalisis proveedor
- Fecha de vencimiento proveedor
- Lista de analisis del lote con sus estados

---

## 6. VALIDACIONES POR CAPA

### 6.1 CAPA 1: FRONTEND (Browser - HTML5 + JavaScript)

**Ubicacion:** `templates/calidad/anulacion/anulacion-analisis.html`

| Campo | Atributo HTML5 | Comportamiento |
|-------|---------------|----------------|
| `motivoDelCambio` | `required`, `minlength="20"` | Minimo 20 caracteres |

**JavaScript Dinamico:**
- Carga detalles del analisis via AJAX (`GET /analisis/nroAnalisis/{nro}`)
- Actualiza campo hidden `codigoLote` al seleccionar analisis
- Enfoca primer campo con error automaticamente

---

### 6.2 CAPA 2: BEAN VALIDATION (Spring - Anotaciones Jakarta)

**Ubicacion:** `dto/MovimientoDTO.java`

| Campo | Anotaciones | Mensaje de Error |
|-------|-------------|------------------|
| fechaMovimiento | `@NotNull`, `@PastOrPresent` | "La fecha del movimiento es obligatoria" / "no puede ser futura" |
| motivoDelCambio | `@NotNull`, `@Size(min=20)` | "El motivo del cambio es obligatorio" / "debe tener al menos 20 caracteres" |

---

### 6.3 CAPA 3: VALIDACION DE NEGOCIO (Service Layer)

**Ubicacion:** `ModifAnulacionAnalisisService.java`

El metodo `validarAnulacionAnalisisInput()` ejecuta las siguientes validaciones en orden:

| # | Validacion | Descripcion |
|---|-----------|-------------|
| 1 | validarMotivoDelCambio | Motivo obligatorio >= 20 chars (ANMAT) |
| 2 | validarDatosMandatoriosAnulacionAnalisisInput | Campos requeridos presentes |
| 3 | Analisis existe | Verifica que el nroAnalisis existe y esta activo |
| 4 | Analisis no anulado | Verifica que dictamen != ANULADO |
| 5 | No hay duplicados | Verifica que no existan multiples movimientos para el mismo analisis |
| 6 | Lote existe | Verifica que el lote asociado existe |
| 7 | validarFechaMovimientoPosteriorIngresoLote | Fecha >= fecha ingreso lote |

#### Detalle de Validaciones

**1. validarMotivoDelCambio** (ANMAT Disp. 4159, Anexo 6, Req. 9)

| Regla | Mensaje de Error |
|-------|------------------|
| `motivoDelCambio` no nulo y >= 20 caracteres | "El motivo del cambio es obligatorio (mínimo 20 caracteres)" |

**3. Analisis existe**

| Regla | Mensaje de Error |
|-------|------------------|
| `analisisRepository.findByNroAnalisisAndActivoTrue()` != null | "El análisis no existe en el sistema." |

**4. Analisis no anulado**

| Regla | Mensaje de Error |
|-------|------------------|
| `analisis.getDictamen()` != ANULADO | "El análisis ya ha sido anulado, no es posible anularlo nuevamente." |

**5. No hay duplicados**

| Regla | Mensaje de Error |
|-------|------------------|
| `movModifAnalisisByNro.size()` <= 1 | "Existen múltiples movimientos de análisis con el mismo número. Contacte al administrador." |

---

### 6.4 RESUMEN DE VALIDACIONES POR CAMPO

| Campo | Frontend | Bean Validation | Negocio |
|-------|----------|-----------------|---------|
| nroAnalisis | - | - | Existe, no anulado, sin duplicados |
| codigoLote | - | - | Lote existe |
| fechaMovimiento | (auto) | @NotNull, @PastOrPresent | >= fechaIngreso lote |
| motivoDelCambio | required, minlength | @NotNull, @Size(min=20) | >= 20 caracteres (ANMAT) |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

El formulario utiliza la paleta de colores **indeseado** (rojo/naranja) que identifica operaciones criticas o de anulacion:

- **Fondo de pagina:** `bg-indeseado` (definido en common.css)
- **Tarjeta del formulario:** `form-indeseado` con borde color indeseado
- **Botones primarios:** `btn-indeseado`
- **Info box:** `info-box-indeseado` con icono de advertencia
- **Badge CU:** CU11 en color indeseado

### 7.2 Librerias Utilizadas

| Libreria | Proposito |
|----------|-----------|
| Bootstrap 5.3 | Framework CSS base, grid responsivo |
| Bootstrap Icons | Iconografia en todo el formulario |
| jQuery 3.7 | Manipulacion DOM y eventos |
| Select2 | Dropdown con busqueda de texto |
| common.css | Estilos compartidos del sistema |

### 7.3 Comportamiento JavaScript

1. **Configuracion de selector:** Convierte el select de Analisis en componente Select2 con busqueda.

2. **Carga de detalle via AJAX:** Al seleccionar un analisis, consulta `GET /analisis/nroAnalisis/{nro}` para obtener informacion del lote y sus analisis.

3. **Sincronizacion de codigoLote:** Al seleccionar analisis, extrae `attr-codigoLote` del option y lo asigna al campo hidden.

4. **Prevencion de doble submit:** Al enviar el formulario, el boton `btnSubmit` se deshabilita y muestra spinner.

5. **Restauracion de datos:** Si el formulario se recarga por error de validacion, dispara la carga de info automaticamente.

6. **Enfoque en error:** Automaticamente enfoca el primer campo con error de validacion.

### 7.4 Interacciones Dinamicas

| Endpoint AJAX | Uso |
|---------------|-----|
| `GET /analisis/nroAnalisis/{nro}` | Obtiene LoteDTO con analisis para mostrar detalles |

---

## 8. CONTROLLER

### 8.1 Clase: ModifAnulacionAnalisisController

El controlador maneja el flujo de 3 pasos (formulario -> confirmacion -> persistencia) y extiende `AbstractCuController`.

### 8.2 Flujo de Endpoints

**GET /anulacion-analisis** - Muestra el formulario

Carga en el modelo:
- Analisis en curso (`analisisService.findAllEnCursoDTOs()`)
- MovimientoDTO con fecha actual

**POST /anulacion-analisis** - Valida y muestra confirmacion o persiste

Recibe el DTO con los datos del formulario. Ejecuta Bean Validation y validaciones de negocio. Si hay errores, retorna al formulario.

- **Sin parametro `confirmed`:** Muestra pantalla de confirmacion con datos del lote.
- **Con `confirmed=true`:** Persiste la anulacion y redirige a exito.

**GET /anulacion-analisis-ok** - Muestra resultado exitoso

Recibe el LoteDTO via FlashAttributes y muestra los detalles del lote incluyendo el analisis anulado.

**GET /cancelar** - Cancela la operacion

Redirige al home.

### 8.3 Caracteristicas Destacadas

- **Flujo de 3 pasos:** Incluye confirmacion intermedia para operaciones criticas.
- **Parametro confirmed:** Diferencia entre vista previa y persistencia.
- **Flash Attributes:** El resultado se pasa mediante RedirectAttributes.
- **Filtrado de analisis:** Solo muestra analisis sin dictamen (en curso).
- **Fecha automatica:** La fecha de movimiento se setea automaticamente en initModel.
- **Carga de datos del lote:** En confirmacion, carga `loteDTO` para mostrar informacion completa.

---

## 9. SERVICE

### 9.1 Clase: ModifAnulacionAnalisisService

El servicio contiene la logica de negocio del caso de uso. Extiende `AbstractCuService`.

### 9.2 Metodo Principal: persistirAnulacionAnalisis

Este metodo ejecuta toda la operacion en una unica transaccion. El flujo es:

1. **Establecer contexto de auditoria:** Registra "CU11_ANULACION_ANALISIS" para Hibernate Envers.

2. **Obtener usuario actual:** Recupera el usuario autenticado.

3. **Anular Analisis:** Invoca `addAnulacionAnalisis()` que:
   - Busca el analisis por nroAnalisis
   - Establece fechaRealizado (fecha de anulacion)
   - Cambia dictamen a ANULADO

4. **Obtener el Lote:** Obtiene el lote desde el analisis.

5. **Crear Movimiento:** Genera un movimiento de tipo MODIFICACION con motivo ANULACION_ANALISIS usando `MovimientoModificacionUtils`. Registra dictamenInicial (actual) y dictamenFinal = ANULADO.

6. **Restaurar dictamen del Lote:** Busca el movimiento de analisis original y restaura el dictamenInicial al lote.

7. **Formatear motivoDelCambio:** Agrega prefijo `[CU11]`.

8. **Persistir y retornar:** Guarda el lote y retorna el DTO.

### 9.3 Logica de Restauracion de Dictamen

El sistema busca el movimiento de MODIFICACION/ANALISIS original para el nroAnalisis y restaura el `dictamenInicial` de ese movimiento al lote. Esto devuelve el lote al estado anterior al analisis.

### 9.4 Pre-requisitos del Analisis

| Condicion | Descripcion |
|-----------|-------------|
| Activo | El analisis debe estar activo (no eliminado) |
| Sin dictamen o En curso | dictamen = null o != ANULADO |
| Sin duplicados | No deben existir multiples movimientos para el mismo nroAnalisis |

---

## 10. PERSISTENCIA

### 10.1 Entidades Afectadas

| Entidad | Accion | Estado Final |
|---------|--------|--------------|
| Lote | UPDATE | dictamen = dictamenInicial del movimiento original |
| Analisis | UPDATE | dictamen = ANULADO, fechaRealizado = fecha anulacion |
| Movimiento | INSERT | tipo = MODIFICACION, motivo = ANULACION_ANALISIS |

### 10.2 Movimiento Generado

El movimiento de modificacion incluye:

- **tipo:** MODIFICACION
- **motivo:** ANULACION_ANALISIS
- **fecha:** fechaMovimiento del formulario
- **dictamenInicial:** Dictamen actual del lote
- **dictamenFinal:** ANULADO
- **nroAnalisis:** Numero del analisis anulado
- **motivoDelCambio:** Formateado con prefijo `[CU11]`

### 10.3 Cascade y Soft Delete

El Analisis se actualiza explicitamente. El Movimiento se guarda y se agrega a la lista del Lote.

Todas las entidades usan borrado logico.

---

## 11. AUDITORIA (ANMAT)

El sistema cumple con los requerimientos de la Disposicion ANMAT 4159:

- **Hibernate Envers:** Todas las entidades estan auditadas. Cada cambio genera registro en tablas `_aud`.

- **Campo motivoDelCambio:** Obligatorio minimo 20 caracteres (Requerimiento 9 del Anexo 6).

- **Contexto de caso de uso:** "CU11_ANULACION_ANALISIS" se guarda en cada revision.

- **Prefijo de CU:** El motivoDelCambio incluye `[CU11]`.

- **Transicion de dictamen:** Se registra el cambio a ANULADO en el movimiento.

---

## 12. SEGURIDAD

- **CSRF:** Token incluido como campo oculto y en meta tags para AJAX.
- **Autorizacion:** Solo ADMIN o GERENTE_CONTROL_CALIDAD pueden acceder.
- **XSS:** Datos renderizados con escape automatico (th:text).
- **Validacion de analisis:** Impide anular analisis ya anulados o inexistentes.
- **Validacion de duplicados:** Detecta inconsistencias en datos.

---

## 13. MANEJO DE ERRORES

Los errores se manejan en diferentes niveles:

- **Service:** Validaciones de negocio rechazan campos con mensajes descriptivos.
- **Controller:** Errores de validacion se muestran junto a cada campo.
- **AJAX:** Errores de carga de detalles muestran mensaje generico en el info box.
- **Excepciones no controladas:** Redirigen a pagina de error global.

---

## 14. LOGGING

El service registra eventos en los siguientes puntos:

- **Inicio:** `[CU11] Iniciando anulacion de analisis - Usuario: {}, Lote: {}, Analisis: {}`
- **Completado:** `[CU11] Anulacion de analisis completada - Lote: {}, Analisis: {}, Dictamen restaurado: {}, MotivoDelCambio: {}`

Todos los logs usan el prefijo `[CU11]`.

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| ~~MEDIA~~ | ~~Agregar pantalla de confirmacion intermedia para consistencia con otros CUs~~ - **IMPLEMENTADO** |
| BAJA | Validar en frontend que el analisis seleccionado no este ya anulado |

---

*Documento generado: 2025-12-13*
*Ultima actualizacion: 2025-12-26*
*Version: 1.2*