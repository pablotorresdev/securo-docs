# CU30 - BAJA AJUSTE STOCK

**Caso de Uso:** Ajuste de Inventario
**URL Base:** `/contingencias/ajuste-stock`
**Tipo:** BAJA (Ajuste de stock por contingencias)
**Categoria:** Contingencias (color rojo)
**Identificador Interno:** `CU30_AJUSTE_STOCK`

---

## 1. DESCRIPCION

Permite registrar ajustes de inventario por mermas, roturas, perdidas, vencimientos u otras contingencias. El sistema descuenta stock de un bulto especifico, maneja trazas para productos UNIDAD_VENTA, y genera un movimiento de tipo BAJA/AJUSTE.

**Caracteristicas principales:**
- Ajuste a nivel de bulto individual (no multi-bulto)
- Soporte para productos trazados (UNIDAD_VENTA): seleccion de trazas especificas
- Soporte para productos no trazados: ingreso de cantidad y unidad de medida
- Cancela analisis en curso si el lote queda sin stock
- Estado final del bulto: EN_USO o CONSUMIDO (segun cantidad restante)
- Requiere motivo del cambio (ANMAT Disp. 4159 Req. 9)

**Requisito:** El lote debe existir y tener bultos con stock disponible.

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| SUPERVISOR_PLANTA | 3 | Permitido |
| ANALISTA_PLANTA | 2 | Permitido |
| Otros | - | No permitido |

**Anotacion:** `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_SUPERVISOR_PLANTA', 'ROLE_ANALISTA_PLANTA')")`

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. FORMULARIO                                                       |
|     GET /contingencias/ajuste-stock                                 |
|     Template: contingencias/ajuste-stock.html                       |
|  +---------------------------------------------------------------+  |
|  |  Fecha del Ajuste                                              |  |
|  |  Select2: Lote a Ajustar (producto, lote, dictamen)           |  |
|  |  Select: Numero del Bulto (cargado dinamicamente)              |  |
|  |  [Si producto trazado]:                                        |  |
|  |     Checkboxes: Trazas disponibles del bulto                  |  |
|  |  [Si producto NO trazado]:                                     |  |
|  |     Cantidad a ajustar + Unidad de medida                     |  |
|  |  Motivo del cambio (min 20 chars)                             |  |
|  +---------------------------------------------------------------+  |
|  [Cancelar]                                    [Vista Previa] ->     |
+---------------------------------------------------------------------+
                              |
                              | POST /contingencias/ajuste-stock/confirm
                              v
+---------------------------------------------------------------------+
|  2. CONFIRMACION                                                     |
|     POST /contingencias/ajuste-stock/confirm                        |
|     Template: contingencias/ajuste-stock-confirm.html               |
|  +---------------------------------------------------------------+  |
|  |  Vista previa de datos del lote                                |  |
|  |  Producto, Proveedor, Codigo Interno                          |  |
|  |  Fecha del ajuste, Bulto seleccionado                         |  |
|  |  [Si trazado]: Trazas seleccionadas (badges)                  |  |
|  |  [Si NO trazado]: Cantidad y unidad a ajustar                 |  |
|  |  Motivo del cambio                                             |  |
|  +---------------------------------------------------------------+  |
|  [Volver a Editar]                      [Confirmar y Guardar] ->     |
+---------------------------------------------------------------------+
                              |
                              | POST /contingencias/ajuste-stock
                              v
+---------------------------------------------------------------------+
|  3. EXITO                                                            |
|     GET /contingencias/ajuste-stock-ok                              |
|     Template: contingencias/ajuste-stock-ok.html                    |
|  +---------------------------------------------------------------+  |
|  |  Mensaje de exito                                              |  |
|  |  [Si trazado]: Trazas dadas de baja (badges)                  |  |
|  |  Detalles del lote ajustado                                    |  |
|  |  Cantidades por bulto                                          |  |
|  |  Tabla de movimientos                                          |  |
|  +---------------------------------------------------------------+  |
|  [Registrar Otro Ajuste]                      [Volver al Inicio]     |
+---------------------------------------------------------------------+
```

El flujo de 3 pasos incluye confirmacion: formulario -> confirmacion -> persistencia -> exito.

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion |
|---------|-------------|
| `templates/contingencias/ajuste-stock.html` | Formulario |
| `templates/contingencias/ajuste-stock-confirm.html` | Confirmacion |
| `templates/contingencias/ajuste-stock-ok.html` | Exito |

### Backend
| Archivo | Descripcion |
|---------|-------------|
| `controller/cu/ContingenciasController.java` | Controlador (compartido con CU31) |
| `service/cu/BajaAjusteStockService.java` | Servicio |
| `service/cu/AbstractCuService.java` | Clase base |

### Utilidades
| Archivo | Uso en CU30 |
|---------|-------------|
| `utils/MovimientoBajaUtils.java` | Factory para Movimiento BAJA/AJUSTE |
| `utils/UnidadMedidaUtils.java` | Conversion entre unidades |
| `dto/mapper/LoteMapper.java` | Conversion entidad -> DTO |

### DTOs y Entidades
| Archivo | Uso en CU30 |
|---------|-------------|
| `dto/MovimientoDTO.java` | DTO del formulario |
| `dto/LoteDTO.java` | DTO de respuesta |
| `dto/TrazaDTO.java` | Trazas seleccionadas |
| `entity/Lote.java` | Entidad principal |
| `entity/Bulto.java` | Bulto a ajustar |
| `entity/Movimiento.java` | Movimiento generado |
| `entity/DetalleMovimiento.java` | Detalle del movimiento |
| `entity/Traza.java` | Trazas (solo productos trazados) |

### Tests
| Archivo | Descripcion |
|---------|-------------|
| `service/cu/BajaAjusteStockServiceTest.java` | Tests unitarios |

---

## 5. CAMPOS DEL FORMULARIO

### Campos Obligatorios
| Campo | ID HTML | Tipo | Validacion |
|-------|---------|------|------------|
| Fecha del Ajuste | `fechaMovimiento` | date | required, PastOrPresent |
| Lote a Ajustar | `loteAjuste` | select | required |
| Numero del Bulto | `nroBultoAjuste` | select | required |
| Motivo del Cambio | `motivoDelCambio` | textarea | required, minlength=20, maxlength=300 |

### Campos Condicionales (productos NO trazados)
| Campo | ID HTML | Tipo | Validacion |
|-------|---------|------|------------|
| Cantidad a Ajustar | `cantidadBultoElegido` | number | required, min=0.01, step=0.01 |
| Unidad de Medida | `uniMedBultoElegido` | select | required |

### Campos Condicionales (productos trazados)
| Campo | ID HTML | Tipo | Validacion |
|-------|---------|------|------------|
| Trazas | `trazasContainer` checkboxes | checkbox[] | Al menos una seleccionada |

### Campos Hidden (generados dinamicamente)
| Campo | Nombre | Descripcion |
|-------|--------|-------------|
| CSRF Token | `_csrf` | Proteccion CSRF |
| Trazas seleccionadas | `trazaDTOs[n].codigoLote` | Lote de cada traza |
| Trazas seleccionadas | `trazaDTOs[n].nroBulto` | Bulto de cada traza |
| Trazas seleccionadas | `trazaDTOs[n].nroTraza` | Numero de cada traza |
| Cantidad (modo trazas) | `cantidad` | Count de trazas seleccionadas |
| Unidad (modo trazas) | `unidadMedida` | Fijo: "UNIDAD" |

---

## 6. VALIDACIONES POR CAPA

### Frontend (HTML5 + JavaScript)
| Validacion | Implementacion |
|------------|----------------|
| Campos obligatorios | `required` attribute |
| Fecha no futura | HTML5 date type |
| Cantidad positiva | `min="0.01"` |
| Motivo minimo 20 chars | `minlength="20"` |
| Motivo maximo 300 chars | `maxlength="300"` |
| Al menos una traza (si trazado) | JavaScript en submit |

### Bean Validation (MovimientoDTO)
| Campo | Anotacion | Mensaje |
|-------|-----------|---------|
| `fechaMovimiento` | `@NotNull` | La fecha del movimiento es obligatoria |
| `fechaMovimiento` | `@PastOrPresent` | La fecha del movimiento no puede ser futura |
| `motivoDelCambio` | `@NotNull` | El motivo del cambio es obligatorio |
| `motivoDelCambio` | `@Size(min=20)` | El motivo del cambio debe tener al menos 20 caracteres |
| `cantidad` | `@Positive` | La cantidad debe ser mayor a cero |

### Validacion de Negocio (BajaAjusteStockService.validarAjusteStockInput)
| Validacion | Error |
|------------|-------|
| Lote existe | "Lote no encontrado." |
| Motivo del cambio >= 20 chars | "El motivo del cambio es obligatorio (mÃ­nimo 20 caracteres)" |
| Trazas requeridas (si trazado) | "Debe seleccionar al menos una traza a ajustar." |
| Fecha posterior a ingreso lote | Validacion de fecha |
| Bulto existe | "Bulto no encontrado." |
| Cantidad no excede stock | "La cantidad excede el stock disponible del bulto." |
| Unidad compatible | "Unidad no compatible con el producto." |

### Validacion de Negocio (BajaAjusteStockService.bajaAjusteStock)
| Validacion | Error |
|------------|-------|
| Unidad UNIDAD para trazas | "La traza solo es aplicable a UNIDADES" |
| Cantidad entera para trazas | "La cantidad de Unidades debe ser entero" |
| Multi-ajuste no soportado | "Multiajuste no soportado aun" |

---

## 7. TEMPLATE (Frontend)

### Estilo Visual
- **Clase body:** `bg-contingencias`
- **Clase card:** `card-form form-contingencias`
- **Color principal:** `var(--color-contingencias)` (rojo #dc2626)
- **Badge:** "CU Contingencias"

### Librerias
- Bootstrap 5.3.0 (CSS + JS)
- Bootstrap Icons 1.11.0
- jQuery 3.7.1
- Select2 4.1.0-rc.0 (con tema Bootstrap 5)
- common.css (estilos del sistema)

### JavaScript Dinamico
| Funcionalidad | Descripcion |
|---------------|-------------|
| Select2 para lotes | Busqueda mejorada con autocomplete |
| Carga dinamica de bultos | AJAX a `/lotes/ajuste/codigoLote/{codigoLote}` |
| Toggle UI segun tipo producto | Muestra trazas o cantidad/unidad segun `data-trazado` |
| Carga de trazas | AJAX a `/trazas/ajustables/{codigoLote}/{nroBulto}` |
| Carga de subunidades | AJAX a `/enums/subunidades?unidad={base}` |
| Validacion trazas en submit | Verifica al menos una traza seleccionada |
| Generacion hidden fields | Crea inputs para trazaDTOs en submit |
| Prevencion doble submit | Deshabilita boton y muestra spinner |
| Fecha por defecto | Fecha actual (timezone Argentina) |
| Restauracion de valores | Mantiene valores del DTO si hay errores |

### Endpoints AJAX Consumidos
| Endpoint | Metodo | Descripcion |
|----------|--------|-------------|
| `/lotes/ajuste/codigoLote/{codigoLote}` | GET | Obtiene bultos con stock para ajuste |
| `/trazas/ajustables/{codigoLote}/{nroBulto}` | GET | Obtiene trazas ajustables del bulto (DISPONIBLE, DEVUELTO, RECALL) |
| `/enums/subunidades?unidad={base}` | GET | Obtiene unidades compatibles |

---

## 8. CONTROLLER

### ContingenciasController.java

**Endpoints CU30:**
| Metodo | URL | Funcion |
|--------|-----|---------|
| GET | `/contingencias/ajuste-stock` | Muestra formulario |
| POST | `/contingencias/ajuste-stock/confirm` | Valida y muestra confirmacion |
| POST | `/contingencias/ajuste-stock` | Persiste ajuste |
| GET | `/contingencias/ajuste-stock-ok` | Muestra exito |
| GET | `/contingencias/cancelar` | Redirige a home |

### Flujo del Controller

```
showAjusteStockForm (GET)
    |
    +-> @PreAuthorize (roles)
    +-> initModelAjusteStock
    |       +-> loteService.findAllForAjusteDTOs()
    +-> return "contingencias/ajuste-stock"

confirmarAjusteStock (POST /confirm)
    |
    +-> @PreAuthorize (roles)
    +-> @Transactional(readOnly = true)
    +-> @Valid @ModelAttribute MovimientoDTO
    +-> ajusteStockService.validarAjusteStockInput()
    |       +-> Si errores: return "contingencias/ajuste-stock"
    +-> resolverNombresParaConfirmacionAjuste()
    |       +-> loteService.findDTOByCodigoLote()
    |       +-> Setea nombreProducto, codigoProducto, nombreProveedor
    |       +-> Busca y agrega BultoDTO seleccionado
    +-> return "contingencias/ajuste-stock-confirm"

ajusteStock (POST)
    |
    +-> @PreAuthorize (roles)
    +-> @Valid @ModelAttribute MovimientoDTO
    +-> ajusteStockService.validarAjusteStockInput()
    |       +-> Si errores: return template con errores
    +-> procesarAjusteStock()
    |       +-> setFechaYHoraCreacion(now)
    |       +-> ajusteStockService.bajaAjusteStock(dto)
    |       +-> redirectAttributes (loteDTO, bultoAjuste, trazaAjusteDTOs)
    +-> redirect "/contingencias/ajuste-stock-ok"

exitoAjuste (GET)
    |
    +-> @ModelAttribute LoteDTO (from flash)
    +-> return "contingencias/ajuste-stock-ok"
```

### Metodos Auxiliares

**resolverNombresParaConfirmacionAjuste(MovimientoDTO):**
- Busca el lote completo por codigoLote
- Setea campos de visualizacion: nombreProducto, codigoProducto, nombreProveedor
- Busca el BultoDTO correspondiente al nroBulto seleccionado
- Estos campos solo se usan en la vista de confirmacion, no se persisten

### Caracteristicas
- Sin grupo de validacion especifico (usa default)
- Pre-autorizacion en GET y POST (roles verificados)
- Uso de RedirectAttributes para flash attributes
- Pantalla de confirmacion con @Transactional(readOnly=true) para solo lectura

---

## 9. SERVICE

### BajaAjusteStockService.java

**Metodo principal:** `bajaAjusteStock(MovimientoDTO dto)`

### Flujo paso a paso:

```
1. setCasoUsoContext("CU30_AJUSTE_STOCK")
   - Establece contexto para Hibernate Envers

2. getCurrentUser()
   - Obtiene usuario autenticado

3. log.info("[CU30] Iniciando ajuste...")
   - Log con datos de entrada

4. findByCodigoLoteAndActivoTrue(dto.getCodigoLote())
   - Busca lote activo

5. lote.getBultoByNro(parseInt(dto.getNroBulto()))
   - Obtiene bulto especifico

6. persistirMovimientoAjuste(dto, bulto, currentUser)
   - Crea y persiste movimiento BAJA/AJUSTE
   - Usa MovimientoBajaUtils.createMovimientoAjusteStock()

7. Actualizar cantidades:
   - bulto.setCantidadActual(restarMovimientoConvertido)
   - lote.setCantidadActual(restarMovimientoConvertido)

8. Si producto UNIDAD_VENTA (trazado):
   - Valida unidad = UNIDAD
   - Valida cantidad entera
   - Busca trazas correspondientes
   - Marca trazas como CONSUMIDO
   - Asocia trazas al detalle del movimiento

9. Actualizar estados:
   - bulto: EN_USO o CONSUMIDO (segun cantidad restante)
   - lote: CONSUMIDO si todos los bultos consumidos, sino EN_USO

10. Cancelar analisis en curso:
    - Si lote queda sin stock Y tiene analisis sin dictamen
    - Marca analisis como CANCELADO

11. lote.getMovimientos().add(movimiento)
    - Asocia movimiento al lote

12. log.info("[CU30] Ajuste completado...")
    - Log de finalizacion

13. loteRepository.save(lote)
    - Persiste cambios (cascade)

14. return LoteMapper.fromEntity(loteGuardado)
    - Retorna DTO para vista de exito
```

### Metodos auxiliares

**validarAjusteStockInput(MovimientoDTO, BindingResult)**
- Valida errores de binding
- Valida motivoDelCambio (delegado a AbstractCuService)
- Valida existencia del lote
- Valida trazas requeridas (si lote trazado)
- Valida fecha posterior a ingreso
- Valida existencia del bulto
- Valida cantidades del movimiento (delegado a CantidadValidator)

**persistirMovimientoAjuste(MovimientoDTO, Bulto, User)**
- Crea movimiento via MovimientoBajaUtils.createMovimientoAjusteStock()
- Persiste en movimientoRepository

---

## 10. PERSISTENCIA

### Entidades Afectadas

| Entidad | Cambios |
|---------|---------|
| Lote | cantidadActual (resta), estado (EN_USO/CONSUMIDO), movimientos (add) |
| Bulto | cantidadActual (resta), estado (EN_USO/CONSUMIDO) |
| Movimiento | Nuevo registro BAJA/AJUSTE |
| DetalleMovimiento | Nuevo registro (bulto, cantidad, unidad) |
| Traza | estado = CONSUMIDO (solo productos trazados) |
| Analisis | dictamen = CANCELADO (si lote queda sin stock y analisis en curso) |

### Movimiento Generado

| Campo | Valor |
|-------|-------|
| tipoMovimiento | BAJA |
| motivo | AJUSTE |
| fechaYHoraCreacion | OffsetDateTime.now() (set en controller) |
| fecha | fechaMovimiento (del formulario) |
| cantidad | cantidad (del formulario) |
| unidadMedida | unidadMedida (del formulario) |
| codigoMovimiento | `{codigoLote}_B{nroBulto}_{yyMMdd}_{HHmmss}` |
| motivoDelCambio | `[CU30] {texto del usuario}` |
| lote | Lote ajustado |
| creadoPor | Usuario actual |
| activo | true |

### DetalleMovimiento

| Campo | Valor |
|-------|-------|
| movimiento | Movimiento creado |
| bulto | Bulto ajustado |
| cantidad | Cantidad del movimiento |
| unidadMedida | Unidad del movimiento |
| activo | true |
| trazas | Lista de trazas afectadas (solo si trazado) |

---

## 11. AUDITORIA (ANMAT)

### Hibernate Envers
Todas las entidades modificadas se auditan automaticamente:
- Lote_AUD
- Bulto_AUD
- Movimiento_AUD
- DetalleMovimiento_AUD
- Traza_AUD (si aplica)
- Analisis_AUD (si se cancela)

### Contexto del Caso de Uso
```java
setCasoUsoContext("CU30_AJUSTE_STOCK");
```
El identificador se registra en la tabla `revinfo` via `CustomRevisionListener`.

### Motivo del Cambio (ANMAT Disp. 4159 Req. 9)
- Campo obligatorio en formulario
- Minimo 20 caracteres
- Almacenado en `movimiento.motivoDelCambio`
- Formato: `[CU30] {texto del usuario}`
- Visible en tabla de movimientos en pagina de exito

---

## 12. SEGURIDAD

### CSRF
- Token en meta tags del header
- Input hidden en formulario
- Headers CSRF en llamadas AJAX

### Autorizacion
- GET y POST: `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_SUPERVISOR_PLANTA', 'ROLE_ANALISTA_PLANTA')")`
- Roles definidos en `PermisosCasoUsoEnum.CU30_AJUSTE_INVENTARIO`

### Prevencion XSS
- Thymeleaf escapa automaticamente th:text
- No hay th:utext en campos de usuario

### Validacion de Entrada
- Bean Validation en DTO
- Validacion de negocio en service
- Verificacion de existencia de entidades

---

## 13. MANEJO DE ERRORES

### Frontend
| Error | Manejo |
|-------|--------|
| Campos vacios | Validacion HTML5, clase `is-invalid` |
| Sin trazas seleccionadas | JavaScript muestra error inline |
| Lote no seleccionado | Select2 requiere seleccion |

### Controller
| Error | Manejo |
|-------|--------|
| BindingResult errors | Re-render template con errores |
| Validacion service falla | Re-render template con errores |
| Exception inesperada | Pagina de error generica |

### Service
| Error | Excepcion |
|-------|-----------|
| Lote no existe | IllegalArgumentException |
| Bulto no existe | getBultoByNro retorna null (manejado en validacion) |
| Unidad no UNIDAD (trazado) | IllegalStateException |
| Cantidad no entera (trazado) | IllegalStateException |
| Multi-ajuste | IllegalArgumentException |

---

## 14. LOGGING

### Prefijo
Todos los logs usan el prefijo `[CU30]`

### Puntos de Log

| Nivel | Mensaje | Ubicacion |
|-------|---------|-----------|
| INFO | Iniciando ajuste de stock | `bajaAjusteStock()` inicio |
| INFO | Ajuste de stock completado | `bajaAjusteStock()` fin |

### Formato de Log
```
[CU30] Iniciando ajuste de stock - Usuario: {username}, Lote: {codigoLote},
       Bulto: {nroBulto}, Cantidad: {cantidad} {unidadMedida}

[CU30] Ajuste de stock completado - Lote: {codigoLote}, CantidadActual: {cantidad},
       Estado: {estado}, MotivoDelCambio: {motivo}
```

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora | Estado |
|-----------|--------|--------|
| Media | Soporte para multi-ajuste (varios bultos en una operacion) | Pendiente |
| Media | ~~Confirmacion visual antes de submit~~ | **IMPLEMENTADO** (pantalla de confirmacion) |
| Baja | Historial de ajustes por lote (link directo) | Pendiente |
| Baja | Exportar reporte de ajustes a PDF/Excel | Pendiente |
| Baja | Notificacion a supervisores por ajustes significativos | Pendiente |

---

*Documento generado: 2025-12-14*
*Ultima actualizacion: 2025-12-26*
*Version: 1.1*
