# CU23 - ALTA DEVOLUCION VENTA

**Caso de Uso:** Devolucion de Cliente
**URL Base:** `/ventas/alta/devolucion-venta`
**Tipo:** ALTA (Ingreso de stock por devolucion)
**Categoria:** Devoluciones (color rojo)
**Identificador Interno:** `CU23_DEVOLUCION_VENTA`

---

## 1. DESCRIPCION

Permite registrar la devolucion de productos vendidos que regresan del cliente. El sistema crea un nuevo lote derivado con sufijo `_D_N` (donde N es el numero secuencial de devolucion), transfiere las trazas devueltas al nuevo lote marcandolas como DEVUELTO, y genera un movimiento de tipo ALTA/DEVOLUCION.

**Caracteristicas principales:**
- Crea lote derivado con codigo `{codigoLoteOriginal}_D_N`
- Dos modalidades: por trazas (lotes trazados) o por cantidades (lotes no trazados)
- Requiere seleccionar el movimiento de venta original
- Transfiere trazas del lote original al lote de devolucion
- Estado final del lote devuelto: DEVUELTO
- Dictamen del lote devuelto: DEVOLUCION_CLIENTES
- Mantiene genealogia con `loteOrigen`

**Requisito:** El lote debe tener movimientos de venta previos con trazas/cantidades disponibles para devolucion.

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| GERENTE_GARANTIA_CALIDAD | 4 | Permitido |
| Otros | - | No permitido |

**Anotacion:** `@PreAuthorize("hasAnyAuthority('ROLE_ADMIN', 'ROLE_GERENTE_GARANTIA_CALIDAD')")`

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. FORMULARIO                                                       |
|     GET /ventas/alta/devolucion-venta                               |
|     Template: ventas/alta/devolucion-venta.html                     |
|  +---------------------------------------------------------------+  |
|  |  Select2: Lote con ventas                                     |  |
|  |  Select2: Movimiento de venta origen (carga dinamica)         |  |
|  |  Checkboxes: Trazas vendidas (lote trazado)                   |  |
|  |  O Inputs: Cantidades por bulto (lote no trazado)             |  |
|  |  Fecha de devolucion                                          |  |
|  |  Motivo del cambio (min 20 chars)                             |  |
|  +---------------------------------------------------------------+  |
|  [Cancelar]                        [Vista Previa y Confirmar] ->    |
+---------------------------------------------------------------------+
                              |
                              | POST /ventas/alta/devolucion-venta/confirm
                              v
+---------------------------------------------------------------------+
|  2. CONFIRMACION                                                     |
|     GET (via POST) /ventas/alta/devolucion-venta/confirm            |
|     Template: ventas/alta/devolucion-venta-confirm.html             |
|  +---------------------------------------------------------------+  |
|  |  Resumen de datos ingresados                                  |  |
|  |  Lista de trazas o cantidades a devolver                      |  |
|  |  Motivo del cambio                                            |  |
|  +---------------------------------------------------------------+  |
|  [Volver a Editar]                     [Confirmar y Guardar] ->     |
+---------------------------------------------------------------------+
                              |
                              | POST /ventas/alta/devolucion-venta
                              v
+---------------------------------------------------------------------+
|  3. EXITO                                                            |
|     GET /ventas/alta/devolucion-venta-ok                            |
|     Template: ventas/alta/devolucion-venta-ok.html                  |
|  +---------------------------------------------------------------+  |
|  |  Mensaje de exito                                              |  |
|  |  Seccion: Lote Devuelto (NUEVO) - codigo, datos               |  |
|  |  Seccion: Lote Original (ACTUALIZADO)                         |  |
|  |  Trazas devueltas (si aplica)                                 |  |
|  |  Tablas de movimientos de ambos lotes                         |  |
|  +---------------------------------------------------------------+  |
|  [Registrar Otra Devolucion]              [Volver al Inicio]        |
+---------------------------------------------------------------------+
```

El flujo de 3 pasos permite revision antes de persistir: formulario -> confirmacion -> exito.

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `templates/ventas/alta/devolucion-venta.html` | Formulario | 560 |
| `templates/ventas/alta/devolucion-venta-confirm.html` | Confirmacion | 407 |
| `templates/ventas/alta/devolucion-venta-ok.html` | Exito | 388 |

### Backend
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `controller/cu/AltaDevolucionVentaController.java` | Controlador | 145 |
| `service/cu/AltaDevolucionVentaService.java` | Servicio | 322 |
| `service/cu/AbstractCuService.java` | Clase base | - |

### Utilidades
| Archivo | Uso en CU23 |
|---------|-------------|
| `utils/MovimientoAltaUtils.java` | Factory para Movimiento ALTA/DEVOLUCION |
| `utils/DTOUtils.java` | Conversion entidad -> DTO |

### DTOs y Entidades
| Archivo | Uso en CU23 |
|---------|-------------|
| `dto/MovimientoDTO.java` | DTO del formulario |
| `dto/LoteDTO.java` | DTO de respuesta |
| `dto/TrazaDTO.java` | DTO de trazas seleccionadas |
| `dto/DetalleMovimientoDTO.java` | DTO de cantidades por bulto |
| `entity/Lote.java` | Entidad Lote (original y derivado) |
| `entity/Bulto.java` | Entidad Bulto |
| `entity/Movimiento.java` | Entidad Movimiento |
| `entity/DetalleMovimiento.java` | Detalle por bulto |
| `entity/Traza.java` | Entidad Traza |

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Obligatorios

| Campo | HTML ID | Tipo | Validacion Browser | Validacion Server |
|-------|---------|------|-------------------|-------------------|
| Lote | `codigoLote` | select (Select2) | `required` | Existencia verificada |
| Mov. Venta Origen | `movVentaId` | select (Select2) | `required` | Existencia verificada |
| Fecha Devolucion | `fechaMovimiento` | date | `required` | `@NotNull`, `@PastOrPresent` |
| Motivo del Cambio | `motivoDelCambio` | textarea | `required`, `minlength="20"` | `@NotNull`, `@Size(min=20)` |

### 5.2 Condicionales (segun modalidad)

**Lotes Trazados:**
| Campo | HTML ID | Tipo | Validacion |
|-------|---------|------|------------|
| Trazas a devolver | `nrosTrazasDevolver` | checkbox multiple | Al menos 1 seleccionada |

**Lotes No Trazados:**
| Campo | HTML ID | Tipo | Validacion |
|-------|---------|------|------------|
| Cantidades por bulto | `detalleMovimientoDTOs[n].cantidad` | number | min=0, max=maximo disponible |

### 5.3 Campos Ocultos (generados por JavaScript)

| Campo | Proposito |
|-------|-----------|
| `trazaDTOs[n].codigoLote` | Codigo del lote para cada traza |
| `trazaDTOs[n].nroBulto` | Numero de bulto de la traza |
| `trazaDTOs[n].nroTraza` | Numero de traza seleccionada |
| `detalleMovimientoDTOs[n].nroBulto` | Numero de bulto |
| `detalleMovimientoDTOs[n].unidadMedida` | UNIDAD |

---

## 6. VALIDACIONES POR CAPA

### 6.1 CAPA 1: FRONTEND (Browser - HTML5 + JavaScript)

**Ubicacion:** `devolucion-venta.html`

| Campo | Atributo HTML5 | Comportamiento |
|-------|---------------|----------------|
| `codigoLote` | `required` | Bloquea submit si no seleccionado |
| `movVentaId` | `required` | Bloquea submit si no seleccionado |
| `fechaMovimiento` | `required`, `type="date"` | Bloquea submit si vacio |
| `motivoDelCambio` | `required`, `minlength="20"` | Minimo 20 caracteres |
| `nrosTrazasDevolver` | - | JS valida al menos 1 checkbox (modo trazas) |
| `detalleMovimientoDTOs[n].cantidad` | `min="0"`, `max={maximo}` | Rango valido (modo cantidades) |

**JavaScript:**
- Detecta si lote es trazado via `data-trazado` attribute
- Carga dinamica de movimientos de venta via AJAX
- Carga dinamica de trazas vendidas o maximos por bulto segun modalidad
- Valida al menos una traza o cantidad > 0 antes de submit
- Genera inputs hidden con estructura de DTOs

---

### 6.2 CAPA 2: BEAN VALIDATION (Spring)

**Ubicacion:** `dto/MovimientoDTO.java`

| Campo | Anotaciones | Mensaje de Error |
|-------|-------------|------------------|
| fechaMovimiento | `@NotNull`, `@PastOrPresent` | "La fecha del movimiento es obligatoria" / "La fecha del movimiento no puede ser futura" |
| motivoDelCambio | `@NotNull`, `@Size(min=20)` | "El motivo del cambio es obligatorio" / "El motivo del cambio debe tener al menos 20 caracteres" |

---

### 6.3 CAPA 3: VALIDACION DE NEGOCIO (Service Layer)

**Ubicacion:** `AltaDevolucionVentaService.java`

El metodo `validarDevolucionVentaInput()` ejecuta:

| # | Validacion | Descripcion | Mensaje de Error |
|---|-----------|-------------|------------------|
| 1 | validarMotivoDelCambio | Motivo >= 20 chars (ANMAT) | "El motivo del cambio es obligatorio (mínimo 20 caracteres)" |
| 2 | Lote existe | codigoLote existe y esta activo | "Lote no encontrado." |
| 3 | validarFechaMovimientoPosteriorIngresoLote | Fecha >= fechaIngreso | "La fecha del movimiento no puede ser anterior a la fecha de ingreso del lote" |
| 4 | validarTrazasRequeridas | Si trazado, debe tener trazas seleccionadas | "Debe seleccionar al menos una traza." |
| 5 | Movimiento origen existe | codigoMovimientoOrigen existe | "No se encontró el movimiento de venta origen" |
| 6 | validarMovimientoOrigen | Movimiento es de tipo VENTA | "El movimiento de origen debe ser una venta." |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

El formulario utiliza la paleta de colores **devoluciones** (rojo):

- **Fondo de pagina:** `bg-devoluciones`
- **Tarjeta del formulario:** `form-devoluciones`
- **Botones primarios:** `btn-devoluciones`
- **Info box:** Fondo rojo claro (#fee2e2) con borde rojo
- **Checkboxes:** Color rojo cuando seleccionados

### 7.2 Librerias Utilizadas

| Libreria | Proposito |
|----------|-----------|
| Bootstrap 5.3 | Framework CSS |
| Bootstrap Icons | Iconografia |
| jQuery 3.7 | DOM y eventos |
| Select2 | Dropdown con busqueda |
| common.css | Estilos compartidos |

### 7.3 Comportamiento JavaScript

1. **Deteccion de modalidad:** Lee `data-trazado` del option seleccionado.
2. **Carga de movimientos:** GET `/movimientos/movimientos-venta/{codigoLote}`
3. **Carga de trazas (trazado):** GET `/trazas/trazas-vendidas/movimiento/{codigoMov}`
4. **Carga de maximos (no trazado):** GET `/movimientos/devolucion/maximos/{codigoMov}`
5. **Checkbox "Seleccionar todas":** Marca/desmarca todas las trazas.
6. **Validacion pre-submit:** Verifica al menos 1 traza o cantidad > 0.
7. **Generacion de hidden inputs:** Estructura trazaDTOs o detalleMovimientoDTOs.

### 7.3.1 Prevencion de doble submit

```javascript
document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('btnSubmit');
    if (btn) {
        btn.closest('form').addEventListener('submit', function(e) {
            if (btn.disabled) { e.preventDefault(); return; }
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
        });
    }
});
```

### 7.4 Pantalla de Confirmacion

La confirmacion muestra:
- Datos principales (lote, producto, movimiento origen, fecha)
- Tabla de trazas a devolver (modo trazado)
- Tabla de cantidades por bulto (modo no trazado)
- Motivo del cambio

Permite volver a editar conservando todos los datos via hidden inputs.

---

## 8. CONTROLLER

### 8.1 Clase: AltaDevolucionVentaController

El controlador maneja el flujo de 3 pasos y extiende `AbstractCuController`.

### 8.2 Flujo de Endpoints

**GET /devolucion-venta** - Muestra formulario

Carga en el modelo:
- Lotes disponibles (`loteService.findAllForDevolucionDTOs()`)
- MovimientoDTO vacio

**POST /devolucion-venta/confirm** - Valida y muestra confirmacion

Ejecuta validaciones. Si ok, resuelve nombres y muestra pantalla de confirmacion.

**POST /devolucion-venta** - Persiste devolucion

Ejecuta validaciones. Si ok, invoca `persistirDevolucionVenta()` y redirige a exito.

**GET /devolucion-venta-ok** - Muestra resultado exitoso

Recibe via FlashAttributes:
- `loteDevueltoDTO`: Lote nuevo creado
- `loteVentaDTO`: Lote original actualizado
- `movimientoDTO`: Datos del movimiento con trazas

**GET /cancelar** - Cancela

Redirige al home.

### 8.3 Metodo resolverNombresParaConfirmacion

Carga nombre del producto desde el codigo de lote para mostrar en confirmacion.

### 8.4 Filtrado de Lotes

Solo muestra lotes que cumplen (query `findAllForDevolucion`):
- `activo = true`
- `estado <> RECALL`
- Debe tener al menos una de las siguientes condiciones:
  - Trazas con estado `VENDIDO`
  - Movimientos con motivo `VENTA`

```sql
select l from Lote l
where l.activo = true
  and l.estado <> RECALL
  and (
       l.id in (select t.lote.id from Traza t where t.estado = VENDIDO)
       or
       l.id in (select m.lote.id from Movimiento m where m.motivo = VENTA)
  )
order by l.fechaIngreso asc, l.codigoLote asc
```

---

## 9. SERVICE

### 9.1 Clase: AltaDevolucionVentaService

El servicio contiene la logica de negocio. Extiende `AbstractCuService`.

### 9.2 Metodo Principal: persistirDevolucionVenta

Flujo de la operacion:

1. **Establecer contexto de auditoria:** "CU23_DEVOLUCION_VENTA"

2. **Obtener usuario actual**

3. **Cargar Lote original:** Por codigoLote.

4. **Crear Lote de devolucion:** Invoca `crearLoteDevolucion()` con codigo `{original}_D_N`.

5. **Crear Movimiento:** ALTA/DEVOLUCION con referencia al movimiento origen.

6. **Procesar segun modalidad:**
   - **Trazado:** `altaDevolucionUnidadesTrazadas()` - transfiere trazas
   - **No trazado:** `altaDevolucionUnidadesPorBulto()` - crea detalles por cantidad

7. **Persistir y retornar** ambos lotes (devolucion y original)

### 9.3 Metodo: crearLoteDevolucion

Crea el lote derivado con:
- Codigo: `{codigoLoteOriginal}_D_{N}` donde N es secuencial
- `loteOrigen`: Referencia al lote original
- Estado: DEVUELTO
- Dictamen: DEVOLUCION_CLIENTES
- Copia datos del original: producto, proveedor, fabricante, pais, etc.

### 9.4 Metodo: altaDevolucionUnidadesTrazadas

Para lotes trazados:
1. Agrupa trazas seleccionadas por numero de bulto
2. Por cada bulto:
   - Crea DetalleMovimiento
   - Obtiene trazas del bulto original
   - Transfiere trazas al lote/bulto de devolucion
   - Marca trazas como DEVUELTO
   - Vincula trazas al detalle

### 9.5 Metodo: altaDevolucionUnidadesPorBulto

Para lotes no trazados:
1. Por cada bulto del lote de devolucion:
   - Crea DetalleMovimiento con cantidad
   - Acumula cantidad total

---

## 10. PERSISTENCIA

### 10.1 Entidades Afectadas

| Entidad | Accion | Estado Final |
|---------|--------|--------------|
| Lote (nuevo) | INSERT | estado=DEVUELTO, dictamen=DEVOLUCION_CLIENTES |
| Bulto (nuevos) | INSERT | estado=DEVUELTO |
| Movimiento | INSERT | tipo=ALTA, motivo=DEVOLUCION_VENTA |
| DetalleMovimiento | INSERT | Por cada bulto devuelto |
| Traza | UPDATE | estado=DEVUELTO, lote/bulto cambiados (si trazado) |

### 10.2 Movimiento Generado

- **tipo:** ALTA
- **motivo:** DEVOLUCION_VENTA
- **fecha:** fechaMovimiento del formulario
- **cantidad:** Total de unidades devueltas
- **unidadMedida:** UNIDAD
- **movimientoOrigen:** Referencia al movimiento de venta original
- **motivoDelCambio:** Formateado con prefijo `[CU23]`
- **detalles:** Lista de DetalleMovimiento por bulto

### 10.3 Codigo del Lote Derivado

El codigo del lote de devolucion sigue el patron:
```
{codigoLoteOriginal}_D_{N}
```
Donde:
- `D` indica que es una devolucion
- `N` es el numero secuencial de devoluciones del mismo lote (1, 2, 3...)

Ejemplo: Si lote original es `PROD001_2501001`, primera devolucion sera `PROD001_2501001_D_1`.

---

## 11. AUDITORIA (ANMAT)

El sistema cumple con los requerimientos de la Disposicion ANMAT 4159:

- **Hibernate Envers:** Todas las entidades auditadas.
- **Campo motivoDelCambio:** Obligatorio minimo 20 caracteres.
- **Contexto de caso de uso:** "CU23_DEVOLUCION_VENTA"
- **Prefijo de CU:** `[CU23]`
- **Trazabilidad:** Cada traza devuelta queda registrada con estado DEVUELTO y referencia al nuevo lote.
- **Genealogia:** `loteOrigen` mantiene la relacion con el lote original.

---

## 12. SEGURIDAD

- **CSRF:** Token incluido en formularios y meta tags.
- **Autorizacion:** Solo ADMIN o GERENTE_GARANTIA_CALIDAD.
- **XSS:** Escape automatico con th:text.
- **Validacion de movimiento:** Solo movimientos de venta del lote seleccionado.
- **Validacion de cantidades:** No permite devolver mas que lo vendido disponible.

---

## 13. MANEJO DE ERRORES

### Por Capa

| Capa | Tipo de Error | Comportamiento |
|------|--------------|----------------|
| Frontend | HTML5 validation | Bloquea submit, muestra mensaje |
| Frontend | JS validation | Muestra error si no hay trazas/cantidades |
| Bean Validation | @NotNull, @Size | Muestra junto al campo |
| Service | Lote no existe | Excepcion IllegalArgumentException |
| Service | Movimiento origen no existe | Excepcion IllegalArgumentException |
| Service | Trazas requeridas | Error en bindingResult |

---

## 14. LOGGING

El service registra:

- **Inicio:** `[CU23] Iniciando devolucion de venta - Usuario: {}, Lote: {}, MovimientoOrigen: {}`
- **Completado:** `[CU23] Devolucion de venta completada - LoteDevolucion: {}, Cantidad: {}, MotivoDelCambio: {}`

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| BAJA | Agregar validacion de cantidad maxima devolvible en frontend |

---

## 16. ERRORES ENCONTRADOS EN REVISION

### 16.1 Badge incorrecto en formulario
- **Archivo:** `devolucion-venta.html` linea 60
- **Problema:** Badge dice "CU Devolucion" en lugar de "CU23"
- **Impacto:** Solo visual/consistencia
- **Estado:** Corregido

### 16.2 Badge incorrecto en exito
- **Archivo:** `devolucion-venta-ok.html` linea 190
- **Problema:** Badge dice "CU Devolucion de Cliente" en lugar de "CU23"
- **Impacto:** Solo visual/consistencia
- **Estado:** Corregido

---

*Documento generado: 2025-12-13*
*Version: 1.0*
