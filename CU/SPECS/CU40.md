# CU40 - ABM PROVEEDORES

**Caso de Uso:** ABM Proveedores
**URL Base:** `/proveedores/`
**Tipo:** ABM (Alta, Baja, Modificacion de datos maestros)
**Categoria:** ABM Maestro (color gris/neutro)
**Identificador Interno:** `CU40_ABM_PROVEEDORES`

---

## 1. DESCRIPCION

Permite la gestion completa (CRUD) de proveedores/fabricantes del sistema. Los proveedores son entidades maestras utilizadas en las operaciones de ingreso de mercaderia (compras y produccion).

**Caracteristicas principales:**
- Alta de nuevos proveedores con datos de empresa, ubicacion y contacto
- Edicion de proveedores existentes
- Baja logica (soft delete) de proveedores (activo = false)
- Listado con filtros por columna y exportacion a Excel
- Auditoria automatica via Hibernate Envers
- DataTables para navegacion y busqueda eficiente

**Proveedor especial:** El sistema contiene un proveedor interno "CONIFARMA" que se excluye de los listados de proveedores externos.

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| ANALISTA_PLANTA | 2 | Permitido |
| Otros | - | No permitido |

**Configuracion:** Permisos definidos en `PermisosCasoUsoEnum.CU40_ABM_PROVEEDORES` con patron URL `/proveedores/**`.

**Nota:** Este CU no utiliza `@PreAuthorize` a nivel de metodo. La autorizacion se maneja via `SecurityConfig` usando el enum de permisos.

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. LISTADO                                                          |
|     GET /proveedores/list-proveedores                               |
|     Template: proveedores/list-proveedores.html                     |
|  +---------------------------------------------------------------+  |
|  |  DataTable con proveedores                                     |  |
|  |  Filtros por columna                                           |  |
|  |  Exportacion a Excel                                           |  |
|  |  Acciones: Editar / Eliminar                                   |  |
|  +---------------------------------------------------------------+  |
|  [Agregar Proveedor]                        [Volver al Inicio]      |
+---------------------------------------------------------------------+
         |                    |                        |
         | click Agregar      | click Editar           | click Eliminar
         v                    v                        v
+-------------------+  +-------------------+  +-------------------+
|  2. ALTA          |  |  3. EDICION       |  |  4. ELIMINACION   |
|  GET /add-proveedor|  |  GET /edit/{id}  |  |  POST /delete     |
|  Template: add-    |  |  Template: edit- |  |  (confirm dialog) |
|  proveedor.html    |  |  proveedor.html  |  |  -> Soft delete   |
+-------------------+  +-------------------+  +-------------------+
         |                    |                        |
         | POST               | POST                   |
         v                    v                        v
+---------------------------------------------------------------------+
|                     REDIRECT -> LISTADO                              |
+---------------------------------------------------------------------+
```

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion |
|---------|-------------|
| `templates/proveedores/list-proveedores.html` | Listado con DataTables |
| `templates/proveedores/add-proveedor.html` | Formulario de alta |
| `templates/proveedores/edit-proveedor.html` | Formulario de edicion |

### Backend
| Archivo | Descripcion |
|---------|-------------|
| `controller/maestro/ABMProveedoresController.java` | Controlador |
| `service/maestro/ProveedorService.java` | Servicio |
| `repository/maestro/ProveedorRepository.java` | Repositorio |
| `entity/maestro/Proveedor.java` | Entidad |

### Tests
| Archivo | Descripcion |
|---------|-------------|
| `test/controller/maestro/ABMProveedoresControllerTest.java` | Tests unitarios |

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Obligatorios

| Campo | HTML ID | Tipo | Validacion Browser | Validacion Server |
|-------|---------|------|-------------------|-------------------|
| Razon Social | `razonSocial` | text | `required` | `@Column(nullable=false)` |
| CUIT | `cuit` | text | `required` | `@Column(nullable=false)` |
| Direccion | `direccion` | text | `required` | `@Column(nullable=false)` |
| Ciudad | `ciudad` | text | `required` | `@Column(nullable=false, length=100)` |
| Pais | `pais` | text | `required` | `@Column(nullable=false, length=100)` |

### 5.2 Opcionales

| Campo | HTML ID | Tipo | Validacion Server |
|-------|---------|------|-------------------|
| Telefono | `telefono` | text | `@Column(length=50)` |
| Email | `email` | email | `@Column(length=100)` |
| Contacto | `contacto` | text | `@Column(length=100)` |
| Detalles | `detallesProveedor` | textarea | `@Column(length=300)` |

### 5.3 Campos Ocultos (solo en edicion)

| Campo | Proposito |
|-------|-----------|
| `id` | ID del proveedor a editar |
| `_csrf` | Token CSRF |

---

## 6. VALIDACIONES POR CAPA

### 6.1 CAPA 1: FRONTEND (Browser - HTML5)

**Ubicacion:** `add-proveedor.html`, `edit-proveedor.html`

| Campo | Atributo HTML5 | Comportamiento |
|-------|---------------|----------------|
| `razonSocial` | `required` | Bloquea submit si vacio |
| `cuit` | `required` | Bloquea submit si vacio |
| `direccion` | `required` | Bloquea submit si vacio |
| `ciudad` | `required` | Bloquea submit si vacio |
| `pais` | `required` | Bloquea submit si vacio |
| `email` | `type="email"` | Valida formato email |

---

### 6.2 CAPA 2: BEAN VALIDATION (JPA/Hibernate)

**Ubicacion:** `entity/maestro/Proveedor.java`

La entidad usa validaciones a nivel de columna JPA (`nullable=false`). Spring valida con `@Valid` en el controller.

| Campo | Constraint | Comportamiento |
|-------|------------|----------------|
| razonSocial | `nullable=false` | Error si null/vacio |
| cuit | `nullable=false` | Error si null/vacio |
| direccion | `nullable=false` | Error si null/vacio |
| ciudad | `nullable=false, length=100` | Error si null o > 100 chars |
| pais | `nullable=false, length=100` | Error si null o > 100 chars |

---

### 6.3 CAPA 3: VALIDACION DE NEGOCIO (Controller Layer)

**Ubicacion:** `ABMProveedoresController.java`

| Metodo | Validacion | Descripcion |
|--------|-----------|-------------|
| `addProveedor` | BindingResult | Verifica errores de binding |
| `editProveedor` | Existencia | Verifica que proveedor existe antes de actualizar |
| `deleteProveedor` | Existencia | Verifica que proveedor existe antes de eliminar |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

Los formularios utilizan la paleta de colores **ABM** (gris/neutro):

- **Fondo de pagina:** `bg-abm`
- **Tarjeta del formulario:** `form-abm`
- **Titulos de seccion:** `section-title-abm`
- **Botones primarios:** `btn-abm`
- **Badge:** Estilo ABM con `var(--color-abm)`

### 7.2 Librerias Utilizadas

| Libreria | Proposito |
|----------|-----------|
| Bootstrap 5.3 | Framework CSS |
| Bootstrap Icons | Iconografia |
| jQuery 3.7 | DOM y eventos (solo listado) |
| DataTables 1.13.8 | Tabla interactiva con filtros |
| DataTables Buttons | Exportacion a Excel |
| JSZip | Soporte para exportacion Excel |
| common.css | Estilos compartidos |

### 7.3 Comportamiento JavaScript

**En list-proveedores.html:**

1. **DataTables:** Inicializa tabla con paginacion (25 por defecto), ordenamiento y busqueda.
2. **Filtros por columna:** Inputs en cada cabecera para filtrar contenido.
3. **Exportacion Excel:** Boton para exportar todas las columnas excepto acciones.
4. **Lenguaje:** Internacionalizacion en espanol (es-ES).
5. **Confirmacion eliminacion:** Dialog confirm nativo antes de DELETE.

```javascript
$('#proveedoresTable').DataTable({
    orderCellsTop: true,
    fixedHeader: true,
    pageLength: 25,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
    language: { url: '//cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' },
    order: [[0, 'asc']],
    dom: 'Blfrtip',
    buttons: [{ extend: 'excelHtml5', ... }],
    columnDefs: [{ orderable: false, targets: -1 }]
});
```

**En add-proveedor.html y edit-proveedor.html:**
- Sin JavaScript adicional, solo Bootstrap para modales de alerta.

---

## 8. CONTROLLER

### 8.1 Clase: ABMProveedoresController

Controlador simple para CRUD de proveedores. No extiende AbstractCuController ya que no es un caso de uso operacional.

**Ubicacion:** `controller/maestro/ABMProveedoresController.java`

### 8.2 Endpoints

| Metodo | URL | Accion |
|--------|-----|--------|
| GET | `/proveedores/` | Redirect a listado |
| GET | `/proveedores/list-proveedores` | Muestra listado |
| GET | `/proveedores/add-proveedor` | Muestra formulario alta |
| POST | `/proveedores/add-proveedor` | Procesa alta |
| GET | `/proveedores/edit-proveedor/{id}` | Muestra formulario edicion |
| POST | `/proveedores/edit-proveedor/{id}` | Procesa edicion |
| POST | `/proveedores/delete-proveedor` | Procesa eliminacion (soft delete) |

### 8.3 Flujo de Endpoints

**GET /list-proveedores** - Muestra listado
```java
model.addAttribute("proveedores", proveedorService.findAllByOrderByRazonSocialAsc());
return "proveedores/list-proveedores";
```

**POST /add-proveedor** - Procesa alta
```java
if (result.hasErrors()) {
    return "proveedores/add-proveedor"; // Vuelve al formulario
}
proveedor.setActivo(true);
proveedorService.save(proveedor);
return "redirect:/proveedores/list-proveedores";
```

**POST /edit-proveedor/{id}** - Procesa edicion
```java
if (bindingResult.hasErrors()) {
    return "proveedores/edit-proveedor";
}
if (originalOpt.isEmpty()) {
    redirectAttributes.addFlashAttribute("error", "Proveedor not found!");
    return "redirect:/proveedores/list-proveedores";
}
proveedor.setId(id);
proveedor.setActivo(true);
proveedorService.save(proveedor);
return "redirect:/proveedores/list-proveedores";
```

**POST /delete-proveedor** - Procesa eliminacion
```java
proveedor.setActivo(false); // Soft delete
proveedorService.save(proveedor);
return "redirect:/proveedores/list-proveedores";
```

---

## 9. SERVICE

### 9.1 Clase: ProveedorService

Servicio simple que encapsula operaciones del repositorio.

**Ubicacion:** `service/maestro/ProveedorService.java`

### 9.2 Metodos

| Metodo | Descripcion |
|--------|-------------|
| `findAllByOrderByRazonSocialAsc()` | Lista todos los proveedores ordenados por razon social |
| `findById(Long id)` | Busca proveedor por ID |
| `save(Proveedor proveedor)` | Guarda o actualiza proveedor |
| `getProveedoresExternos()` | Lista proveedores externos (excluye CONIFARMA) |
| `getConifarma()` | Obtiene el proveedor interno CONIFARMA |

### 9.3 Consultas Especiales

**findProveedoresExternosOrderByRazonSocialAsc:**
```sql
SELECT p FROM Proveedor p
WHERE p.activo = true
  AND lower(p.razonSocial) NOT LIKE '%conifarma%'
ORDER BY p.razonSocial ASC
```

**findConifarma:**
```sql
SELECT p FROM Proveedor p
WHERE lower(p.razonSocial) LIKE '%conifarma%'
ORDER BY p.id ASC
```

---

## 10. PERSISTENCIA

### 10.1 Entidades Afectadas

| Entidad | Operacion | Descripcion |
|---------|-----------|-------------|
| Proveedor | INSERT | Alta de nuevo proveedor |
| Proveedor | UPDATE | Edicion de proveedor existente |
| Proveedor | UPDATE (soft delete) | activo = false |

### 10.2 Tabla de Base de Datos

**Tabla:** `proveedores`

| Columna | Tipo | Nullable | Descripcion |
|---------|------|----------|-------------|
| id | BIGINT | NO | PK, auto-generado |
| razon_social | VARCHAR | NO | Nombre de la empresa |
| cuit | VARCHAR | NO | CUIT/Identificador fiscal |
| direccion | VARCHAR | NO | Direccion completa |
| ciudad | VARCHAR(100) | NO | Ciudad |
| pais | VARCHAR(100) | NO | Pais |
| telefono | VARCHAR(50) | SI | Telefono de contacto |
| email | VARCHAR(100) | SI | Email de contacto |
| contacto | VARCHAR(100) | SI | Persona de contacto |
| detalles_proveedor | VARCHAR(300) | SI | Notas adicionales |
| activo | BOOLEAN | NO | Flag de soft delete |

### 10.3 Soft Delete

La entidad usa `@SQLDelete` para implementar borrado logico:

```java
@SQLDelete(sql = "UPDATE proveedores SET activo = false WHERE id = ?")
public class Proveedor { ... }
```

---

## 11. AUDITORIA (ANMAT)

El sistema cumple con los requerimientos de la Disposicion ANMAT 4159:

- **Hibernate Envers:** La entidad esta anotada con `@Audited`.
- **Tabla de auditoria:** `proveedores_AUD`
- **Revision info:** Cada cambio queda registrado con timestamp y usuario.

**Nota:** Este CU no requiere campo `motivoDelCambio` ya que es ABM de datos maestros, no una operacion sobre lotes.

---

## 12. SEGURIDAD

### 12.1 Autorizacion

- **Configuracion:** Via `SecurityConfig` usando `PermisosCasoUsoEnum`.
- **Patron URL:** `/proveedores/**`
- **Roles:** ADMIN, ANALISTA_PLANTA

### 12.2 CSRF

Token CSRF incluido en todos los formularios:
```html
<input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>
```

### 12.3 XSS

- Escape automatico con `th:text` en templates.
- No se usa `th:utext` (HTML sin escape).

### 12.4 Validacion de Entrada

- Campos obligatorios validados en frontend y backend.
- Longitudes maximas definidas en entidad (`length=100`, etc.).

---

## 13. MANEJO DE ERRORES

### Por Capa

| Capa | Tipo de Error | Comportamiento |
|------|--------------|----------------|
| Frontend | HTML5 validation | Bloquea submit, muestra mensaje nativo |
| Bean Validation | Constraint violation | Muestra error en formulario |
| Controller | Proveedor no encontrado | Flash attribute con mensaje de error |
| Controller | BindingResult errors | Retorna al formulario con errores |

### Mensajes de Error

| Situacion | Mensaje |
|-----------|---------|
| Proveedor no existe (edit) | "Proveedor no encontrado!" |
| Proveedor no existe (delete) | "Proveedor no encontrado!" |
| Validacion fallida (add) | "Validacion fallida!" |
| Exito (edit) | "Proveedor actualizado exitosamente!" |

---

## 14. LOGGING

Este CU no implementa logging especifico en el service. La auditoria se maneja via Hibernate Envers automaticamente.

**Puntos de auditoria automatica:**
- INSERT: Envers captura la creacion
- UPDATE: Envers captura los cambios
- SOFT DELETE: Envers captura el cambio de activo=false

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| MEDIA | Agregar validacion de formato CUIT (XX-XXXXXXXX-X) |
| MEDIA | Agregar validacion de unicidad de CUIT |
| BAJA | Agregar validacion de formato email en backend |
| BAJA | Agregar prevencion de doble submit en formularios |
| BAJA | Agregar logging especifico del CU |
| BAJA | Mostrar historial de cambios (audit trail) en vista de detalle |

---

## 16. TESTS

El controlador cuenta con tests unitarios completos:

| Test | Descripcion |
|------|-------------|
| `testProveedoresPage` | Verifica redirect a listado |
| `testListProveedores` | Verifica carga de lista |
| `testShowAddProveedorForm` | Verifica formulario de alta |
| `testAddProveedor_Success` | Verifica alta exitosa |
| `testAddProveedor_ValidationErrors` | Verifica manejo de errores |
| `testShowEditProveedorForm_Found` | Verifica carga de formulario edicion |
| `testShowEditProveedorForm_NotFound` | Verifica manejo de proveedor inexistente |
| `testEditProveedor_Success` | Verifica edicion exitosa |
| `testEditProveedor_ValidationErrors` | Verifica manejo de errores |
| `testDeleteProveedor_Success` | Verifica soft delete exitoso |
| `testDeleteProveedor_NotFound` | Verifica manejo de proveedor inexistente |
| `testEditProveedor_NotFoundAfterValidation` | Verifica race condition |

**Cobertura:** 12 tests cubriendo todos los branches del controller.

---

*Documento generado: 2025-12-14*
*Version: 1.0*
