# CU41 - ABM PRODUCTOS

**Caso de Uso:** Alta/Baja/Modificacion de Productos (Datos Maestros)
**URL Base:** `/productos`
**Tipo:** ABM (Alta, Baja logica, Modificacion)
**Categoria:** ABM Maestros (color gris/neutro)
**Identificador Interno:** `CU41_ABM_PRODUCTOS`

---

## 1. DESCRIPCION

Permite gestionar el catalogo de **Productos** del sistema. Los productos son datos maestros fundamentales que definen los materiales que pueden ser ingresados, consumidos, producidos y vendidos en el sistema de gestion de lotes farmaceuticos.

**Caracteristicas principales:**
- CRUD completo de productos (Create, Read, Update, Soft Delete)
- 10 tipos de producto en 4 grupos (MatPrima, MatAcond, SemiElab, UniVenta)
- Validacion de unicidad por combinacion (nombre + codigo + tipo)
- Campo condicional: producto destino segun tipo de producto
- Borrado logico (soft delete) con `activo = false`
- Auditoria automatica via Hibernate Envers

**Tipos de Producto:**
| Grupo | Tipos | Requiere Producto Destino |
|-------|-------|---------------------------|
| Materia Prima | API, EXCIPIENTE | API: SI, EXCIPIENTE: NO |
| Acondicionamiento | ACOND_PRIMARIO, ACOND_SECUNDARIO | ACOND_SECUNDARIO: SI |
| Semielaborados | SEMIELABORADO, GRANEL_* (4 tipos) | Todos: SI |
| Producto Final | UNIDAD_VENTA | NO |

---

## 2. ROLES AUTORIZADOS

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| GERENTE_CONTROL_CALIDAD | 3 | Permitido |
| Otros | - | No permitido |

**Configuracion de seguridad:** Controlado via `SecurityConfig.java` usando `PermisosCasoUsoEnum.CU41_ABM_PRODUCTOS` (linea 154-158)

**Referencia:** `PermisosCasoUsoEnum.CU41_ABM_PRODUCTOS`:
```java
CU41_ABM_PRODUCTOS(
    "ABM Productos",
    "/productos/",
    Arrays.asList(RoleEnum.ADMIN, RoleEnum.GERENTE_CONTROL_CALIDAD)
)
```

**Nota:** No usa `@PreAuthorize` en el controller; la autorizacion se configura dinamicamente en `SecurityConfig` lineas 63-66.

---

## 3. FLUJO DE PANTALLAS

```
+---------------------------------------------------------------------+
|  1. LISTADO                                                          |
|     GET /productos/list-productos                                    |
|     Template: productos/list-productos.html                          |
|  +---------------------------------------------------------------+  |
|  |  DataTable con filtros por columna                            |  |
|  |  Columnas: Codigo, Nombre, Tipo, Unidad, Destino, Detalles    |  |
|  |  Botones: [Agregar Producto] [Editar] [Eliminar]              |  |
|  +---------------------------------------------------------------+  |
|  [Agregar Producto] -> (2)    [Editar] -> (3)    [Eliminar] -> POST |
+---------------------------------------------------------------------+
                |                      |
                v                      v
+-----------------------------------+ +-----------------------------------+
|  2. ALTA                          | |  3. EDICION                       |
|  GET /productos/add-producto      | |  GET /productos/edit-producto/{id}|
|  +-----------------------------+  | |  +-----------------------------+  |
|  |  Codigo Producto            |  | |  |  Codigo Producto (editable) |  |
|  |  Nombre Generico            |  | |  |  Nombre Generico            |  |
|  |  Tipo Producto (select)     |  | |  |  Tipo Producto (select)     |  |
|  |  Unidad Medida (select)     |  | |  |  Unidad Medida (select)     |  |
|  |  Producto Destino           |  | |  |  Producto Destino           |  |
|  |  Detalles (textarea)        |  | |  |  Detalles (textarea)        |  |
|  +-----------------------------+  | |  +-----------------------------+  |
|  [Cancelar]    [Guardar] ->       | |  [Cancelar]    [Guardar] ->       |
+-----------------------------------+ +-----------------------------------+
                |                                     |
                +----------> Redirect /list <---------+
```

**Flujo de Baja:**
```
[Listado] -> [Click Eliminar] -> confirm() -> POST /delete-producto
                                                     |
                                                     v
                                            Soft Delete (activo=false)
                                                     |
                                                     v
                                           Redirect /list-productos
```

---

## 4. ARCHIVOS INVOLUCRADOS

### Frontend (Templates)
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `templates/productos/list-productos.html` | Listado con DataTable | 177 |
| `templates/productos/add-producto.html` | Formulario de alta | 121 |
| `templates/productos/edit-producto.html` | Formulario de edicion | 122 |

### Backend
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `controller/maestro/ABMProductosController.java` | Controlador ABM | 173 |
| `service/maestro/ProductoService.java` | Servicio de negocio | 38 |
| `repository/maestro/ProductoRepository.java` | Repositorio JPA | 46 |
| `entity/maestro/Producto.java` | Entidad JPA | 63 |

### Enums
| Archivo | Uso en CU41 |
|---------|-------------|
| `enums/TipoProductoEnum.java` | 10 tipos de producto | 42 |
| `enums/UnidadMedidaEnum.java` | Unidades de medida |
| `enums/PermisosCasoUsoEnum.java` | Roles autorizados (linea 154-158) |

### Tests
| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `controller/maestro/ABMProductosControllerTest.java` | Tests del controller | 421 |
| `service/maestro/ProductoServiceTest.java` | Tests del servicio |

**Total lineas de codigo principal:** 691

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Obligatorios

| Campo | HTML ID | Tipo | Validacion Browser | Validacion Server |
|-------|---------|------|-------------------|-------------------|
| Codigo Producto | `codigoProducto` | text | `required` | `@Column(nullable=false)`, max 50 chars |
| Nombre Generico | `nombreGenerico` | text | `required` | `@Column(nullable=false)` |
| Tipo Producto | `tipoProducto` | select | `required` | `@Enumerated`, `@Column(nullable=false)` |
| Unidad Medida | `unidadMedida` | select | `required` | `@Enumerated`, `@Column(nullable=false)` |

### 5.2 Campos Condicionales

| Campo | Condicion | Comportamiento |
|-------|-----------|----------------|
| `productoDestino` | Tipo requiere destino | Obligatorio si `TipoProductoEnum.isRequiereProductoDestino()` = true |

Tipos que requieren producto destino:
- API
- ACOND_SECUNDARIO
- SEMIELABORADO
- GRANEL_MEZCLA_POLVO
- GRANEL_CAPSULAS
- GRANEL_COMPRIMIDOS
- GRANEL_FRASCOS

### 5.3 Campos Opcionales

| Campo | HTML ID | Tipo |
|-------|---------|------|
| Detalles Producto | `detallesProducto` | textarea |

### 5.4 Campos Hidden

| Campo | Valor |
|-------|-------|
| `_csrf` | Token CSRF |
| `id` | ID del producto (solo en edicion) |

### 5.5 Campos Automaticos

| Campo | Valor | Momento |
|-------|-------|---------|
| `activo` | true | Alta y Edicion |
| `activo` | false | Baja (soft delete) |

---

## 6. VALIDACIONES POR CAPA

### 6.1 CAPA 1: FRONTEND (Browser - HTML5)

**Ubicacion:** `templates/productos/add-producto.html`, `templates/productos/edit-producto.html`

| Campo | Atributo HTML5 | Comportamiento |
|-------|---------------|----------------|
| `codigoProducto` | `required` | Bloquea submit si vacio |
| `nombreGenerico` | `required` | Bloquea submit si vacio |
| `tipoProducto` | `required` | Bloquea submit si no seleccionado |
| `unidadMedida` | `required` | Bloquea submit si no seleccionado |

**Nota:** No hay JavaScript dinamico para el campo producto destino. La validacion condicional se realiza en el servidor.

---

### 6.2 CAPA 2: BEAN VALIDATION (Entity Layer)

**Ubicacion:** `entity/maestro/Producto.java`

| Campo | Anotaciones JPA | Efecto |
|-------|-----------------|--------|
| nombreGenerico | `@Column(nullable=false)` | Constraint NOT NULL en DB |
| codigoProducto | `@Column(nullable=false, length=50, unique=true)` | NOT NULL, max 50 chars, unico |
| tipoProducto | `@Column(nullable=false)` | NOT NULL |
| unidadMedida | `@Column(nullable=false)` | NOT NULL |

**Constraint de Unicidad (linea 30-32):**
```java
@Table(name = "productos", uniqueConstraints = @UniqueConstraint(
    columnNames = { "nombre_generico", "codigo_producto", "tipo_producto" }
))
```

---

### 6.3 CAPA 3: VALIDACION DE NEGOCIO (Controller Layer)

**Ubicacion:** `ABMProductosController.java`

El controller ejecuta las siguientes validaciones:

| # | Metodo | Validacion | Mensaje de Error |
|---|--------|-----------|------------------|
| 1 | addProducto | BindingResult errors | "Validacion fallida!" |
| 2 | addProducto | Producto destino requerido | "Indique el producto destino para este tipo de producto." |
| 3 | editProducto | BindingResult errors | (re-render formulario) |
| 4 | editProducto | Producto destino requerido | "Indique el producto destino para este tipo de producto." |
| 5 | editProducto | Producto no existe | "Producto no encontrado!" |
| 6 | showEditProductoForm | Producto no existe | "Producto no encontrado" |
| 7 | showEditProductoForm | Producto inactivo | "Producto inactivo" |
| 8 | deleteProducto | Producto no existe | "Producto no encontrado" |
| 9 | deleteProducto | Producto ya inactivo | "Producto ya esta inactivo" |

**Logica de producto destino (lineas 68-80, 121-133):**
```java
if (tipoProducto.isRequiereProductoDestino()) {
    if (StringUtils.isEmptyOrWhitespace(producto.getProductoDestino())) {
        bindingResult.rejectValue("productoDestino", "error.productoDestino",
            "Indique el producto destino para este tipo de producto.");
        // ...
    }
} else {
    producto.setProductoDestino(null);
}
```

---

### 6.4 RESUMEN DE VALIDACIONES POR CAMPO

| Campo | Frontend | Bean/JPA | Negocio |
|-------|----------|----------|---------|
| codigoProducto | required | NOT NULL, max 50 | - |
| nombreGenerico | required | NOT NULL | - |
| tipoProducto | required | NOT NULL | - |
| unidadMedida | required | NOT NULL | - |
| productoDestino | - | - | Condicional segun tipo |
| (unicidad) | - | UniqueConstraint | Constraint DB |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

El formulario utiliza la paleta de colores **ABM** (gris/neutro):

- **Fondo de pagina:** `bg-abm`
- **Tarjeta del formulario:** `card-form form-abm` con borde `var(--color-abm)`
- **Botones primarios:** `btn-custom-primary btn-abm`
- **Section titles:** `section-title section-title-abm`
- **Badge:** "ABM" con fondo `var(--color-abm)`

### 7.2 Librerias Utilizadas

| Libreria | Proposito |
|----------|-----------|
| Bootstrap 5.3 | Framework CSS base, grid responsivo |
| Bootstrap Icons 1.11 | Iconografia en todo el formulario |
| DataTables 1.13.8 | Tabla con paginacion, filtros, exportacion |
| jQuery 3.7 | Dependencia de DataTables |
| common.css | Estilos compartidos del sistema |

### 7.3 Listado - Funcionalidades DataTable

**Configuracion (`list-productos.html` lineas 139-172):**

- Filtros por columna (inputs en cabecera)
- Paginacion: 10, 25, 50, 100, Todos
- Idioma: Espanol (es-ES)
- Ordenamiento por codigo (ASC por defecto)
- Boton de exportacion a Excel (excluye columna acciones)
- Columna acciones no ordenable

### 7.4 Comportamiento JavaScript

**Listado:**
- DataTable con filtros individuales por columna
- Confirmacion de eliminacion via `confirm()`

**Formularios:**
- Sin JavaScript dinamico para producto destino
- Validacion HTML5 nativa

### 7.5 Iconografia Bootstrap Icons

| Icono | Uso |
|-------|-----|
| `bi-box-seam` | Header de gestion de productos |
| `bi-plus-circle` | Boton agregar |
| `bi-pencil` | Boton editar |
| `bi-trash` | Boton eliminar |
| `bi-upc-scan` | Campo codigo producto |
| `bi-card-text` | Campo nombre generico |
| `bi-tags` | Campo tipo producto |
| `bi-rulers` | Campo unidad medida |
| `bi-arrow-right-circle` | Campo producto destino |
| `bi-chat-left-text` | Campo detalles |
| `bi-check-circle` | Boton guardar |
| `bi-x-circle` | Boton cancelar |

---

## 8. CONTROLLER

### 8.1 Clase: ABMProductosController

El controller maneja el CRUD completo de productos. No extiende ninguna clase base.

**Path:** `controller/maestro/ABMProductosController.java`
**Request Mapping:** `/productos`

### 8.2 Endpoints

| Metodo | URL | Descripcion |
|--------|-----|-------------|
| GET | /productos/ | Redirect a list-productos |
| GET | /productos/list-productos | Muestra listado |
| GET | /productos/add-producto | Muestra formulario alta |
| POST | /productos/add-producto | Procesa alta |
| GET | /productos/edit-producto/{id} | Muestra formulario edicion |
| POST | /productos/edit-producto/{id} | Procesa edicion |
| POST | /productos/delete-producto | Procesa baja (soft delete) |

### 8.3 Modelo en GET

**Listado:**
- `productos`: Lista de productos activos ordenados por codigo

**Alta:**
- `producto`: Instancia nueva de Producto
- `productosDestino`: Lista de productos internos (semielaborados + UV)

**Edicion:**
- `producto`: Producto existente
- `productosDestino`: Lista de productos internos

### 8.4 Caracteristicas Destacadas

- **Inyeccion de dependencias:** Solo `ProductoService` via `@Autowired`
- **Soft Delete:** La baja marca `activo = false`, no elimina fisicamente
- **Validacion condicional:** Producto destino obligatorio segun tipo
- **Flash attributes:** Mensajes de exito/error via `RedirectAttributes`
- **Envers:** Comentarios indican que la auditoria es automatica

### 8.5 Flujo de Alta (addProducto)

1. Verificar errores de BindingResult
2. Establecer `activo = true`
3. Verificar si tipo requiere producto destino
4. Si requiere y esta vacio: rechazar con error
5. Si no requiere: limpiar producto destino (null)
6. Guardar producto
7. Redirect a listado

### 8.6 Flujo de Edicion (editProducto)

1. Verificar errores de BindingResult
2. Verificar si tipo requiere producto destino
3. Si requiere y esta vacio: rechazar con error
4. Si no requiere: limpiar producto destino (null)
5. Verificar que el producto original existe
6. Establecer ID y `activo = true`
7. Guardar producto
8. Redirect a listado con mensaje de exito

### 8.7 Flujo de Baja (deleteProducto)

1. Buscar producto por ID
2. Si no existe: error "Producto no encontrado"
3. Si ya esta inactivo: error "Producto ya esta inactivo"
4. Marcar `activo = false`
5. Guardar producto
6. Redirect a listado

---

## 9. SERVICE

### 9.1 Clase: ProductoService

Servicio simple que delega operaciones al repositorio. No contiene logica de negocio compleja.

**Path:** `service/maestro/ProductoService.java`

### 9.2 Metodos

| Metodo | Descripcion |
|--------|-------------|
| `getProductosExternos()` | APIs, excipientes, acondicionamientos (para compras) |
| `getProductosInternos()` | Semielaborados y UV (para produccion/destino) |
| `findByActivoTrueOrderByCodigoProductoAsc()` | Todos los productos activos ordenados |
| `save(Producto)` | Guardar producto |
| `findById(Long)` | Buscar por ID |

### 9.3 Queries del Repository

**findProductosExternos (lineas 12-25):**
```java
select p from Producto p
where p.activo = true
  and p.tipoProducto in (API, EXCIPIENTE, ACOND_PRIMARIO, ACOND_SECUNDARIO)
order by p.codigoProducto asc
```

**findProductosInternos (lineas 28-42):**
```java
select p from Producto p
where p.activo = true
  and p.tipoProducto in (SEMIELABORADO, GRANEL_*, UNIDAD_VENTA)
order by p.codigoProducto asc
```

---

## 10. PERSISTENCIA

### 10.1 Entidad: Producto

**Path:** `entity/maestro/Producto.java`

| Atributo | Tipo | Columna | Nullable |
|----------|------|---------|----------|
| id | Long | id | NO (PK) |
| nombreGenerico | String | nombre_generico | NO |
| codigoProducto | String(50) | codigo_producto | NO, UNIQUE |
| tipoProducto | TipoProductoEnum | tipo_producto | NO |
| unidadMedida | UnidadMedidaEnum | unidad_medida | NO |
| productoDestino | String(50) | producto_destino | SI |
| detallesProducto | String(TEXT) | detalles_producto | SI |
| activo | Boolean | activo | NO |

### 10.2 Acciones por Operacion

| Operacion | Accion DB | Estado Final |
|-----------|-----------|--------------|
| Alta | INSERT | activo=true |
| Modificacion | UPDATE | activo=true |
| Baja | UPDATE | activo=false |

### 10.3 Soft Delete

**Anotacion (linea 33):**
```java
@SQLDelete(sql = "UPDATE productos SET activo = false WHERE id = ?")
```

El `@SQLDelete` intercepta las llamadas a `delete()` y ejecuta un UPDATE en lugar de DELETE fisico. Sin embargo, en este controller se usa `save()` con `activo=false` directamente.

### 10.4 Constraints de Base de Datos

| Constraint | Tipo | Columnas |
|------------|------|----------|
| PK | Primary Key | id |
| UK_codigo | Unique | codigo_producto |
| UK_nombre_codigo_tipo | Unique | nombre_generico, codigo_producto, tipo_producto |
| NOT NULL | Check | nombre_generico, codigo_producto, tipo_producto, unidad_medida, activo |

---

## 11. AUDITORIA (ANMAT)

### 11.1 Hibernate Envers

La entidad `Producto` esta marcada con `@Audited` (linea 29):
```java
@Audited
public class Producto {
```

Cada operacion (INSERT, UPDATE) genera automaticamente un registro en la tabla `productos_aud` con:
- REV: Numero de revision
- REVTYPE: 0 (ADD), 1 (MOD), 2 (DEL)
- Todos los campos de la entidad en ese momento

### 11.2 Contexto de Auditoria

A diferencia de los CUs de movimiento, el ABM de productos **no establece contexto de caso de uso** (no hay `setCasoUsoContext`). Las revisiones se registran sin tag de CU.

### 11.3 Campo motivoDelCambio

**No aplica a este CU.** El campo `detallesProducto` es opcional y no tiene requisito de longitud minima. Los ABM de maestros no requieren motivoDelCambio segun ANMAT (solo aplica a operaciones sobre lotes).

---

## 12. SEGURIDAD

### 12.1 CSRF

Token CSRF incluido en todos los formularios:
```html
<input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>
```

Tambien incluido en formularios GET para el boton de edicion (aunque no es necesario para GET).

### 12.2 Autorizacion

- Configurada en `SecurityConfig.java` via `PermisosCasoUsoEnum`
- URL pattern: `/productos/**`
- Roles: ADMIN, GERENTE_CONTROL_CALIDAD
- No usa `@PreAuthorize` a nivel de metodo

### 12.3 XSS

- Datos renderizados con escape automatico (`th:text`)
- No hay rendering de HTML sin escape (`th:utext`)

### 12.4 Validacion de Entrada

- Inputs validados via HTML5 (`required`)
- Constraints JPA en entidad
- Validacion adicional en controller (producto destino)

### 12.5 Confirmacion de Eliminacion

El boton de eliminar incluye `onsubmit="return confirm(...)"` para evitar eliminaciones accidentales.

---

## 13. MANEJO DE ERRORES

### 13.1 Controller

| Situacion | Respuesta |
|-----------|-----------|
| Errores de validacion (alta) | Re-render formulario con `error = "Validacion fallida!"` |
| Errores de validacion (edicion) | Re-render formulario |
| Producto destino requerido | Reject value con mensaje |
| Producto no encontrado (GET edit) | Redirect con error |
| Producto inactivo (GET edit) | Redirect con error |
| Producto no encontrado (POST delete) | Redirect con error |
| Producto ya inactivo | Redirect con error |

### 13.2 Template

- Errores de campo mostrados con `th:errors="*{campo}"` y clase `text-danger`
- Alertas globales con Bootstrap alert (`alert-danger`, `alert-success`)
- Alertas dismissibles con boton de cierre

### 13.3 Excepciones no Controladas

- Violacion de constraint unique: Exception de DB (no manejada explicitamente)
- Redirigen a pagina de error global del sistema

---

## 14. LOGGING

### 14.1 Estado Actual

El controller y service **no tienen logging explicito**. No hay declaraciones `@Slf4j` ni llamadas a `log.info()`.

### 14.2 Logging Recomendado

Se sugiere agregar logging para:
- Alta de producto: `[CU41] Producto creado - Codigo: {}, Tipo: {}`
- Modificacion: `[CU41] Producto modificado - ID: {}, Codigo: {}`
- Baja: `[CU41] Producto desactivado - ID: {}, Codigo: {}`
- Errores de validacion: `[CU41] Validacion fallida - {}`

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| ALTA | Agregar logging con prefijo [CU41] |
| ALTA | Agregar validacion de lotes asociados antes de baja (actualmente puede desactivar producto con lotes) |
| MEDIA | Agregar JavaScript dinamico para mostrar/ocultar producto destino segun tipo |
| MEDIA | Agregar UseCaseTag CU41 en UseCaseTag.java |
| BAJA | Convertir productoDestino de String a relacion @ManyToOne con Producto |
| BAJA | Agregar paginacion server-side para listados grandes |
| BAJA | Agregar funcionalidad de reactivar producto eliminado |

---

## 16. ERRORES ENCONTRADOS EN REVISION

### 16.1 Falta de UseCaseTag

El enum `UseCaseTag.java` no incluye CU41. Deberia agregarse:
```java
CU41("[CU41]"),
```

### 16.2 Falta de Validacion de Lotes Asociados

El controller permite desactivar un producto sin verificar si tiene lotes asociados. Segun la documentacion funcional existente, esto deberia estar restringido.

**Solucion sugerida:**
```java
// En deleteProducto, antes de marcar como inactivo:
if (loteRepository.existsByProductoAndActivoTrue(producto)) {
    redirectAttributes.addFlashAttribute("error",
        "No se puede eliminar el producto porque tiene lotes asociados");
    return "redirect:/productos/list-productos";
}
```

### 16.3 JavaScript Faltante

Los templates de alta/edicion no tienen JavaScript para mostrar/ocultar dinamicamente el campo producto destino segun el tipo seleccionado. La validacion solo ocurre en el servidor despues del submit.

### 16.4 Falta de Logging

No hay logging en controller ni service. Todas las operaciones se ejecutan sin registro de auditoria a nivel de logs.

### 16.5 Verificacion de IDs y Elementos

Todos los elementos HTML necesarios estan presentes:
- Formularios con `method="post"` y `th:action` correcto
- Campos con IDs unicos y `th:field` binding
- Token CSRF incluido
- Botones de submit funcionales
- Confirmacion de eliminacion via `confirm()`

---

*Documento generado: 2025-12-14*
*Version: 1.0*
