# CU10 - VENCIMIENTO DE LOTE (PROCESO AUTOMATICO)

**Caso de Uso:** Vencimiento Automatico de Lotes
**URL Base:** N/A (Proceso batch programado)
**Consulta Asociada:** `/lotes/list-fechas-lotes`
**Tipo:** MODIFICACION (Automatico)
**Categoria:** Calidad / Sistema (color purpura)
**Identificador Interno:** `CU10_VENCIMIENTO_LOTE`

---

## 1. DESCRIPCION

Proceso batch automatico que se ejecuta diariamente a las **5:00 AM** para detectar y procesar lotes cuya fecha de vencimiento ha llegado (fechaVencimiento <= fecha actual). Cuando un lote cumple esta condicion, el sistema cambia automaticamente su dictamen a `VENCIDO` y genera un movimiento de MODIFICACION con motivo `VENCIMIENTO`.

**Caracteristicas principales:**

- **Ejecucion automatica:** Spring `@Scheduled(cron = "0 0 5 * * *")` - todos los dias a las 5:00 AM
- **Usuario del sistema:** Las operaciones se ejecutan como `system_auto` con rol ADMIN
- **Sin interaccion humana:** No requiere formularios ni intervencion del usuario
- **Manejo de errores resiliente:** Si falla el procesamiento de un lote, continua con los siguientes
- **Transaccional:** Cada lote se procesa en transaccion independiente
- **Cancelacion de analisis:** Si el lote tiene un analisis en curso (dictamen=null), se cancela automaticamente

**Relacion con CU9:** Este CU se ejecuta inmediatamente despues de CU9 (Expiracion de Analisis) en el mismo proceso batch. Ambos comparten el mismo servicio `FechaValidatorService`.

**Alerta proactiva:** El sistema genera alertas de vencimiento proximo (configurable, default 30 dias) via `AlertaService.generarAlertasLoteVencimiento()` que se ejecuta diariamente a las 6:30 AM.

**Consulta de monitoreo:** La pantalla `/lotes/list-fechas-lotes` permite a los usuarios visualizar las fechas de vencimiento de los lotes, identificando aquellos proximos a vencer.

---

## 2. ROLES AUTORIZADOS

### 2.1 Proceso Automatico

| Rol | Nivel | Acceso |
|-----|-------|--------|
| system_auto (ADMIN) | 6 | Proceso batch |

**Nota:** El proceso batch se ejecuta con un usuario especial `system_auto` que se crea automaticamente si no existe.

### 2.2 Consulta de Fechas (/lotes/list-fechas-lotes)

| Rol | Nivel | Acceso |
|-----|-------|--------|
| ADMIN | 6 | Permitido |
| DT | 5 | Permitido |
| GERENTE_GARANTIA_CALIDAD | 4 | Permitido |
| GERENTE_CONTROL_CALIDAD | 3 | Permitido |
| SUPERVISOR_PLANTA | 3 | Permitido |
| ANALISTA_CONTROL_CALIDAD | 2 | Permitido |
| ANALISTA_PLANTA | 2 | Permitido |
| AUDITOR | 1 | No permitido |

**Anotacion Enum:** `CU9_CU10_FECHAS_AUTOMATICO` en `PermisosCasoUsoEnum.java`

---

## 3. FLUJO DE OPERACION

### 3.1 Proceso Automatico (Batch)

```
+---------------------------------------------------------------------+
|  SCHEDULER (5:00 AM diario)                                          |
|  @Scheduled(cron = "0 0 5 * * *")                                   |
+---------------------------------------------------------------------+
                              |
                              v
+---------------------------------------------------------------------+
|  1. PROCESAR ANALISIS EXPIRADOS (CU9)                               |
|     procesarLotesAnalisisExpirado()                                  |
+---------------------------------------------------------------------+
                              |
                              v
+---------------------------------------------------------------------+
|  2. BUSCAR LOTES VENCIDOS                                            |
|     findAllLotesVencidos()                                           |
|  +---------------------------------------------------------------+  |
|  |  Query: Lotes con stock donde                                 |  |
|  |         fechaVencimientoVigente <= fecha actual               |  |
|  +---------------------------------------------------------------+  |
+---------------------------------------------------------------------+
                              |
                              v
+---------------------------------------------------------------------+
|  3. PROCESAR CADA LOTE (CU10)                                        |
|     procesarLotesVencidos()                                          |
|  +---------------------------------------------------------------+  |
|  |  Para cada lote:                                              |  |
|  |    - Crear MovimientoDTO con motivo "(CU10) VENCIMIENTO..."   |  |
|  |    - Crear Movimiento MODIFICACION/VENCIMIENTO                |  |
|  |    - Cambiar dictamen lote a VENCIDO                          |  |
|  |    - SI analisis en curso (dictamen=null):                    |  |
|  |        * Cancelar analisis (dictamen=CANCELADO)               |  |
|  |    - Guardar lote                                             |  |
|  |  Si error: log y continuar con siguiente lote                 |  |
|  +---------------------------------------------------------------+  |
+---------------------------------------------------------------------+
```

### 3.2 Proceso de Alertas (6:30 AM diario)

```
+---------------------------------------------------------------------+
|  SCHEDULER (6:30 AM diario)                                          |
|  AlertaService.generarAlertasLoteVencimiento()                       |
+---------------------------------------------------------------------+
                              |
                              v
+---------------------------------------------------------------------+
|  1. BUSCAR LOTES PROXIMOS A VENCER                                  |
|     Configuracion: alerta.lote.dias (default: 30)                   |
|  +---------------------------------------------------------------+  |
|  |  Query: Lotes con fechaVencimientoProveedor <= hoy + dias     |  |
|  |         AND activo = true                                     |  |
|  +---------------------------------------------------------------+  |
+---------------------------------------------------------------------+
                              |
                              v
+---------------------------------------------------------------------+
|  2. CREAR ALERTAS (si no existen)                                    |
|  +---------------------------------------------------------------+  |
|  |  Para cada lote:                                              |  |
|  |    - Verificar si ya existe alerta activa                     |  |
|  |    - Si no existe, crear Alerta tipo LOTE_VENCIMIENTO         |  |
|  |    - Mensaje: "Lote {codigoLote} vence el {fechaVtoProv}"     |  |
|  +---------------------------------------------------------------+  |
+---------------------------------------------------------------------+
```

### 3.3 Consulta de Monitoreo

Igual que CU9 - ver documentacion de CU9 seccion 3.2.

---

## 4. ARCHIVOS INVOLUCRADOS

### Backend (Proceso Batch)

| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `service/cu/FechaValidatorService.java` | Servicio batch CU9/CU10 | 239 |
| `service/AlertaService.java` | Alertas de vencimiento | 250 |
| `service/cu/AbstractCuService.java` | Clase base con repositorios | - |

### Test

| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `service/cu/FechaValidatorServiceTest.java` | Tests unitarios completos | 1026 |

### Entidades

| Archivo | Descripcion |
|---------|-------------|
| `entity/Alerta.java` | Entidad de alertas (133 lineas) |
| `repository/AlertaRepository.java` | Repository de alertas (84 lineas) |

### Frontend (Consulta de Monitoreo)

| Archivo | Descripcion | Lineas |
|---------|-------------|--------|
| `templates/lotes/list-fechas-lotes.html` | Consulta de fechas | 360 |
| `controller/LotesController.java` | Controller consulta (parcial) | 112 |

### Enums Relacionados

| Archivo | Uso en CU10 |
|---------|-------------|
| `enums/UseCaseTag.java` | Tag `CU10("[CU10]")` |
| `enums/MotivoEnum.java` | `VENCIMIENTO("Vencimiento")` |
| `enums/DictamenEnum.java` | `VENCIDO("Vencido")`, `CANCELADO("Cancelado")` |
| `enums/TipoAlertaEnum.java` | `LOTE_VENCIMIENTO("Vencimiento de Lote")` |
| `enums/PermisosCasoUsoEnum.java` | `CU9_CU10_FECHAS_AUTOMATICO` |

### Utilidades

| Archivo | Uso en CU10 |
|---------|-------------|
| `utils/MovimientoModificacionUtils.java` | Factory para Movimiento MODIFICACION |
| `utils/MovimientoCommonUtils.java` | `formatMotivoDelCambioWithCU()` |

---

## 5. CONDICIONES DE ACTIVACION

### 5.1 Criterios para Detectar Lote Vencido

Un lote se procesa como "vencido" cuando:

| Condicion | Descripcion |
|-----------|-------------|
| Stock > 0 | El lote tiene bultos con cantidad disponible |
| Fecha Vencimiento Vigente | La `fechaVencimientoVigente` del lote no es null |
| Fecha <= Hoy | La fecha de vencimiento es igual o anterior a la fecha actual |

### 5.2 Query de Busqueda

**Metodo:** `findAllLotesVencidos()`

```java
loteRepository.findLotesConStockOrder().stream()
    .filter(l -> {
        LocalDate f = l.getFechaVencimientoVigente();
        return f != null && !f.isAfter(hoy); // <= hoy
    })
    .toList();
```

**Query base `findLotesConStockOrder`:**
```sql
SELECT l FROM Lote l
WHERE EXISTS (
    SELECT 1 FROM Bulto b
    WHERE b.lote = l AND b.cantidadActual > 0
)
ORDER BY l.fechaIngreso ASC, l.codigoLote ASC
```

### 5.3 Diferencia con CU9

| Aspecto | CU9 (Analisis Expirado) | CU10 (Vencimiento) |
|---------|-------------------------|-------------------|
| Fecha evaluada | `fechaReanalisisVigente` | `fechaVencimientoVigente` |
| Dictamen final | `ANALISIS_EXPIRADO` | `VENCIDO` |
| Motivo movimiento | `EXPIRACION_ANALISIS` | `VENCIMIENTO` |
| Cancelar analisis | No | Si (si esta en curso) |

---

## 6. LOGICA DE NEGOCIO

### 6.1 Metodo Principal: validarFecha()

Este metodo es el punto de entrada del proceso batch:

```java
@Scheduled(cron = "0 0 5 * * *")
@Transactional
public void validarFecha() {
    procesarLotesAnalisisExpirado(findAllLotesAnalisisExpirado());  // CU9
    procesarLotesVencidos(findAllLotesVencidos());  // CU10
}
```

### 6.2 Flujo de Procesamiento CU10

**Metodo:** `procesarLotesVencidos(List<Lote> lotesVencidos)`

1. **Validar lista:** Si esta vacia, log debug y retornar.

2. **Crear DTO base:**
   - `fechaMovimiento`: Fecha actual
   - `fechaYHoraCreacion`: OffsetDateTime.now()
   - `motivoDelCambio`: "(CU10) VENCIMIENTO AUTOMATICO POR FECHA: {fecha}"

3. **Para cada lote:**
   - Crear movimiento MODIFICACION/VENCIMIENTO
   - Cambiar dictamen del lote a VENCIDO
   - **Cancelar analisis en curso si existe** (dictamen = null)
   - Guardar lote
   - Log info con detalles

4. **Manejo de errores:** Si falla un lote, log error y continuar con el siguiente.

### 6.3 Cancelacion de Analisis en Curso

Cuando un lote vence y tiene un analisis en curso (dictamen = null), el sistema automaticamente:

```java
// CU10: Cancelar análisis en curso si existe (dictamen == null)
if (lote.getUltimoAnalisis() != null && lote.getUltimoAnalisis().getDictamen() == null) {
    lote.getUltimoAnalisis().setDictamen(DictamenEnum.CANCELADO);
    analisisRepository.save(lote.getUltimoAnalisis());
}
```

**Justificacion:** Un lote vencido no puede continuar el proceso de analisis porque el producto ya no es apto para su uso, independientemente del resultado del analisis.

### 6.4 Creacion del Movimiento

**Metodo:** `persistirMovimientoProductoVencido(MovimientoDTO dto, Lote lote)`

- **Tipo:** MODIFICACION
- **Motivo:** VENCIMIENTO
- **Usuario:** system_auto (ADMIN)
- **Dictamen Inicial:** Dictamen actual del lote
- **Dictamen Final:** VENCIDO
- **MotivoDelCambio:** Formateado con prefijo `[CU10]`

---

## 7. ALERTAS DE VENCIMIENTO

### 7.1 Generacion Automatica de Alertas

El sistema genera alertas proactivas para lotes proximos a vencer:

**Metodo:** `AlertaService.generarAlertasLoteVencimiento()`
**Horario:** 6:30 AM diario (`@Scheduled(cron = "0 30 6 * * *")`)
**Configuracion:** `alerta.lote.dias` (default: 30 dias de anticipacion)

### 7.2 Entidad Alerta

| Campo | Tipo | Valor para CU10 |
|-------|------|-----------------|
| tipo | TipoAlertaEnum | `LOTE_VENCIMIENTO` |
| mensaje | String | "Lote {codigoLote} vence el {fechaVencimientoProveedor}" |
| entidadReferencia | String | "Lote:{id}" |
| fechaEvento | LocalDate | Fecha de vencimiento del lote |
| usuario | User | null (visible para todos los admins) |
| leida | Boolean | false |
| activa | Boolean | true |

### 7.3 Visualizacion de Alertas

Las alertas de vencimiento se muestran con:
- **Icono:** `bi-box-seam` (Bootstrap Icons)
- **Color badge:** `bg-danger` (rojo)

### 7.4 Ciclo de Vida de Alertas

| Fase | Accion |
|------|--------|
| Creacion | 30 dias antes del vencimiento |
| Visualizacion | En panel de alertas del usuario |
| Desactivacion | Cuando fecha del evento pasa (job 3:00 AM) |
| Eliminacion | 30 dias despues de desactivar (job 3:00 AM) |

---

## 8. TEMPLATE (Consulta de Monitoreo)

Ver documentacion de CU9 seccion 7 - misma pantalla compartida.

### 8.1 Columna Especifica CU10

La columna "Dias Vencimiento" muestra:
- Dias restantes hasta la fecha de vencimiento vigente
- **Colores:**
  - **Rojo:** Dias <= 30 (urgente) o < 0 (vencido)
  - **Amarillo:** Dias entre 31 y 60
  - **Verde:** Dias > 60

---

## 9. CONTROLLER (Consulta)

Ver documentacion de CU9 seccion 8 - mismo controller compartido.

---

## 10. SERVICE

### 10.1 Clase: FechaValidatorService

El servicio implementa la logica de los procesos automaticos CU9 y CU10. Extiende `AbstractCuService` para acceder a repositorios.

### 10.2 Metodos Principales CU10

| Metodo | Responsabilidad |
|--------|-----------------|
| `validarFecha()` | Punto de entrada @Scheduled |
| `findAllLotesVencidos()` | Buscar lotes con fecha vencimiento <= hoy |
| `procesarLotesVencidos()` | Procesar lista de lotes vencidos |
| `persistirProductosVencidos()` | Persistir cambios (con cancelacion de analisis) |
| `persistirMovimientoProductoVencido()` | Crear movimiento individual |
| `getSystemUser()` | Obtener/crear usuario system_auto |

### 10.3 Usuario del Sistema

El proceso batch usa un usuario especial:

```java
User getSystemUser() {
    return userRepository.findByUsername("system_auto")
        .orElseGet(() -> {
            Role adminRole = roleRepository.findByName(RoleEnum.ADMIN.name())
                .orElseGet(() -> roleRepository.save(Role.fromEnum(RoleEnum.ADMIN)));
            User systemUser = new User("system_auto", "N/A", adminRole);
            return userRepository.save(systemUser);
        });
}
```

---

## 11. PERSISTENCIA

### 11.1 Entidades Afectadas

| Entidad | Accion | Estado Final |
|---------|--------|--------------|
| Lote | UPDATE | dictamen=VENCIDO |
| Analisis (si en curso) | UPDATE | dictamen=CANCELADO |
| Movimiento | INSERT | tipo=MODIFICACION, motivo=VENCIMIENTO |
| User (system_auto) | INSERT (si no existe) | rol=ADMIN |
| Role (ADMIN) | INSERT (si no existe) | nivel=6 |
| Alerta | INSERT (proactiva) | tipo=LOTE_VENCIMIENTO |

### 11.2 Movimiento Generado

| Campo | Valor |
|-------|-------|
| tipo | MODIFICACION |
| motivo | VENCIMIENTO |
| fecha | Fecha actual |
| dictamenInicial | Dictamen anterior del lote |
| dictamenFinal | VENCIDO |
| motivoDelCambio | `[CU10](CU10) VENCIMIENTO AUTOMATICO POR FECHA: {fecha}` |
| usuario | system_auto |

---

## 12. AUDITORIA (ANMAT)

El sistema cumple con los requerimientos de la Disposicion ANMAT 4159:

- **Hibernate Envers:** Las entidades Lote, Analisis y Movimiento estan auditadas. Cada cambio genera registro en tablas `_aud`.

- **Campo motivoDelCambio:** Incluye mensaje automatico con fecha del proceso.

- **Prefijo de CU:** El motivoDelCambio incluye `[CU10]` para trazabilidad.

- **Registro de procesamiento:** Todos los lotes procesados quedan registrados con movimiento y log.

- **Cancelacion de analisis:** Queda registrada en la auditoria con dictamen=CANCELADO.

---

## 13. SEGURIDAD

### 13.1 Proceso Automatico

- **Sin sesion HTTP:** El proceso batch no depende de sesion de usuario.
- **Usuario interno:** Ejecuta como `system_auto` con permisos ADMIN.
- **Aislamiento:** Cada lote se procesa en try-catch individual.

### 13.2 Consulta de Fechas

- **CSRF:** Token incluido automaticamente.
- **Autorizacion:** Solo roles definidos en PermisosCasoUsoEnum.
- **XSS:** Datos escapados con th:text.

---

## 14. MANEJO DE ERRORES

### 14.1 Proceso Batch

| Situacion | Comportamiento |
|-----------|----------------|
| Lista vacia | Log debug, continuar |
| Error en lote individual | Log error con codigoLote y mensaje, continuar con siguiente |
| Error al obtener usuario | Se crea automaticamente |
| Error al cancelar analisis | Se captura y loguea, continua con siguiente lote |

### 14.2 Logging de Errores

```java
log.error(
    "[CU10] Error procesando vencimiento para lote: {} - {}",
    lote.getCodigoLote(), e.getMessage(), e);
```

---

## 15. LOGGING

El service registra eventos en los siguientes puntos:

| Nivel | Mensaje | Condicion |
|-------|---------|-----------|
| DEBUG | `[CU10] No hay lotes vencidos para procesar` | Lista vacia |
| INFO | `[CU10] Procesando {} lotes vencidos` | Inicio proceso |
| INFO | `[CU10] Lote vencido procesado - Lote: {loteProveedor}, FechaVencimiento: {fechaVencimientoVigente}` | Lote procesado |
| ERROR | `[CU10] Error procesando vencimiento para lote: {codigoLote} - {mensaje}` | Error individual |

Todos los logs usan el prefijo `[CU10]` para facilitar la busqueda.

**Nota:** El log de lote procesado muestra `loteProveedor` (codigo del proveedor), no `codigoLote` (codigo interno).

### 15.1 Logs de Alertas

| Nivel | Mensaje |
|-------|---------|
| INFO | `[ALERTAS] Generando alertas de vencimiento de lotes (anticipación: {} días)` |
| INFO | `[ALERTAS] Creadas {} alertas de vencimiento de lote` |

---

## 16. TESTS UNITARIOS

El archivo `FechaValidatorServiceTest.java` incluye tests especificos para CU10:

### 16.1 Tests de Deteccion

| Test | Descripcion |
|------|-------------|
| `findAllLotesVencidos_fechaPasada_debeIncluirse` | Fecha ayer debe incluirse |
| `findAllLotesVencidos_fechaHoy_debeIncluirse` | Fecha hoy debe incluirse |
| `findAllLotesVencidos_fechaFutura_noDebeIncluirse` | Fecha manana no debe incluirse |
| `findAllLotesVencidos_sinFecha_noDebeIncluirse` | Sin fecha no debe incluirse |
| `findAllLotesVencidos_multiplesLotes_filtraCorrectamente` | Filtro correcto con varios lotes |

### 16.2 Tests de Procesamiento

| Test | Descripcion |
|------|-------------|
| `persistirProductosVencidos_listaVacia_debeRetornarVacia` | Lista vacia |
| `persistirProductosVencidos_conAnalisisEnCurso_debeCancelar` | Cancela analisis en curso |
| `persistirProductosVencidos_analisisDictaminado_noDebeCancelar` | No cancela si ya tiene dictamen |
| `persistirProductosVencidos_sinAnalisis_noDebeCancelar` | No intenta cancelar sin analisis |

### 16.3 Tests de Resiliencia

| Test | Descripcion |
|------|-------------|
| `procesarLotesVencidos_listaVacia_debeRetornar` | Retorna inmediatamente |
| `procesarLotesVencidos_conLotes_debeProcesarYLoggear` | Procesa y loguea |
| `procesarLotesVencidos_conExcepcionEnSave_debeContinuar` | Continua tras error |

---

## 17. MEJORAS SUGERIDAS

| Prioridad | Mejora |
|-----------|--------|
| BAJA | Agregar notificacion por email cuando se venzan lotes |
| BAJA | Configurar horario de ejecucion via base de datos |
| BAJA | Agregar dashboard con estadisticas de lotes vencidos |
| MEDIA | Notificacion a responsable de calidad cuando se cancela analisis |
| BAJA | Exportar reporte de lotes vencidos a PDF |

---

*Documento generado: 2025-12-14*
*Version: 1.0*
