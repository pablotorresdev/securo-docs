# CU31 - REVERSO DE MOVIMIENTO

**Caso de Uso:** Revertir el ultimo movimiento registrado de un lote
**URL Base:** /contingencias/reverso-movimiento
**Tipo:** Variable (ALTA, BAJA o MODIFICACION segun movimiento original)
**Categoria:** Contingencias (rojo)
**Identificador Interno:** CU31_REVERSO_MOVIMIENTO

---

## 1. DESCRIPCION

El CU31 permite **revertir el ultimo movimiento registrado** de un lote. Es un caso de uso especial ya que:

- **Tipo de movimiento variable**: El tipo del reverso coincide con el del movimiento original
- **Sistema de autorizacion por jerarquia**: Usa `ReversoAuthorizationService` para validar permisos
- **Coordinador de servicios delegados**: Delega a `ReversoAltaService`, `ReversoBajaService` o `ReversoModificacionService`
- **Movimientos irreversibles**: CU9 (Expiracion Analisis) y CU10 (Vencimiento) no pueden reversarse

**Efecto del reverso:**
- Marca el movimiento original como inactivo (`activo = false`)
- Restaura cantidades de lote y bultos
- Restaura estados de trazas (ej: VENDIDO -> DISPONIBLE)
- Restaura dictamen del lote al anterior
- Registra movimiento de reverso para auditoria (tambien inactivo)

---

## 2. ROLES AUTORIZADOS

### 2.1 Acceso a la Pantalla

| Rol | Nivel | Acceso GET | Acceso POST |
|-----|-------|------------|-------------|
| ADMIN | 6 | SI | SI |
| DT | 5 | SI | SI |
| GERENTE_GARANTIA_CALIDAD | 4 | SI | SI |
| GERENTE_CONTROL_CALIDAD | 3 | SI | SI |
| SUPERVISOR_PLANTA | 3 | SI | SI |
| ANALISTA_CONTROL_CALIDAD | 2 | SI | SI |
| ANALISTA_PLANTA | 2 | SI | SI |
| AUDITOR | 1 | NO | NO |

**Anotaciones:**
- GET: `@PreAuthorize("isAuthenticated()")`
- POST: `@PreAuthorize("isAuthenticated()")`

**Nota importante:** El acceso a la pantalla no garantiza poder reversar. La autorizacion real se valida en `ReversoAuthorizationService` basada en jerarquia.

### 2.2 Reglas de Autorizacion por Jerarquia (con Areas)

| Regla | Descripcion |
|-------|-------------|
| **Creador** | El usuario que creo el movimiento SIEMPRE puede reversarlo |
| **GLOBAL Superior** | ADMIN y DT pueden reversar movimientos de CUALQUIER area |
| **Misma Area** | Solo pueden reversar si tienen nivel SUPERIOR dentro de la MISMA area |
| **Areas Diferentes** | CALIDAD y PLANTA NO tienen jerarquia entre si |
| **AUDITOR** | NUNCA puede reversar (rol de solo lectura, area GLOBAL) |
| **Legacy** | Movimientos sin creador: solo ADMIN puede reversar |

**Areas funcionales:**
- **GLOBAL**: ADMIN, DT, AUDITOR - superiores/inferiores a todos
- **CALIDAD**: GERENTE_GARANTIA, GERENTE_CONTROL, ANALISTA_CC - jerarquia interna
- **PLANTA**: SUPERVISOR, ANALISTA_PLANTA - jerarquia interna

---

## 3. FLUJO DE PANTALLAS

```
[Menu Principal]
      |
      v
[GET /contingencias/reverso-movimiento]
      |
      | (Seleccionar lote)
      v
[AJAX GET /movimientos/ultimo-movimiento/{codigoLote}]
      |
      v
[Se muestra ultimo movimiento]
      |
      | (Completar motivoDelCambio y enviar)
      v
[POST /contingencias/reverso-movimiento/confirm]
      |
      +----------------+
      |                |
      v                v
[Validacion OK]  [Validacion Error]
      |                |
      v                v
[Vista Confirmacion]  [Formulario con error]
      |
      +----------------+
      | (Volver)       | (Confirmar)
      v                v
[GET formulario]  [POST /contingencias/reverso-movimiento]
                       |
                       +----------------+
                       |                |
                       v                v
                  [Autorizado]    [No Autorizado]
                       |                |
                       v                v
                  [redirect 302]  [errorAutorizacion]
                       |                |
                       v                v
                  [GET /reverso-movimiento-ok]  [Formulario]
```

---

## 4. ARCHIVOS INVOLUCRADOS

### 4.1 Backend

| Archivo | Descripcion |
|---------|-------------|
| `controller/cu/ContingenciasController.java` | Controller compartido CU30/CU31 |
| `service/cu/ModifReversoMovimientoService.java` | Servicio coordinador CU31 |
| `service/ReversoAuthorizationService.java` | Servicio de autorizacion |
| `service/cu/ReversoAltaService.java` | Reverso de ALTA (CU1, CU20, CU24, CU25) |
| `service/cu/ReversoBajaService.java` | Reverso de BAJA (CU3, CU4, CU7, CU23, CU30) |
| `service/cu/ReversoModificacionService.java` | Reverso de MODIF (CU2/8, CU5/6, CU11, CU22, CU21) |

### 4.2 Frontend

| Archivo | Descripcion |
|---------|-------------|
| `templates/contingencias/reverso-movimiento.html` | Formulario principal |
| `templates/contingencias/reverso-movimiento-confirm.html` | Pantalla de confirmacion |
| `templates/contingencias/reverso-movimiento-ok.html` | Pantalla de exito |

### 4.3 Tests

| Archivo | Descripcion |
|---------|-------------|
| `service/cu/ModifReversoMovimientoServiceTest.java` | Tests del coordinador |

### 4.4 Enums/Config

| Archivo | Valor |
|---------|-------|
| `enums/UseCaseTag.java` | `CU31("[CU31]")` |
| `enums/PermisosCasoUsoEnum.java` | Roles autorizados |

---

## 5. CAMPOS DEL FORMULARIO

### 5.1 Campos Obligatorios

| Campo | ID | Tipo | Validacion HTML | Validacion Backend |
|-------|----|------|-----------------|-------------------|
| Lote | `codigoLote` | select | `required` | Selector de lotes elegibles |
| Motivo del Cambio | `motivoDelCambio` | textarea | `required minlength="20"` | `trim().length() >= 20` |

### 5.2 Campos Hidden/Readonly

| Campo | ID | Tipo | Descripcion |
|-------|----|------|-------------|
| Fecha Movimiento | `fechaMovimiento` | hidden date | Fecha actual (auto) |
| Codigo Movimiento | `codigoMovimientoOrigen` | hidden | Se carga via AJAX |
| Resumen Movimiento | `movResumen` | readonly text | Display del movimiento |

### 5.3 Campos NO Enviados (Solo Display)

| Campo | Descripcion |
|-------|-------------|
| Movimiento a Revertir | Panel informativo con datos del movimiento |

---

## 6. VALIDACIONES POR CAPA

### 6.1 Frontend (HTML5 + JavaScript)

| Validacion | Implementacion |
|------------|----------------|
| Lote obligatorio | `required` en select |
| Motivo min 20 chars | `minlength="20"` |
| Prevenir doble submit | JavaScript `btn.disabled = true` |

### 6.2 Backend - Controller (ContingenciasController.java:60-96)

| Validacion | Mensaje Error |
|------------|---------------|
| BindingResult errors | Retorna formulario |
| motivoDelCambio null o < 20 chars | "El motivo del cambio es obligatorio (mínimo 20 caracteres)" |

### 6.3 Backend - Service (ModifReversoMovimientoService.java)

| Validacion | Mensaje Error |
|------------|---------------|
| Movimiento no existe | "El Movimiento no existe." |
| Multiples movimientos | "Cantidad incorrecta de movimientos" |
| Tipo movimiento null | "Tipo de movimiento no puede ser nulo." |
| Motivo no soportado | "Motivo de {TIPO} no soportado para reverso" |

### 6.4 Backend - ReversoAuthorizationService

| Validacion | Mensaje Error |
|------------|---------------|
| Usuario es AUDITOR | "Los auditores no tienen permisos para reversar movimientos. El rol AUDITOR es de solo lectura." |
| Movimiento legacy sin ser ADMIN | "No tiene permisos para reversar este movimiento legacy..." |
| Sin jerarquia suficiente | "No tiene permisos para reversar este movimiento. Fue creado por {user}..." |

### 6.5 Movimientos Irreversibles

| CU | Motivo | Mensaje Error |
|----|--------|---------------|
| CU9 | EXPIRACION_ANALISIS | "No se puede reversar una expiración de análisis (CU9). La expiración es un proceso automático." |
| CU10 | VENCIMIENTO | "No se puede reversar un vencimiento de lote (CU10). El vencimiento es un proceso automático irreversible." |
| CU25 (MODIF) | RETIRO_MERCADO | "El lote origen tiene un recall asociado, no se puede reversar el movimiento." |

---

## 7. TEMPLATE (Frontend)

### 7.1 Estilo Visual

| Aspecto | Valor |
|---------|-------|
| Clase body | `bg-contingencias` |
| Color categoria | `--color-contingencias` (rojo) |
| Badge | "CU Contingencias" |
| Icono principal | `bi-arrow-counterclockwise` |

### 7.2 Librerias

| Libreria | Version | Uso |
|----------|---------|-----|
| Bootstrap | 5.3.0 | CSS + JS |
| Bootstrap Icons | 1.11.0 | Iconos |
| jQuery | 3.7.1 | Select2 |
| Select2 | 4.1.0-rc.0 | Selector de lotes |
| select2-bootstrap-5-theme | 1.3.0 | Tema |

### 7.3 JavaScript Dinamico

```javascript
// Endpoints consumidos:
GET /movimientos/ultimo-movimiento/{codigoLote}

// IDs referenciados:
- codigoLote (select)
- wrapperMovReverso (div)
- movResumen (input readonly)
- codigoMovimientoOrigen (hidden)
- fechaMovimiento (hidden)
- motivoDelCambio (textarea)
- btnSubmit (button)

// Formato resumen movimiento:
"Fecha: {fecha} | Tipo: {tipo} | Motivo: {motivo} | Cantidad: {cant} {um} | Codigo: {cod}"
```

### 7.4 Prevencion Doble Submit

```javascript
btn.closest('form').addEventListener('submit', function(e) {
    if (btn.disabled) { e.preventDefault(); return; }
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border...">Procesando...';
});
```

---

## 8. CONTROLLER

### 8.1 Endpoints

| Metodo | URL | Anotacion | Descripcion |
|--------|-----|-----------|-------------|
| GET | `/contingencias/reverso-movimiento` | `@PreAuthorize("isAuthenticated()")` | Formulario |
| POST | `/contingencias/reverso-movimiento/confirm` | `@PreAuthorize("isAuthenticated()")` | Vista previa confirmacion |
| POST | `/contingencias/reverso-movimiento` | `@PreAuthorize("isAuthenticated()")` | Procesar reverso |
| GET | `/contingencias/reverso-movimiento-ok` | - | Pantalla exito |
| GET | `/contingencias/cancelar` | - | Redirige a home |

### 8.2 Flujo POST /confirm (ContingenciasController.java:67-97)

```java
1. Validar BindingResult
2. Validar motivoDelCambio (min 20 chars)
3. Resolver nombres desde lote para display
4. Obtener movimiento original via MovimientoService
5. return "contingencias/reverso-movimiento-confirm"
```

### 8.3 Flujo POST final (ContingenciasController.java:103-140)

```java
1. Validar BindingResult
2. Validar motivoDelCambio (min 20 chars)
3. try {
       procesarReversoMovimiento(dto, redirectAttributes)
   } catch (ReversoNotAuthorizedException) {
       model.addAttribute("errorAutorizacion", message)
       return formulario
   } catch (IllegalStateException) {
       bindingResult.rejectValue("codigoLote", message)
       return formulario
   }
4. redirect -> /reverso-movimiento-ok
```

### 8.4 Modelo Cargado

```java
initModelReversoMovimiento():
- loteReversoDTOs: loteService.findAllForReversoMovimientoDTOs()
- movimientoDTO: el DTO del formulario

confirmarReversoMovimiento() agrega:
- movimientoOriginal: datos del movimiento a reversar
```

---

## 9. SERVICE

### 9.1 Metodo Principal: `persistirReversoMovmiento`

**Ubicacion:** `ModifReversoMovimientoService.java:48-97`

```java
@Transactional
public LoteDTO persistirReversoMovmiento(final MovimientoDTO dto) {
    1. setCasoUsoContext("CU31_REVERSO_MOVIMIENTO")
    2. Obtener usuario actual
    3. Buscar movimiento por codigo
    4. Validar: existe, es unico, tipo no null
    5. Validar autorizacion via reversoAuthorizationService
    6. switch (tipo) {
           ALTA -> delegarReversoAlta()
           BAJA -> delegarReversoBaja()
           MODIFICACION -> delegarReversoModificacion()
       }
    7. Log y retornar LoteDTO
}
```

### 9.2 Delegacion por Tipo

#### ALTA (CU1, CU20, CU24, CU25)
```java
delegarReversoAlta():
- COMPRA -> reversoAltaService.reversarAltaIngresoCompra()
- PRODUCCION_PROPIA -> reversoAltaService.reversarAltaIngresoProduccion()
- DEVOLUCION_VENTA -> reversoAltaService.reversarAltaDevolucionVenta()
- RETIRO_MERCADO -> reversoAltaService.reversarRetiroMercado()
```

#### BAJA (CU3, CU4, CU7, CU23, CU30)
```java
delegarReversoBaja():
- DEVOLUCION_COMPRA -> reversoBajaService.reversarBajaDevolucionCompra()
- MUESTREO -> reversoBajaService.reversarBajaMuestreoBulto()
- CONSUMO_PRODUCCION -> reversoBajaService.reversarBajaConsumoProduccion()
- VENTA -> reversoBajaService.reversarBajaVentaProducto()
- AJUSTE -> reversoBajaService.reversarBajaAjuste()
```

#### MODIFICACION (CU2/8, CU5/6, CU11, CU22, CU21)
```java
delegarReversoModificacion():
- ANALISIS -> reversoModificacionService.reversarModifDictamenCuarentena()
- RESULTADO_ANALISIS -> reversoModificacionService.reversarModifResultadoAnalisis()
- LOTE_LIBERADO -> reversoModificacionService.reversarModifConfirmarLoteLiberado()
- TRAZADO -> reversoModificacionService.reversarModifTrazadoLote()
- ANULACION_ANALISIS -> reversoModificacionService.reversarAnulacionAnalisis()
- VENCIMIENTO -> throw (irreversible)
- EXPIRACION_ANALISIS -> throw (irreversible)
- RETIRO_MERCADO -> throw (recall asociado)
```

---

## 10. PERSISTENCIA

### 10.1 Entidades Afectadas (Variable segun CU reversado)

| Entidad | Operacion |
|---------|-----------|
| Movimiento original | `activo = false` |
| Movimiento reverso | `activo = false` (nuevo registro) |
| Lote | Restaurar cantidades/estado/dictamen |
| Bultos | Restaurar cantidades/estado |
| Trazas | Restaurar estado (ej: VENDIDO -> DISPONIBLE) |
| Analisis | Restaurar si fue anulado/cancelado |
| DetalleMovimiento | `activo = false` (si aplica) |

### 10.2 Movimiento de Reverso

```java
// Creado por MovimientoModificacionUtils.createMovimientoReverso()
Movimiento movReverso = new Movimiento();
movReverso.setLote(loteOrigen);
movReverso.setTipoMovimiento(movOrigen.getTipoMovimiento());
movReverso.setMotivo(MotivoEnum.REVERSO);
movReverso.setMovimientoOrigen(movOrigen);
movReverso.setCreadoPor(currentUser);
movReverso.setMotivoDelCambio(dto.getMotivoDelCambio());
movReverso.setActivo(false); // Se marca inactivo inmediatamente
```

---

## 11. AUDITORIA (ANMAT)

### 11.1 Hibernate Envers

Todas las entidades estan auditadas:
- `Movimiento` (original e inverso)
- `Lote`
- `Bulto`
- `Traza`
- `Analisis`

### 11.2 motivoDelCambio

| Aspecto | Valor |
|---------|-------|
| Campo obligatorio | SI |
| Minimo caracteres | 20 |
| Requerimiento | ANMAT Disp. 4159 Req. 9 |

### 11.3 Contexto CU

```java
setCasoUsoContext("CU31_REVERSO_MOVIMIENTO");
```

### 11.4 Logging

| Prefijo | Descripcion |
|---------|-------------|
| `[CU31]` | Operaciones del coordinador |
| `[REVERSO-CU1]` | Reverso alta compra |
| `[REVERSO-CU3]` | Reverso muestreo |
| `[REVERSO-CU4]` | Reverso devolucion compra |
| `[REVERSO-CU7]` | Reverso consumo produccion |
| `[REVERSO-CU20]` | Reverso ingreso produccion |
| `[REVERSO-CU22]` | Reverso confirmacion lote |
| `[REVERSO-CU23]` | Reverso venta |
| `[REVERSO-CU24]` | Reverso devolucion venta |
| `[REVERSO-CU25]` | Reverso retiro mercado |
| `[REVERSO-CU30]` | Reverso ajuste stock |
| `[REVERSO-CU21]` | Reverso trazado |
| `[REVERSO-CU5/6]` | Reverso resultado analisis |
| `[REVERSO-CU2]` | Reverso dictamen cuarentena |
| `[REVERSO-CU11]` | Reverso anulacion analisis |

---

## 12. SEGURIDAD

### 12.1 CSRF

| Aspecto | Implementacion |
|---------|----------------|
| Meta tags | `<meta name="_csrf" th:content="${_csrf.token}"/>` |
| Hidden input | `<input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>` |

### 12.2 Autorizacion

| Capa | Mecanismo |
|------|-----------|
| URL | `@PreAuthorize("isAuthenticated()")` (solo GET actualmente) |
| Negocio | `ReversoAuthorizationService.validarPermisoReverso()` |

### 12.3 XSS

| Campo | Proteccion |
|-------|------------|
| errorAutorizacion | `th:text` (escapado automatico) |
| Datos del lote | `th:text` (escapado automatico) |

---

## 13. MANEJO DE ERRORES

### 13.1 Por Capa

| Capa | Tipo Error | Manejo |
|------|------------|--------|
| Controller | BindingResult | Retorna formulario con errores |
| Controller | ReversoNotAuthorizedException | `errorAutorizacion` en modelo |
| Controller | IllegalStateException | `bindingResult.rejectValue` |
| Service | IllegalArgumentException | Propagado como 500 |
| Service | IllegalStateException | Capturado en controller |

### 13.2 Mensajes de Error UI

```html
<!-- Error de autorizacion (alerta roja) -->
<div th:if="${errorAutorizacion}" class="alert alert-danger">
    <i class="bi bi-shield-exclamation"></i>
    <strong>No autorizado</strong>
    <p th:text="${errorAutorizacion}"></p>
</div>

<!-- Error de validacion (bajo el campo) -->
<div class="text-danger" th:errors="*{codigoLote}"></div>
```

---

## 14. LOGGING

### 14.1 Prefijo CU

Todos los logs usan prefijo `[CU31]` o `[REVERSO-CU{n}]`

### 14.2 Puntos de Log

| Nivel | Punto | Mensaje |
|-------|-------|---------|
| INFO | Inicio | `[CU31] Iniciando reverso - Usuario: {}, Codigo: {}` |
| DEBUG | Validacion | `[CU31] Validando autorizacion - Mov: {}, Tipo: {}, Motivo: {}` |
| ERROR | No existe | `[CU31] Reverso fallido - Movimiento no existe: {}` |
| ERROR | Tipo null | `[CU31] Reverso fallido - Tipo de movimiento nulo` |
| ERROR | Multiples | `[CU31] Reverso fallido - Cantidad incorrecta: {}` |
| INFO | Exito | `[CU31] Reverso completado - Mov: {}, Lote: {}, Motivo: {}` |

---

## 15. MEJORAS SUGERIDAS

| Prioridad | Mejora | Estado |
|-----------|--------|--------|
| Media | Agregar tests para ReversoAuthorizationService | - |
| Media | Agregar tests para servicios delegados | - |
| Baja | Agregar contador de trazas restauradas en exito | - |
| Baja | Agregar confirmacion JavaScript antes de enviar | - |

---

## Apendice A: Movimientos Reversables

| CU | Tipo | Motivo | Servicio |
|----|------|--------|----------|
| CU1 | ALTA | COMPRA | ReversoAltaService |
| CU20 | ALTA | PRODUCCION_PROPIA | ReversoAltaService |
| CU24 | ALTA | DEVOLUCION_VENTA | ReversoAltaService |
| CU25 | ALTA | RETIRO_MERCADO | ReversoAltaService |
| CU3 | BAJA | MUESTREO | ReversoBajaService |
| CU4 | BAJA | DEVOLUCION_COMPRA | ReversoBajaService |
| CU7 | BAJA | CONSUMO_PRODUCCION | ReversoBajaService |
| CU23 | BAJA | VENTA | ReversoBajaService |
| CU30 | BAJA | AJUSTE | ReversoBajaService |
| CU2/8 | MODIF | ANALISIS | ReversoModificacionService |
| CU5/6 | MODIF | RESULTADO_ANALISIS | ReversoModificacionService |
| CU11 | MODIF | ANULACION_ANALISIS | ReversoModificacionService |
| CU22 | MODIF | LOTE_LIBERADO | ReversoModificacionService |
| CU21 | MODIF | TRAZADO | ReversoModificacionService |

## Apendice B: Movimientos NO Reversables

| CU | Motivo | Razon |
|----|--------|-------|
| CU9 | EXPIRACION_ANALISIS | Proceso automatico irreversible |
| CU10 | VENCIMIENTO | Proceso automatico irreversible |
| CU25 (MODIF) | RETIRO_MERCADO | Recall asociado bloquea reverso |

---

*Documento generado: 2025-12-14*
*Version: 2.0*
